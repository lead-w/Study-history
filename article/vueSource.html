<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue source | NorthUnicorn</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/Study-history/assets/css/0.styles.e2241fa8.css" as="style"><link rel="preload" href="/Study-history/assets/js/app.a1ad6491.js" as="script"><link rel="preload" href="/Study-history/assets/js/24.7933ac39.js" as="script"><link rel="prefetch" href="/Study-history/assets/js/10.7e604d29.js"><link rel="prefetch" href="/Study-history/assets/js/11.3067a7ca.js"><link rel="prefetch" href="/Study-history/assets/js/12.d1a6fe69.js"><link rel="prefetch" href="/Study-history/assets/js/13.4864be39.js"><link rel="prefetch" href="/Study-history/assets/js/14.30636de0.js"><link rel="prefetch" href="/Study-history/assets/js/15.2bcbbae8.js"><link rel="prefetch" href="/Study-history/assets/js/16.9d7f8d82.js"><link rel="prefetch" href="/Study-history/assets/js/17.0b328dfe.js"><link rel="prefetch" href="/Study-history/assets/js/18.f73ae9e0.js"><link rel="prefetch" href="/Study-history/assets/js/19.0e9a993e.js"><link rel="prefetch" href="/Study-history/assets/js/2.d8f505d4.js"><link rel="prefetch" href="/Study-history/assets/js/20.1a0bbb82.js"><link rel="prefetch" href="/Study-history/assets/js/21.23696e8c.js"><link rel="prefetch" href="/Study-history/assets/js/22.0c73380e.js"><link rel="prefetch" href="/Study-history/assets/js/23.c3ff09bc.js"><link rel="prefetch" href="/Study-history/assets/js/25.c8ae28e2.js"><link rel="prefetch" href="/Study-history/assets/js/26.3736bb12.js"><link rel="prefetch" href="/Study-history/assets/js/27.97f3f560.js"><link rel="prefetch" href="/Study-history/assets/js/28.fa4268d5.js"><link rel="prefetch" href="/Study-history/assets/js/29.50a00a75.js"><link rel="prefetch" href="/Study-history/assets/js/3.8796f9d7.js"><link rel="prefetch" href="/Study-history/assets/js/30.25371944.js"><link rel="prefetch" href="/Study-history/assets/js/31.b1b8fd04.js"><link rel="prefetch" href="/Study-history/assets/js/32.f534b2b4.js"><link rel="prefetch" href="/Study-history/assets/js/33.b9e3298a.js"><link rel="prefetch" href="/Study-history/assets/js/34.8ac7105e.js"><link rel="prefetch" href="/Study-history/assets/js/35.ba4dfc73.js"><link rel="prefetch" href="/Study-history/assets/js/36.ef19edf1.js"><link rel="prefetch" href="/Study-history/assets/js/37.0f9caf07.js"><link rel="prefetch" href="/Study-history/assets/js/38.2e4a8c9a.js"><link rel="prefetch" href="/Study-history/assets/js/39.46f87030.js"><link rel="prefetch" href="/Study-history/assets/js/4.c59777f9.js"><link rel="prefetch" href="/Study-history/assets/js/40.e1794eae.js"><link rel="prefetch" href="/Study-history/assets/js/41.5507fc07.js"><link rel="prefetch" href="/Study-history/assets/js/42.caa5814b.js"><link rel="prefetch" href="/Study-history/assets/js/43.6cd8bb3f.js"><link rel="prefetch" href="/Study-history/assets/js/44.2442f75f.js"><link rel="prefetch" href="/Study-history/assets/js/45.9648c0bd.js"><link rel="prefetch" href="/Study-history/assets/js/46.de6e3a74.js"><link rel="prefetch" href="/Study-history/assets/js/47.72c2c6ba.js"><link rel="prefetch" href="/Study-history/assets/js/48.d5004b5b.js"><link rel="prefetch" href="/Study-history/assets/js/49.a2d1d664.js"><link rel="prefetch" href="/Study-history/assets/js/5.9b395665.js"><link rel="prefetch" href="/Study-history/assets/js/50.19b7d6c9.js"><link rel="prefetch" href="/Study-history/assets/js/51.a9a0da08.js"><link rel="prefetch" href="/Study-history/assets/js/52.e99771cc.js"><link rel="prefetch" href="/Study-history/assets/js/53.74e55a43.js"><link rel="prefetch" href="/Study-history/assets/js/54.c4ff7ebc.js"><link rel="prefetch" href="/Study-history/assets/js/55.acadfba7.js"><link rel="prefetch" href="/Study-history/assets/js/56.8fa49260.js"><link rel="prefetch" href="/Study-history/assets/js/57.08f5f4e4.js"><link rel="prefetch" href="/Study-history/assets/js/58.9d13dd4c.js"><link rel="prefetch" href="/Study-history/assets/js/6.d5fd31a3.js"><link rel="prefetch" href="/Study-history/assets/js/7.ec2eb6b8.js"><link rel="prefetch" href="/Study-history/assets/js/8.91dd34c9.js"><link rel="prefetch" href="/Study-history/assets/js/9.814e5587.js">
    <link rel="stylesheet" href="/Study-history/assets/css/0.styles.e2241fa8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Study-history/" class="home-link router-link-active"><!----> <span class="site-name">NorthUnicorn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Study-history/front/" class="nav-link">front</a></div><div class="nav-item"><a href="/Study-history/houduan/" class="nav-link">back</a></div><div class="nav-item"><a href="/Study-history/devOps/" class="nav-link">devOps</a></div><div class="nav-item"><a href="/Study-history/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/Study-history/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/songge7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Study-history/front/" class="nav-link">front</a></div><div class="nav-item"><a href="/Study-history/houduan/" class="nav-link">back</a></div><div class="nav-item"><a href="/Study-history/devOps/" class="nav-link">devOps</a></div><div class="nav-item"><a href="/Study-history/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/Study-history/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/songge7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>article</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/webpack5.html" class="sidebar-link">webpack5 更新版本</a></li><li><a href="/Study-history/article/webpack.html" class="sidebar-link">webpack(基础)</a></li><li><a href="/Study-history/article/module.html" class="sidebar-link">module</a></li><li><a href="/Study-history/article/vueAnalysis.html" class="sidebar-link">vue</a></li><li><a href="/Study-history/article/vueN.html" class="sidebar-link">vue</a></li><li><a href="/Study-history/article/promise.html" class="sidebar-link">promise &amp;&amp; Event Loop</a></li><li><a href="/Study-history/article/frontModle.html" class="sidebar-link">发布订阅模式&amp;&amp;观察者模式</a></li><li><a href="/Study-history/article/vuePlugin.html" class="sidebar-link">vuePlugin</a></li><li><a href="/Study-history/article/jwtPrinciple.html" class="sidebar-link">jwt</a></li><li><a href="/Study-history/article/routerAuth.html" class="sidebar-link">routerAuth</a></li><li><a href="/Study-history/article/statusCode.html" class="sidebar-link">常用的状态码</a></li><li><a href="/Study-history/article/useLibrary.html" class="sidebar-link">常用库</a></li><li><a href="/Study-history/article/reg.html" class="sidebar-link">正则</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>vue</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/vueSource.html" class="active sidebar-link">vue source</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Study-history/article/vueSource.html#初次渲染-更新-mvvm" class="sidebar-link">初次渲染&amp;&amp;更新(MVVM)</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/vueSource.html#nexttick" class="sidebar-link">nextTick</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/vueSource.html#vue对象和数组劫持" class="sidebar-link">vue对象和数组劫持</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/vueSource.html#watch-原理" class="sidebar-link">watch 原理</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/vueSource.html#computed" class="sidebar-link">Computed</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/vueSource.html#dom" class="sidebar-link">DOM</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/vueSource.html#dom-diff" class="sidebar-link">DOM-diff</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/vueSource.html#vue-面试题" class="sidebar-link">vue 面试题</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/vueSource.html#vue汇总" class="sidebar-link">vue汇总</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>axios</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/axios.html" class="sidebar-link">axios</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>upload</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/upload.html" class="sidebar-link">upload</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>binary</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/binary.html" class="sidebar-link">二进制</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>http</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/http.html" class="sidebar-link">http</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="vue-source"><a href="#vue-source" aria-hidden="true" class="header-anchor">#</a> vue source</h1> <p></p><div class="table-of-contents"><ul><li><a href="#初次渲染-更新-mvvm">初次渲染&amp;&amp;更新(MVVM)</a><ul><li><a href="#new-vue操作">new vue操作</a></li><li><a href="#observer-观察1">Observer 观察1</a></li><li><a href="#watch">Watch</a></li><li><a href="#observer-观察2">Observer 观察2</a></li><li><a href="#watch-update-批量更新">Watch(update&amp;&amp;批量更新)</a></li></ul></li><li><a href="#nexttick">nextTick</a></li><li><a href="#vue对象和数组劫持">vue对象和数组劫持</a><ul><li><a href="#对象的劫持">对象的劫持</a></li><li><a href="#收集依赖">收集依赖</a></li><li><a href="#数组的劫持">数组的劫持</a></li></ul></li><li><a href="#watch-原理">watch 原理</a></li><li><a href="#computed">Computed</a></li><li><a href="#dom">DOM</a><ul><li><a href="#初次渲染">初次渲染</a></li></ul></li><li><a href="#dom-diff">DOM-diff</a><ul><li><a href="#比较新老元素-同级的情况">比较新老元素(同级的情况)</a></li><li><a href="#比较新老元素-有children的情况">比较新老元素(有children的情况)</a></li><li><a href="#正序">正序</a></li><li><a href="#倒序">倒序</a></li><li><a href="#乱序">乱序</a></li></ul></li><li><a href="#vue-面试题">vue 面试题</a><ul><li><a href="#_1、索引作为key的问题">1、索引作为key的问题</a></li><li><a href="#_2、mvvm">2、MVVM</a></li><li><a href="#_3、响应式数据的原理">3、响应式数据的原理</a></li><li><a href="#_4、什么样的数组会被观测">4、什么样的数组会被观测</a></li><li><a href="#_5、为何vue采用异步渲染">5、为何vue采用异步渲染</a></li><li><a href="#_6、nexttick-实现原理">6、nextTick 实现原理</a></li><li><a href="#_7、vue中computed的特点">7、Vue中Computed的特点</a></li><li><a href="#_8、watch的depp：true是如何实现的">8、Watch的depp：true是如何实现的</a></li><li><a href="#_9、生命周期">9、生命周期</a></li><li><a href="#_10、何时需要使用beforedestroy">10、何时需要使用beforeDestroy</a></li><li><a href="#_11、vue中模板编译原理">11、Vue中模板编译原理</a></li><li><a href="#_12、vue-中v-if和v-show的区别">12、Vue 中v-if和v-show的区别</a></li><li><a href="#_14、为什么v-for和v-if不能连用">14、为什么v-for和v-if不能连用</a></li><li><a href="#_15、diff算法的事件复杂度">15、diff算法的事件复杂度</a></li><li><a href="#_16、简述vue的diff算法原理">16、简述Vue的diff算法原理</a></li><li><a href="#_17、v-for-中为什么要用key">17、v-for 中为什么要用key</a></li><li><a href="#_18、描述组件渲染和更新的过程">18、描述组件渲染和更新的过程</a></li><li><a href="#_19、组件中的data为什么是一个函数，为什么new-vue-data-xx-这个不data不用返回函数">19、组件中的data为什么是一个函数，为什么new Vue({data:xx})这个不data不用返回函数</a></li><li><a href="#_20、vue中事件绑定的原理">20、Vue中事件绑定的原理</a></li><li><a href="#_21、v-model中的实现原理及如何自定义v-model">21、v-model中的实现原理及如何自定义v-model</a></li><li><a href="#sync-v-model">sync v-model</a></li><li><a href="#_22、vue中v-html会导致哪些问题？">22、vue中v-html会导致哪些问题？</a></li><li><a href="#_23、vue父子组件声明周期调用顺序">23、vue父子组件声明周期调用顺序</a></li><li><a href="#_24、vue组件如何通信">24、vue组件如何通信</a></li><li><a href="#_25、vue中相同逻辑如何抽离">25、vue中相同逻辑如何抽离</a></li><li><a href="#_26、为什么要使用异步组件">26、为什么要使用异步组件</a></li><li><a href="#_27、什么是作用域插槽">27、什么是作用域插槽</a></li><li><a href="#_28、谈谈你对keep-alive的了解">28、谈谈你对keep-alive的了解?</a></li><li><a href="#_29、编码优化">29、编码优化</a></li><li><a href="#_30、vue加载性能优化">30、vue加载性能优化</a></li><li><a href="#_31、优化">31、优化</a></li><li><a href="#_32、vue3">32、vue3</a></li><li><a href="#_33、实现hash路由和history路由">33、实现hash路由和history路由</a></li><li><a href="#_34、action-和-mutation的区别">34、action 和 mutation的区别</a></li><li><a href="#_35、组件自身循环">35、组件自身循环</a></li></ul></li><li><a href="#vue汇总">vue汇总</a><ul><li><a href="#组件注册">组件注册</a></li><li><a href="#计算属性">计算属性</a></li><li><a href="#绑定class-style">绑定class &amp;&amp; style</a></li><li><a href="#v-show-和-v-if">v-show 和 v-if</a></li><li><a href="#修饰符">修饰符</a></li><li><a href="#递归组件">递归组件</a></li><li><a href="#router">router</a></li></ul></li></ul></div><p></p> <h2 id="初次渲染-更新-mvvm"><a href="#初次渲染-更新-mvvm" aria-hidden="true" class="header-anchor">#</a> 初次渲染&amp;&amp;更新(MVVM)</h2> <img src="/Study-history/img/mvvm.png"> <h3 id="new-vue操作"><a href="#new-vue操作" aria-hidden="true" class="header-anchor">#</a> new vue操作</h3> <ul><li>Vue 本质是一个函数,在对象的原型上挂载了一堆方法</li> <li>在new Vue的时候,将传入的参数进行初始化,(<code>this.$options=options</code>全部挂载到当前实例的$options上)</li> <li>初始化的操作，分别处理data、computed、watch等(demo中只有这三)</li> <li>initData,vue内部的处理数据都放在this._data上,用户实际操作的data是通过<code>Object.defineProperty</code>把this._data映射到this.data上</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token punctuation">:</span><span class="token string">'#app'</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>msg<span class="token punctuation">:</span><span class="token string">'hello zf'</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 内部会调用此render方法 将render方法中的this 变成当前实例</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'hello'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 将用户插入的数据 通过object.defineProperty重新定义</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">data</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">:</span>data<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 会将对vm上的取值操作和赋值操作代理给vm._data 属性 因为vm._data里面的数据才是响应式的</span>
    <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span><span class="token string">'_data'</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 观察数据</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="observer-观察1"><a href="#observer-观察1" aria-hidden="true" class="header-anchor">#</a> Observer 观察1</h3> <ul><li>对数据(data里面的值)进行观察处理,遍历data内的每一个值。对每一个值,为他们创建一个<code>Dep</code>列表,(这个Dep就是观察者模式,他提供了订阅和通知的方法),都添加一个<code>get&amp;&amp;set</code>方法,<code>set</code>取值同时对dep进行通知,<code>get</code>取值对dep进行订阅(get操作是在获取值的时候处理的)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 定义响应式的数据变化</span>
<span class="token comment">// 不支持ie8 及ie8 以下的浏览器</span>
  <span class="token comment">// {school:{name:'xx'}} 监控的value下还可能有对象,需要深度观察 </span>
  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token comment">//递归观察</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//dep 里面可以收集依赖 收集的是watcher</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 只要对这个属性进行了取值操作,就会将当前的watcher存入进去</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 这次有值用的是渲染watcher</span>
        <span class="token comment">// 我们希望存入的watcher 不能重复 如果重复会造成更新时多次渲染</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 他让dep 中可以存watcher  我还虚妄让这个watcher中也存放dep,实现一个多对多的关系</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>childOb<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 数组的依赖收集  </span>
           childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数组也收集了当前渲染 watcher</span>
            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 收集儿子的依赖</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>newValue <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果你设置的值是一个对象的话 应该在进行监控这个新增的对象</span>
      value <span class="token operator">=</span> newValue
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="watch"><a href="#watch" aria-hidden="true" class="header-anchor">#</a> Watch</h3> <ul><li>前面初始赋值等操作完成后,就是<code>$mount</code>挂载数据,会创建一个 一个Watch(vm,渲染函数)</li> <li>Watch接收4个参数<code>(vm,exprOrFn,cb,opts)</code>,exprOrFn可能是一个表达式(在Computed和Watcher方法的时候传入的是表达式要去对应的data),也有可能是一个函数(渲染函数),在实例化<code>Watch</code>的时候会调用自身的get方法,get方法主要做了3件事
<ul><li>1、在dep列表中 把当前的watch实例注入到Dep中<code>Dep.target</code>上</li> <li>2、执行传入的<code>exprOrFn</code>函数(<code>传入this.vm</code>),进行更新</li> <li>3、在dep列表中 把当前最近的watch删除,去最新的一个</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">/**
   * 
   * @param {*} vm 当前组件的实例 new Vue
   * @param {*} exprOrFn  用户可能传入的是一个表达式 也有可能传入的是一个函数
   * @param {*} cb  用户传入的回调函数 vm.$watch('msg',cb)
   * @param {*} opts 一些其他参数
   */</span>
  <span class="token comment">// vm msg (newValue,oldValue)=&gt;{} {user:true}</span>
  <span class="token comment">// vm ()=&gt;this.fullName+this.lastName ()=&gt;{} lazy:true</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>exprOrFn<span class="token punctuation">,</span><span class="token function-variable function">cb</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>opts<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>exprOrFn <span class="token operator">=</span> exprOrFn
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> exprOrFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> exprOrFn<span class="token punctuation">;</span> <span class="token comment">// getter就是new Watcher传入的第二个函数</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">// 处理watch 获取到方法</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 调用此方法 会将vm上对应的表达式取出来</span>
        <span class="token keyword">return</span> util<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>exprOrFn<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 标识是用户自己写的watch</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> opts<span class="token punctuation">.</span>lazy<span class="token punctuation">;</span> <span class="token comment">// 为true 说明他是计算属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depsId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>opts <span class="token operator">=</span> opts
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token operator">++</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>immediate <span class="token operator">=</span> opts<span class="token punctuation">.</span>immediate
    <span class="token comment">// 创建watcher的时候  先将表达式对应 值取出来(老值)</span>
    <span class="token comment">// 如果当前我们是计算属性的话 不会默认调用get方法</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//默认创建一个watcher 会调用自身的get方法</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>immediate<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 如果有immediate 就直接运行用户定义的函数</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="observer-观察2"><a href="#observer-观察2" aria-hidden="true" class="header-anchor">#</a> Observer 观察2</h3> <ul><li>页面进行更新取值的时候,会触发<code>get</code>方法,此时调用dep的订阅,将Watch存到dep的列表中(<code>#这里就是Watch订阅#</code>)。同时将dep保存到当前的Watch中(此操作在watch时候用的到)</li> <li>重新赋值的时候,会触发<code>set</code>方法,他会通知dep,遍历之前保存的<code>watcher</code>,调用watcher的update方法(<code>#Dep回调watch#</code>)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 订阅 就是将调用addSub时传入的内容保存到数组中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token operator">=&gt;</span>watcher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 为了防止直接调用depend方法 先判断一下</span>
      <span class="token comment">// Dep.target是一個渲染watcher</span>
      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token comment">//希望可以在 watcher 中互相记忆</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 同一个watcher 不应该重复记录dep</span>
    <span class="token keyword">let</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id<span class="token punctuation">;</span> <span class="token comment">// msg 的dep</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depsId<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>depsId<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 就让watcher 记住了当前的dep</span>
      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="watch-update-批量更新"><a href="#watch-update-批量更新" aria-hidden="true" class="header-anchor">#</a> Watch(update&amp;&amp;批量更新)</h3> <ul><li>Watch 内部有一个update方法</li> <li>每次调用update方法的时候,他会过滤相同的watch,将所有要更新的watch,保存起来</li> <li>通过<code>nextTick</code>异步更新所有的watch,watch遍历的时候,重新执行exprOrFn更新视图(<code>#watch更新view#</code>),同时将cb回调执行(创建watch的时候传入的)将新老值传入</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 如果立即调用get 会导致页面刷新  需要异步来更新</span>
    <span class="token comment">// vue的特点就是批量更新</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 如果是计算属性值变化了 稍后取值时重新计算</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span> 
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> newValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//新值</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldValue <span class="token operator">!==</span> newValue<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> has <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">function</span> <span class="token function">flushQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      queue<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">watcher</span> <span class="token operator">=&gt;</span> watcher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      has <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 恢复正常 下一轮继续更新使用 </span>
      queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 对重复的watcher过滤操作</span>
    <span class="token keyword">let</span> id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id
    <span class="token keyword">if</span><span class="token punctuation">(</span>has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//相同的watcher 他只会存一个到queue中 </span>
      <span class="token comment">// 延迟情况队列</span>
      <span class="token function">nextTick</span><span class="token punctuation">(</span>flushQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="nexttick"><a href="#nexttick" aria-hidden="true" class="header-anchor">#</a> nextTick</h2> <ul><li>原理就是 浏览器 是否支持微任务 支持就用 不支持就用宏任务</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
  <span class="token comment">// 要异步刷新这个callbacks 获取一个异步的方法</span>
  <span class="token comment">// 异步是分执行顺序的 会先执行promise mutationObserver setImmediate setTimeout</span>
  <span class="token keyword">let</span> <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">flushCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Promise<span class="token punctuation">)</span><span class="token punctuation">{</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>timerFunc<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// h5的api</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>MutationObserver<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> observe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>timerFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> textNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    observe<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>textNode<span class="token punctuation">,</span><span class="token punctuation">{</span>characterData<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    textNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">return</span>  
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>setImmediate<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span>timerFunc<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>timerFunc<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="vue对象和数组劫持"><a href="#vue对象和数组劫持" aria-hidden="true" class="header-anchor">#</a> vue对象和数组劫持</h2> <h3 id="对象的劫持"><a href="#对象的劫持" aria-hidden="true" class="header-anchor">#</a> 对象的劫持</h3> <ul><li>在data初始化的时候,所有的数据都会放到vm._data上,用户在访问this上的属性时候都是通过代理访问到vm._data。</li> <li>内部在观察数据的时候是对vm._data,而不是用户定义的data</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>source<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 代理数据 vm.msg = vm._data.msg</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> vm<span class="token punctuation">[</span>source<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>  
    <span class="token keyword">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">{</span>
      vm<span class="token punctuation">[</span>source<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 将用户插入的数据 通过object.defineProperty重新定义</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">data</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">:</span>data<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 会将对vm上的取值操作和赋值操作代理给vm._data 属性 因为vm._data里面的数据才是响应式的</span>
    <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span><span class="token string">'_data'</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 观察数据</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="收集依赖"><a href="#收集依赖" aria-hidden="true" class="header-anchor">#</a> 收集依赖</h3> <ul><li>在observer(观察中)触发get取值的时候,进行依赖收集</li> <li>使用Dep类来收集依赖，收集一个个watcher，需要更新时再把watcher全部执行</li> <li>1、首先 递归观察data<code>observe(value)</code> 当他不是对象或者是null的时候就直接返回,否则就创建data对象</li> <li>2、取值触发get的时候,如果<code>observe(value)</code>返回的是值存在,那么创建一个dep并且调用dep.depend收集当前的watch,<code>dependArray(value)</code>收数组集儿子的依赖</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> data <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token comment">// 不是对象或者是null 我就不用执行后续逻辑了</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 已经被监控过了</span>
      <span class="token keyword">return</span> data<span class="token punctuation">.</span>__ob__
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 定义响应式的数据变化</span>
    <span class="token comment">// 不支持ie8 及ie8 以下的浏览器</span>
    <span class="token comment">// {school:{name:'xx'}} 监控的value下还可能有对象,需要深度观察 </span>
    <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token comment">//递归观察</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//dep 里面可以收集依赖 收集的是watcher</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
      <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 只要对这个属性进行了取值操作,就会将当前的watcher存入进去</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 这次有值用的是渲染watcher</span>
          <span class="token comment">// 我们希望存入的watcher 不能重复 如果重复会造成更新时多次渲染</span>
          dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 他让dep 中可以存watcher  我还虚妄让这个watcher中也存放dep,实现一个多对多的关系</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>childOb<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 数组的依赖收集  </span>
            childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数组也收集了当前渲染 watcher</span>
              <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 收集儿子的依赖</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>newValue <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果你设置的值是一个对象的话 应该在进行监控这个新增的对象</span>
        value <span class="token operator">=</span> newValue
        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 递归收集儿子依赖</span>
  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">dependArray</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 递归收集数组中的依赖</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> currentItem <span class="token operator">=</span> value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 有可能也是一个数组</span>
      currentItem<span class="token punctuation">.</span>__ob__<span class="token operator">&amp;&amp;</span>currentItem<span class="token punctuation">.</span>__ob__<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>currentItem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">dependArray</span><span class="token punctuation">(</span>currentItem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 不停的收集 数组中的依赖关系</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="数组的劫持"><a href="#数组的劫持" aria-hidden="true" class="header-anchor">#</a> 数组的劫持</h3> <ul><li>Object.defineProperty 的set方法无法观察到数组的变化,需要对原生的数组方法进行劫持</li> <li>在观察data的时候 就需要对array进行单独处理,
<ul><li>1、创建一个dep观察者模式</li> <li>2、给data定义'<strong>ob</strong>'变量 指向的是当前的this</li> <li>3、如果data是数组那么拦截数组的方法<code>data.__proto__ = arrayMethods</code></li> <li>4、之前收集依赖的时候都往dep中注入了依赖所以array方式执行完成后 dep.notify 执行watch</li> <li>主要拦截用户调用 push shift unshift pop reverse sort splice 他们会改变原有数组</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Observer</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 每个对象 包括数组都有一个__ob__ 属性 返回的是当前的observer实例 </span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token string">'__ob__'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
      <span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 重写push等方法</span>
      <span class="token comment">// 只能拦截数组的方法 数组里的每一项 还需要去观测一下</span>
      data<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrayMethods
      <span class="token comment">// 当调用数组的方法时 手动通知</span>
      <span class="token function">observerArrary</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// arrayMethods</span>
<span class="token keyword">let</span>  oldArrayProtoMethods <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>oldArrayProtoMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  arrayMethods<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 函数劫持 切片编程</span>
    <span class="token keyword">let</span> r <span class="token operator">=</span> oldArrayProtoMethods<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span>
    <span class="token keyword">let</span> inserted<span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token punctuation">:</span>
        <span class="token comment">// xxxxxxxxxxxx</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token punctuation">:</span>
        <span class="token comment">// xxxxxxxxxxxx</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token punctuation">:</span>
        <span class="token comment">// xxxxxxxxxxxxxxxx</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">observerArrary</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 数组方法操作的时候 通知视图更新 </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> r     
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="watch-原理"><a href="#watch-原理" aria-hidden="true" class="header-anchor">#</a> watch 原理</h2> <ul><li>watch用法 最终还是调用了<code>this.$watch</code></li> <li>$watch 原理也是内部创建了一个<code>Watcher</code>参数上面有详细说明,将watch放入到dep列表中</li> <li>在Watch中 如果<code>expr</code>是一个表达式 他会获取对应的函数,第三个参数<code>handler</code>,就是Watch更新完成后的回调,他会传入新老值,此逻辑和批量更新雷同</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 遍历 watch 的属性调用vm.$watch</span>
<span class="token keyword">function</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>key<span class="token punctuation">,</span>handler<span class="token punctuation">,</span>opts</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 内部最终也会使用$watch方法</span>
  <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>handler<span class="token punctuation">,</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">initWatch</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> watch <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>watch<span class="token punctuation">;</span><span class="token comment">// 获取用户传入的watch属性</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> watch<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//msg:(){},msg:[(){},(){}] 可能是对象 可能是数组</span>
    <span class="token keyword">let</span> userDef <span class="token operator">=</span> watch<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> handler <span class="token operator">=</span> userDef
    <span class="token keyword">if</span><span class="token punctuation">(</span>userDef<span class="token punctuation">.</span>handler<span class="token punctuation">)</span><span class="token punctuation">{</span>
      handler <span class="token operator">=</span> userDef<span class="token punctuation">.</span>handler
    <span class="token punctuation">}</span>
    <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>key<span class="token punctuation">,</span>handler<span class="token punctuation">,</span><span class="token punctuation">{</span>immediate<span class="token punctuation">:</span>userDef<span class="token punctuation">.</span>immediate<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$watch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">expr<span class="token punctuation">,</span>handler<span class="token punctuation">,</span>opts</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>expr<span class="token punctuation">,</span>handler<span class="token punctuation">,</span><span class="token punctuation">{</span>user<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token operator">...</span>opts<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用户自己定义的watch</span>
<span class="token punctuation">}</span>
<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> newValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//新值</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldValue <span class="token operator">!==</span> newValue<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldValue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="computed"><a href="#computed" aria-hidden="true" class="header-anchor">#</a> Computed</h2> <ul><li>computed原理也是依赖<code>Watch</code>,遍历computed,对每个函数都创建一个Watcher,第一个参数是vm,第二个是要执行的computed单个函数,第三个没用,第四个是computed独有的标识<code>{lazy:true}</code></li> <li>watcher默认会执行get,但是Computed创建的Watch不会默认执行get(get就是执行exprOrFn)</li> <li>computed同样用了代理,每次key访问的是代理的一个函数,返回的也是一个可以执行的函数</li> <li>页面渲染的时候 会执行个函数</li> <li>Computed 初次渲染当<code>dirty</code>为true的时候<code>watcher.evaluate</code>，会调用watch里面的get方法,执行exprOrFn函数返回并且将<code>{dirty:false}</code>(已经取值过),显示在页面上</li> <li>Computed 更新渲染 在Watch.update中判断,如果<code>this.lazy</code>为true就修改<code>{dirty:true}</code>,表示可以取值,不会通知页面刷新
<ul><li>第一次 执行<code>fullName</code>的时候 <code>firstName</code>和<code>lastName</code>取值的时候会在watch中保存他们deps</li> <li>在 Computed函数值 变化的时候,他会调用<code>watcher.depend</code>,获取之前保存的<code>firstName</code>和<code>lastName</code>deps,遍历执行他们的依赖,此时会将渲染watcher放入来dep列表中,当<code>firstName</code>或者<code>lastName</code>发生变化的时候 会先走自己的计算watcher在走渲染watcher进行更新</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  Computed 以他为例</span>
  computed<span class="token punctuation">:</span><span class="token punctuation">{</span>
    <span class="token function">fullNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstName<span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastName
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createComputedGetter</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> watcher <span class="token operator">=</span> vm<span class="token punctuation">.</span>_watchersComputed<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 这个watcher 就是我们定义的计算属性watcher</span>
  <span class="token comment">// 用户取值是会执行此方法</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 初次渲染</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 如果页面取值 而且dirty是true 就会去调用watcher的get方法</span>
        watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 更新渲染</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// watcher 就是计算属性的watcher dep = [firstName.dep,lastName.Dep]</span>
        watcher<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> watcher<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// dirty:false 表示值求过了</span>
<span class="token punctuation">}</span>
<span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span>a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 同一个watcher 不应该重复记录dep</span>
  <span class="token keyword">let</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id<span class="token punctuation">;</span> <span class="token comment">// msg 的dep</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depsId<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depsId<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 就让watcher 记住了当前的dep</span>
    dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">initComputed</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>computed</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 将计算属性的配置 放到vm上</span>
  <span class="token keyword">let</span> watchers <span class="token operator">=</span> vm<span class="token punctuation">.</span>_watchersComputed <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建存储计算属性的watcher的对象</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> computed<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// {fullName:()=&gt;{this.firstName+lastName}}</span>
    <span class="token keyword">let</span> userDef <span class="token operator">=</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token comment">// new Watcher此时什么都不会做 配置了lazy dirt </span>
    watchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>userDef<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>lazy<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">// lazy 表示计算属性 watcher 默认刚开始这个方法不会执行</span>
    <span class="token comment">// vm.fullName</span>
    <span class="token comment">//将这个属性 定义到vm上</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
      <span class="token keyword">get</span><span class="token punctuation">:</span><span class="token function">createComputedGetter</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 更新操作</span>
 <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 更新的时候 如果lazy</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 如果是计算属性值变化了 稍后取值时重新计算</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span> 
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="dom"><a href="#dom" aria-hidden="true" class="header-anchor">#</a> DOM</h2> <h3 id="初次渲染"><a href="#初次渲染" aria-hidden="true" class="header-anchor">#</a> 初次渲染</h3> <ul><li>h 是处理jsx语法(与react 的createElement一样) 处理好的参数交给<code>vnode</code>创建虚拟节点</li> <li>vnode也叫虚拟节点 就是一个对象保存了一堆属性,参数vnode(tag,props,key,children)</li> <li>createElm 创建真是节点,接收的参数就是vnode
<ul><li>updateProperties(vnode,oldProps={}) 就是 更新属性,当oldProps传入就是新老属性对比,只有vnode参数的时候就给属性赋值</li> <li>当child是对象的时候就,递归调用render进行渲染,当child是文本的时候 就直接创建文本节点,最后返回vnode.el,插入到页面中</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>h<span class="token punctuation">,</span>render<span class="token punctuation">,</span>patch<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vnode/index'</span>
<span class="token keyword">let</span> oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token string">'container'</span><span class="token punctuation">,</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'yellow'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'pink'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'d'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span>
<span class="token function">render</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span>container<span class="token punctuation">)</span>
<span class="token comment">// h函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span>props<span class="token punctuation">,</span><span class="token operator">...</span>children</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> key <span class="token operator">=</span> props<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token keyword">delete</span> props<span class="token punctuation">.</span>key<span class="token punctuation">;</span><span class="token comment">// 属性中不包括key属性</span>
  children <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> child
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span><span class="token keyword">undefined</span><span class="token punctuation">,</span><span class="token keyword">undefined</span><span class="token punctuation">,</span><span class="token keyword">undefined</span><span class="token punctuation">,</span>child<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span>props<span class="token punctuation">,</span>key<span class="token punctuation">,</span>children<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 虚拟节点</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span>props<span class="token punctuation">,</span>key<span class="token punctuation">,</span>children<span class="token punctuation">,</span>text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    tag<span class="token punctuation">,</span>  <span class="token comment">// 表示当前标签名</span>
    props<span class="token punctuation">,</span><span class="token comment">// 表示当前标签上的属性</span>
    key<span class="token punctuation">,</span>   <span class="token comment">// 唯一表示用户可能传递</span>
    children<span class="token punctuation">,</span>
    text
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建真实节点</span>
<span class="token keyword">function</span> <span class="token function">createElm</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>tag<span class="token punctuation">,</span>children<span class="token punctuation">,</span>key<span class="token punctuation">,</span>props<span class="token punctuation">,</span>text<span class="token punctuation">}</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 标签  一个虚拟节点 对应着他的真实节点  主要是做一个映射关系</span>
      vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">updateProperties</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// child是虚拟节点</span>
          <span class="token keyword">return</span> <span class="token function">render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span>vnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 递归渲染当前孩子列表</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">// 文本</span>
      vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>el
<span class="token punctuation">}</span>
</code></pre></div><h2 id="dom-diff"><a href="#dom-diff" aria-hidden="true" class="header-anchor">#</a> DOM-diff</h2> <ul><li>在更新的时候 会做DOM-diff比较</li> <li><code>patch</code>方法就是核心的比较方法</li></ul> <h3 id="比较新老元素-同级的情况"><a href="#比较新老元素-同级的情况" aria-hidden="true" class="header-anchor">#</a> 比较新老元素(同级的情况)</h3> <ul><li>1、当标签不一样的时候直接替换</li> <li>2、当只有文本的的时候 不一样就直接替换</li> <li>3、标签一样属性不一样 直接比较新老属性值</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span>newVnode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 1) 先比对 标签一样不一样 </span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag <span class="token operator">!==</span> newVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 以前是div 现在是p标签</span>
      <span class="token comment">// 必须拿到当前元素的父亲 才能替换掉自己</span>
      oldVnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span><span class="token function">createElm</span><span class="token punctuation">(</span>newVnode<span class="token punctuation">)</span><span class="token punctuation">,</span>oldVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 2) 比较文本了 标签一样 可能都是undefined</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> newVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 如果内容不一致直接根据当前新的元素中的内容来替换到文本节点</span>
          oldVnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newVnode<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 标签一样 可能属性不一样了</span>
  <span class="token keyword">let</span> el <span class="token operator">=</span> newVnode<span class="token punctuation">.</span>el <span class="token operator">=</span>  oldVnode<span class="token punctuation">.</span>el<span class="token punctuation">;</span> <span class="token comment">// 标签一样复用即可</span>
  <span class="token function">updateProperties</span><span class="token punctuation">(</span>newVnode<span class="token punctuation">,</span>oldVnode<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 做属性的比对</span>

  <span class="token comment">// 必须要有一个根节点</span>
  <span class="token comment">// 比较孩子 </span>
  <span class="token keyword">let</span> oldChildren <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newChildren <span class="token operator">=</span> newVnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// 老的有孩子 新的有孩子 updateChildren</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">updateChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>oldChildren<span class="token punctuation">,</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不停的递归比较</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 老的有孩子 新的没孩子 </span>
      el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 老的没孩子 新的有孩子</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length <span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">let</span> child <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createElm</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将当前新的儿子 丢到老的节点中即可</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> el<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isSameVnode</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span>newVnode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 如果两个人的标签和key 一样我认为是同一个节点 虚拟节点一样我就可以复用真实节点了</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> newVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 比较儿子</span>
<span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span>oldChildren<span class="token punctuation">,</span>newChildren</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// vue增加了很多优化策略 因为在浏览器中操作dom最常见的方法是 开头或者结尾插入</span>
  <span class="token comment">// 涉及到正序和倒序</span>
  <span class="token keyword">let</span> oldStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 老的索引开始</span>
  <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 老的节点开始</span>
  <span class="token keyword">let</span> oldEndIndex <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>


  <span class="token keyword">let</span> newStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 新的索引开始</span>
  <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 新的节点开始</span>
  <span class="token keyword">let</span> newEndIndex <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">makeIndexByKey</span><span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          map<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> index
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> map<span class="token punctuation">;</span> <span class="token comment">// {a:0,b:1...}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token function">makeIndexByKey</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>oldStartIndex<span class="token operator">&lt;=</span>oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 向后插入元素</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">{</span>
          oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">{</span>
          oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 先开前面是否一样</span>
          <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 用新的属性来更新老的属性,而且还要递归比较儿子</span>
          oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
          newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span>
      <span class="token comment">// 当前向前插入</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span>newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 从后面比较看是否一样</span>
          <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span>newEndVnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 比较孩子 </span>
          oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
          newEndVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 倒叙功能 abcd  dcba</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span>newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span>newEndVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
          parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>oldEndVnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
          oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
          newEndVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIndex<span class="token punctuation">]</span>
          <span class="token comment">// 这个是比对将尾部插入到了前面</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
          parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
          oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
          newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 会先拿新节点的第一项 去老节点中匹配，如果匹配不到直接将这个节点插入到老节点开头的前面，如果能查找到则直接移动老节点</span>
          <span class="token comment">// 可能老节点中还有剩余 则直接删除老节点中剩余的属性</span>
          <span class="token keyword">let</span> moveIndex <span class="token operator">=</span> map<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>moveIndex <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">,</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
              <span class="token comment">// 我要移动这个元素</span>
              <span class="token keyword">let</span> moveVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>moveIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
              oldChildren<span class="token punctuation">[</span>moveIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
              parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>moveVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">patch</span><span class="token punctuation">(</span>moveVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 要将新节点的指针向后移动</span>
          newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> 
      <span class="token comment">// 老的尾巴和新的头去比 将老的尾巴移动到老的头的前面</span>
      <span class="token comment">// 还有一种情况 </span>
      <span class="token comment">// 倒叙和正序</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>newStartIndex<span class="token operator">&lt;=</span>newEndIndex<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 如果到最后还剩余 需要将剩余的插入</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIndex <span class="token punctuation">;</span> i <span class="token operator">&lt;=</span>newEndIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 要插入的元素</span>
          <span class="token keyword">let</span> ele <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEndIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span> <span class="token keyword">null</span><span class="token punctuation">:</span>newChildren<span class="token punctuation">[</span>newEndIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">;</span>
          parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token function">createElm</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 可能是往前面插入  也有可能是往后面插入</span>
          <span class="token comment">// insertBefore(插入的元素,null) = appendChild</span>
          <span class="token comment">// parent.appendChild(createElm(newChildren[i]))</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> oldStartIndex<span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>oldEndIndex<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">let</span> child <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>child <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 循环的是 尽量不要使用索引作为key 可能会导致重新创建当前元素的所有子元素</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="比较新老元素-有children的情况"><a href="#比较新老元素-有children的情况" aria-hidden="true" class="header-anchor">#</a> 比较新老元素(有children的情况)</h3> <ul><li>老的有孩子 新的没有
<ul><li>删掉就可以了</li></ul></li> <li>老的没有孩子 新的有孩子
<ul><li>将当前新的儿子 丢到老节点中即可</li></ul></li> <li>老的有孩子 新的有孩子
<ul><li>开头或者结尾插入，正序和倒序,乱序</li></ul></li></ul> <h4 id="开头插入"><a href="#开头插入" aria-hidden="true" class="header-anchor">#</a> 开头插入</h4> <ul><li>从新老节点的开头 一一比较</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token string">'container'</span><span class="token punctuation">,</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'yellow'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'pink'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'d'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> newVode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'yellow'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'pink'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'e'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 开头比较</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 先看前面是否一样</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 用新的属性来更新老的属性,而且还要递归比较儿子</span>
    oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// 插入</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>newStartIndex<span class="token operator">&lt;=</span>newEndIndex<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 如果到最后还剩余 需要将剩余的插入</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIndex <span class="token punctuation">;</span> i <span class="token operator">&lt;=</span>newEndIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">let</span> ele <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEndIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span> <span class="token keyword">null</span><span class="token punctuation">:</span>newChildren<span class="token punctuation">[</span>newEndIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">;</span>
          parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token function">createElm</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="结尾插入"><a href="#结尾插入" aria-hidden="true" class="header-anchor">#</a> 结尾插入</h4> <ul><li>从新老节点的尾巴 一一比较</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token string">'container'</span><span class="token punctuation">,</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'yellow'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'pink'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'d'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> newVode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'pink'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'e'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'yellow'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token punctuation">:</span><span class="token punctuation">{</span>background<span class="token punctuation">:</span><span class="token string">'pink'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'d'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结尾比较</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span>newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 从后面比较看是否一样</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span>newEndVnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 比较孩子 </span>
      oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newEndVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
<span class="token comment">// 插入</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>newStartIndex<span class="token operator">&lt;=</span>newEndIndex<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 如果到最后还剩余 需要将剩余的插入</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIndex <span class="token punctuation">;</span> i <span class="token operator">&lt;=</span>newEndIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">let</span> ele <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEndIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span> <span class="token keyword">null</span><span class="token punctuation">:</span>newChildren<span class="token punctuation">[</span>newEndIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">;</span>
          parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token function">createElm</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>       
</code></pre></div><h3 id="正序"><a href="#正序" aria-hidden="true" class="header-anchor">#</a> 正序</h3> <ul><li>新的 abcd 老的dcba 用新的头和老的尾巴开始比较</li> <li>这里需要插入 将老节点的头往后面老节点尾巴一步步插入</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span>newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span>newEndVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 移动</span>
      parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>oldEndVnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newEndVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIndex<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="倒序"><a href="#倒序" aria-hidden="true" class="header-anchor">#</a> 倒序</h3> <ul><li>新的 abcd 老的dabc 用新的尾巴和老的头开始比较</li> <li>同样需要插入操作 将老的尾往前面一步步插入</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="乱序"><a href="#乱序" aria-hidden="true" class="header-anchor">#</a> 乱序</h3> <ul><li>会先拿新节点的第一项 去老节点中匹配，如果匹配不到直接将这个节点插入到老节点开头的前面，如果能查找到则直接移动老节点</li> <li>可能老节点中还有剩余 则直接删除老节点中剩余的属性</li> <li>老节点会做一个映射表,用新节点的key去匹配,没有找到就将新元素添加到老元素的前面。找到就移动他,就将这个移动节点移动到老节点的前面,移动后的元素给undefined做补位</li> <li>最后 当老指针小于老的尾指针就删掉剩余的</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeIndexByKey</span><span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          map<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> index
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> map<span class="token punctuation">;</span> <span class="token comment">// {a:0,b:1...}</span>
  <span class="token punctuation">}</span>
<span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token function">makeIndexByKey</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 乱序</span>
<span class="token keyword">let</span> moveIndex <span class="token operator">=</span> map<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>moveIndex <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">,</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment">// 我要移动这个元素</span>
    <span class="token keyword">let</span> moveVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>moveIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    oldChildren<span class="token punctuation">[</span>moveIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>moveVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>moveVnode<span class="token punctuation">,</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 要将新节点的指针向后移动</span>
newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span>


<span class="token comment">// 如果移动的时候遇到 undefined 就跳过</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">{</span>
    oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">{</span>
    oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="vue-面试题"><a href="#vue-面试题" aria-hidden="true" class="header-anchor">#</a> vue 面试题</h2> <h3 id="_1、索引作为key的问题"><a href="#_1、索引作为key的问题" aria-hidden="true" class="header-anchor">#</a> 1、索引作为key的问题</h3> <ul><li>比如倒序的情况a1b1c1d1变成d2c2b2a2，最佳情况是abc移动三次即可完成更新。如果使用索引(索引是0的时候对应的是a1和d2,发现东西不一样就重新创建),abcd四个位置不变，但内容全部要更新，渲染四次（创建新节点并替换）。移动三次比渲染四次性能高太多。</li></ul> <h3 id="_2、mvvm"><a href="#_2、mvvm" aria-hidden="true" class="header-anchor">#</a> 2、MVVM</h3> <ul><li>上面有</li></ul> <h3 id="_3、响应式数据的原理"><a href="#_3、响应式数据的原理" aria-hidden="true" class="header-anchor">#</a> 3、响应式数据的原理</h3> <ul><li>核心点：Object.defineProperty</li> <li>默认Vue在初始化数据时,会给data中的属性使用Object.defineProperty 重新定义所在属性,当页获取对应属性时.会进行依赖收集(收集当前组件的Watcher) 如果属性发生变化会通知相关依赖进行更新操作</li></ul> <h3 id="_4、什么样的数组会被观测"><a href="#_4、什么样的数组会被观测" aria-hidden="true" class="header-anchor">#</a> 4、什么样的数组会被观测</h3> <ul><li>不能的情况(数据劫持的2个缺点)
<ul><li>[0,1,2] observe 观测到数组的索引值 会直接返回  不能直接改变索引 不能被检查到</li> <li>[1,2,3].length 也是不能观测到的 没有监控</li></ul></li> <li>能
<ul><li>[{a:1}] 内部会对数组里的对象进行监控</li> <li>[].push /shift unshfit 这些方法可以被监控 vm.$set 内部就是调用的数组的splice方法</li></ul></li></ul> <h3 id="_5、为何vue采用异步渲染"><a href="#_5、为何vue采用异步渲染" aria-hidden="true" class="header-anchor">#</a> 5、为何vue采用异步渲染</h3> <ul><li>vue是组件级更新</li> <li>因为如果不采用异步更新，那么每次更新数据都会对当前组件重新渲染,所以为了性能考虑,vue会在本轮数据更新后,再去异步更新视图</li></ul> <h3 id="_6、nexttick-实现原理"><a href="#_6、nexttick-实现原理" aria-hidden="true" class="header-anchor">#</a> 6、nextTick 实现原理</h3> <ul><li>上面有</li></ul> <h3 id="_7、vue中computed的特点"><a href="#_7、vue中computed的特点" aria-hidden="true" class="header-anchor">#</a> 7、Vue中Computed的特点</h3> <ul><li>默认computed也是一个watcher是具备缓存的,只要当依赖的属性发生变化时才会更新视图</li></ul> <h3 id="_8、watch的depp：true是如何实现的"><a href="#_8、watch的depp：true是如何实现的" aria-hidden="true" class="header-anchor">#</a> 8、Watch的depp：true是如何实现的</h3> <ul><li>当用户指定了watch的deep属性为true时,如果当前监控的值是数组类型。会对对象中的每一项进行求值,此时会将当前watcher存入到对应的属性依赖中,这样数组中对对象发生变化也会通知数据更新</li></ul> <h3 id="_9、生命周期"><a href="#_9、生命周期" aria-hidden="true" class="header-anchor">#</a> 9、生命周期</h3> <ul><li>创建前后、载入前后、更新前后、销毁前后</li> <li>beforeCreate在实例初始化之后 数据观测(data observer)之前被调用</li> <li>created 实例已经创建完成 因为他是最早触发的原因可以进行一些数据,资源请求。</li> <li>beforeMount 在挂载开始之前被调用:相关的render函数首次被调用</li> <li>mounted 实例已经挂载完成 可以进行一些DOM操作</li> <li>beforeUpdate 可以在这个钩子中进一步地更改状态,这不会触发附加的重新渲染过程</li> <li>updated 可以执行依赖于DOM的操作 然而在大多数情况下,你应该避免在此期间更改状态,因为这可能会导致更新无线循环,该钩子在服务器端渲染不能被调用</li> <li>beforeDestroy</li> <li>destroyed 可执行一些优化操作,清解绑定事件</li></ul> <h3 id="_10、何时需要使用beforedestroy"><a href="#_10、何时需要使用beforedestroy" aria-hidden="true" class="header-anchor">#</a> 10、何时需要使用beforeDestroy</h3> <ul><li>可能在当前页面中使用了$on方法,那需要在组件销毁前解绑</li> <li>清除自定义的定时器</li> <li>接触事件的绑定 scroll mousemove..........</li></ul> <h3 id="_11、vue中模板编译原理"><a href="#_11、vue中模板编译原理" aria-hidden="true" class="header-anchor">#</a> 11、Vue中模板编译原理</h3> <ul><li>将template模板转化成render函数
<ul><li>1、将模板转换成ast树(虚拟dom)</li> <li>2、优化树</li> <li>3、将ast树生成代码</li></ul></li></ul> <h3 id="_12、vue-中v-if和v-show的区别"><a href="#_12、vue-中v-if和v-show的区别" aria-hidden="true" class="header-anchor">#</a> 12、Vue 中v-if和v-show的区别</h3> <ul><li>实现方式
<ul><li>v-if是根据后面数据的真假值判断直接从Dom树上删除或重建元素节点</li> <li>v-show只是在修改元素的css样式，也就是display的属性值，元素始终在Dom树上</li></ul></li> <li>编译条件
<ul><li>v-if是惰性的，如果初始条件为假，则什么也不做；只有在条件第一次变为真时才开始局部编译；</li> <li>v-show是在任何条件下（首次条件是否为真）都被编译，然后被缓存，而且DOM元素始终被保留</li></ul></li> <li>性能消耗
<ul><li>v-if有更高的切换消耗，不适合做频繁的切换；</li> <li>v-show有更高的初始渲染消耗，适合做频繁的额切换；</li></ul></li> <li>编译过程
<ul><li>v-if切换有一个局部编译/卸载的过程，切换过程中合适地销毁和重建内部的事件监听和子组件；</li> <li>v-show只是简单的基于css切换；</li></ul></li> <li>v-if 原理
<ul><li>语法会编译成特殊的语法函数(三元运算符) 为true的时候 他会创建dom 否则就创建一个空的节点</li></ul></li> <li>v-show 原理
<ul><li>语法会编译成出来 就是一个directives(指令),在运行的时候会处理这个指令,如果值是false 那么dom的display就为none,如果是true那么原来是啥就是啥</li></ul></li></ul> <h3 id="_14、为什么v-for和v-if不能连用"><a href="#_14、为什么v-for和v-if不能连用" aria-hidden="true" class="header-anchor">#</a> 14、为什么v-for和v-if不能连用</h3> <ul><li>v-for会比v-if的优先级高一些,如果连用户的话会把v-if给每个元素添加一下,会造成性能问题</li> <li>v-for和v-if连用的时候,代码会先创建v-for 遍历dom,然后在每个dom上添加v-if,很多个v-if会造成性能问题,一般建议在v-for的父级用v-if，这样v-if只有一个</li></ul> <h3 id="_15、diff算法的事件复杂度"><a href="#_15、diff算法的事件复杂度" aria-hidden="true" class="header-anchor">#</a> 15、diff算法的事件复杂度</h3> <ul><li>两个树的完全diff算法是一个时间复杂度为o(n3),vue进行了优化o(n3)复杂度的问题转成成了o(n)复杂的问题，在前端当中,很好会跨越层级地移动Dom元素,所以Virtual Dom只会对同一个层级的元素进行对比</li></ul> <h3 id="_16、简述vue的diff算法原理"><a href="#_16、简述vue的diff算法原理" aria-hidden="true" class="header-anchor">#</a> 16、简述Vue的diff算法原理</h3> <ul><li>1、先同级比较,再比较子节点</li> <li>2、先判断一方有儿子一方没有儿子的情况</li> <li>3、比较都有儿子的情况</li> <li>4、递归比较子节点
<ul><li>子节点比较具体看上面</li></ul></li></ul> <h3 id="_17、v-for-中为什么要用key"><a href="#_17、v-for-中为什么要用key" aria-hidden="true" class="header-anchor">#</a> 17、v-for 中为什么要用key</h3> <ul><li>和第一题答案一样</li></ul> <h3 id="_18、描述组件渲染和更新的过程"><a href="#_18、描述组件渲染和更新的过程" aria-hidden="true" class="header-anchor">#</a> 18、描述组件渲染和更新的过程</h3> <ul><li>渲染组件时,会通过vue.extend方法构建子组件的构造函数,并实例化,最终通过$mount()进行挂载.</li> <li>更新组件时会进行patchVnode流程,核心就是diff算法
<ul><li>1、h=&gt;h(App) 如果传入的是一个string的话就是普通dom。否则就是一个组件,会调用createComponent,他内部会调用Vue.extend,创建组件的时候就去new这个构造函数,同时给组件挂上一些钩子(init,patch,insert,destroy)，最后返回虚拟节点</li> <li>2、vm._update 执行会用之前的虚拟节点 创建组件,会调用内部的钩子init 然后就会new 之前创造的构造函数,只要一new就会重新执行 vue渲染逻辑 会给组件加上一个watcher 去渲染,最后插入到页面上</li></ul></li></ul> <h3 id="_19、组件中的data为什么是一个函数，为什么new-vue-data-xx-这个不data不用返回函数"><a href="#_19、组件中的data为什么是一个函数，为什么new-vue-data-xx-这个不data不用返回函数" aria-hidden="true" class="header-anchor">#</a> 19、组件中的data为什么是一个函数，为什么new Vue({data:xx})这个不data不用返回函数</h3> <ul><li>1、同一个组件被复用多次,会创建多个实例.这些实例用的是同一个构造函数,假如data是一个对象,那么所有组件都引用了这个对象,为了保证组件的数据独立性要求每个组件必须通过data函数返回一个对象作为组件的状态</li> <li>2、因为他是顶级,不会被复用 new Vue只有一次</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token punctuation">{</span>
  data<span class="token punctuation">:</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'xx'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
r1<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">'1'</span>
<span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r2<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
</code></pre></div><h3 id="_20、vue中事件绑定的原理"><a href="#_20、vue中事件绑定的原理" aria-hidden="true" class="header-anchor">#</a> 20、Vue中事件绑定的原理</h3> <ul><li>Vue中事件绑定分为两种,一种是原生的事件绑定,还有一种是组件的事件绑定</li> <li>1、原生dom事件的绑定是 <code>@click.native=fn</code> 他会编译成<code>nativeOn</code> 他等价于普通元素的on</li> <li>2、组件事件绑定是 <code>@click=fn</code> 他会转换成<code>$on</code> 组件的 on 会单独处理，<code>$on</code>他会收集定义的组件到_events数组中等待<code>$emit</code>遍历key获取到对应的_events事件触发</li> <li>如果v-for 要给每个元素进行事件绑定可以用事件代理</li></ul> <h3 id="_21、v-model中的实现原理及如何自定义v-model"><a href="#_21、v-model中的实现原理及如何自定义v-model" aria-hidden="true" class="header-anchor">#</a> 21、v-model中的实现原理及如何自定义v-model</h3> <ul><li>组件的v-model 就是value+input方法 的语法糖</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 自定义v-model</span>
<span class="token comment">// 组件需要一个model对象</span>
vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'el-checkbox'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  template<span class="token punctuation">:</span><span class="token template-string"><span class="token string">`
    &lt;input type='checkbox' :checked=&quot;check&quot;
    @change='@emit('change',$event.target.checked)'
  `</span></span><span class="token punctuation">,</span>
  model<span class="token punctuation">:</span><span class="token punctuation">{</span>
    props<span class="token punctuation">:</span><span class="token string">'check'</span><span class="token punctuation">,</span><span class="token comment">// 更改默认的value名字</span>
    event<span class="token punctuation">:</span><span class="token string">'change'</span><span class="token comment">//更改默认的方法名</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  props<span class="token punctuation">:</span><span class="token punctuation">{</span>
    check<span class="token punctuation">:</span>Boolean
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// vue内部处理 当传递了model就用用户的,没有的话就默认</span>
<span class="token comment">// data.attrs.value = 当前的value</span>
<span class="token comment">// on(input) 还会绑定一个input事件</span>
<span class="token keyword">function</span> <span class="token function">transformModel</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> prop <span class="token operator">=</span> options<span class="token punctuation">.</span>model<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token string">'value'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> event <span class="token operator">=</span> options<span class="token punctuation">.</span>model<span class="token punctuation">.</span>event <span class="token operator">||</span> <span class="token string">'input'</span>
  data<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>model<span class="token punctuation">.</span>value
  <span class="token function">on</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span> callback 
<span class="token punctuation">}</span>
</code></pre></div><ul><li>原生的 v-model 会根据标签的不同生成不同的事件和属性
<ul><li>原生input 默认就是 value属性 和 change/input事件</li> <li>原生checked 默认就是 checked属性 和 change事件</li></ul></li> <li>input原生标签相对组件多了一个指令的属性
<ul><li>这个指令主要是对输入做一些校验功能，以及绑定一些自己的事件</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>input v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">'value'</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token comment">/*
return('input',{
  directives:[{
    name:'model',
    expression:'value'
    ....
  }],
  domProps:{
    value:value
  },
  on:{
    input:($event)=&gt;{
      value = $event.target.value
    }
  }
})


*/</span>
</code></pre></div><ul><li>自定义例子</li> <li>组件 v-model 对应子组件model属性默认是<code>model:{prop:value,event:input}</code></li> <li>v-model缩写 等同于 属性绑定+事件监控+传值,还有子组件 接收的值可以任意写</li></ul> <div class="language-html extra-class"><pre class="language-html"><code> <span class="token comment">&lt;!-- parent --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>我是父亲, 对儿子说： {{sthGiveChild}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- &lt;Test v-model=&quot;sthGiveChild&quot;&gt;&lt;/Test&gt; --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Test</span> 
        <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>sthGiveChild<span class="token punctuation">'</span></span>
        <span class="token attr-name">@returnBack</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sthGiveChild = $event<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name">:give</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>sthGiveChild<span class="token punctuation">'</span></span>
    <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Test</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- &lt;input type=&quot;text&quot; v-model=&quot;sthGiveChild&quot;/&gt; --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Test <span class="token keyword">from</span> <span class="token string">'./Test.vue'</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">data</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        sthGiveChild<span class="token punctuation">:</span><span class="token string">'给你100块'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    components<span class="token punctuation">:</span><span class="token punctuation">{</span>
      Test
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>


<span class="token comment">&lt;!--  children --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    test
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>我是儿子，父亲对我说： {{give}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>javascript:;<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>returnBackFn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>回应<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
     <span class="token comment">&lt;!-- &lt;input v-bind:value=&quot;give&quot; @input=&quot;$emit('input', $event.target.value)&quot;&gt; --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    props<span class="token punctuation">:</span><span class="token punctuation">{</span>
       give<span class="token punctuation">:</span> String
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">{</span>
        data<span class="token punctuation">:</span><span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 标签内写的时候 就将model属性注释</span>
    model<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      prop<span class="token punctuation">:</span> <span class="token string">'give'</span><span class="token punctuation">,</span>
      event<span class="token punctuation">:</span> <span class="token string">'returnBack'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">returnBackFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'returnBack'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`还你200</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token operator">++</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">块`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="sync-v-model"><a href="#sync-v-model" aria-hidden="true" class="header-anchor">#</a> sync v-model</h3> <ul><li>sync是修改符号</li> <li>v-model 一个组件只能绑定一个</li> <li>都是组件双向绑定</li></ul> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token comment">&lt;!-- v-model的本质 --&gt;</span>
  <span class="token comment">&lt;!--v-model写法--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-component</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--编译后的写法--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-component</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">@input</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>value = $event.target.value<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--
  默认针对原生组件input事件，但是如果子组件定义了针对事件
  model: {
          prop: &quot;value&quot;,
          event: &quot;update&quot;
  },
  则编译为
  --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-component</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">@update</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>(val) =&gt; value = val<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>


  <span class="token comment">&lt;!-- .sync本质 --&gt;</span>
  <span class="token comment">&lt;!--语法糖.sync--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-component</span> <span class="token attr-name">:value.sync</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token comment">&lt;!--编译后的写法--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-component</span> 
    <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span> 
    <span class="token attr-name"><span class="token namespace">@update:</span>value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>(val) =&gt; value = val<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_22、vue中v-html会导致哪些问题？"><a href="#_22、vue中v-html会导致哪些问题？" aria-hidden="true" class="header-anchor">#</a> 22、vue中v-html会导致哪些问题？</h3> <ul><li>1、可能会导致xss攻击</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 输入 &lt;img src=&quot;&quot; onerror='alert(1)'&gt;</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">&quot;msg&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div v<span class="token operator">-</span>html<span class="token operator">=</span><span class="token string">'msg'</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">{</span> 
  <span class="token function-variable function">data</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">:</span><span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>2、v-html 会替换掉标签内部的子元素
<ul><li>他的原理就是innerHTML，innerHTML替换的时候就会清空所有子元素</li></ul></li></ul> <h3 id="_23、vue父子组件声明周期调用顺序"><a href="#_23、vue父子组件声明周期调用顺序" aria-hidden="true" class="header-anchor">#</a> 23、vue父子组件声明周期调用顺序</h3> <ul><li>加载渲染过程
<ul><li>父beforeCreate-&gt;父created-&gt;父beforeMount-&gt;子beforeCreate-&gt;子created-&gt;子beforeMount-&gt;子mounted-&gt;父mounted</li></ul></li> <li>子组件更新过程
<ul><li>父beforeUpdate-&gt;子beforeUpdate-&gt;子updated-&gt;父updated</li></ul></li> <li>父组件更新的时候
<ul><li>父beforeUpdate-&gt;父updated</li></ul></li> <li>销毁过程
<ul><li>父beforeDestroy-&gt;子beforeDestroy-&gt;子destroyed-&gt;父destroyed</li></ul></li> <li>组件的调用顺序都是先父后子,渲染完成的顺序肯定是先子后父</li> <li>组件的销毁操作是先父后子,销毁完成的顺序是先子后父</li></ul> <h3 id="_24、vue组件如何通信"><a href="#_24、vue组件如何通信" aria-hidden="true" class="header-anchor">#</a> 24、vue组件如何通信</h3> <ul><li>单向数据流</li> <li>1、父子间通信 父-&gt;子通过props、子-&gt;父$on、$emit</li> <li>2、获取父子组件实例的方式 $parent、$children</li> <li>3、在父组件中提供数据子组件的属性或者方法 Provide、inject</li> <li>4、Ref获取实例的方式调用组件的属性或者方法</li> <li>5、eventBus 实现组件通信
<ul><li>Vue.prototype.$bus = new Vue()</li></ul></li> <li>6、vuex状态管理实现通信</li></ul> <h3 id="_25、vue中相同逻辑如何抽离"><a href="#_25、vue中相同逻辑如何抽离" aria-hidden="true" class="header-anchor">#</a> 25、vue中相同逻辑如何抽离</h3> <ul><li>Vue.mixin 用法给组件每个生命周期,函数等混入一些公共逻辑</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 源码 就是合并配置</span>
Vue<span class="token punctuation">.</span><span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">mixin<span class="token punctuation">:</span>Object</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>mixin<span class="token punctuation">)</span><span class="token comment">// 将当前定义的属性合并到每个组件中</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>
<span class="token comment">// 用法 mixin用到最多就是beforeCreate</span>
Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 他会在每个组件的挂载这个生命周期  [beforeCreate,..放当前组件的函数] mixin的函数</span>

  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_26、为什么要使用异步组件"><a href="#_26、为什么要使用异步组件" aria-hidden="true" class="header-anchor">#</a> 26、为什么要使用异步组件</h3> <ul><li>如果组件功能多打包出的结果变大,可以采用异步的方式来加载组件,主要依赖import()这个语法,可以实现文件的分隔加载</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// import 语法就是webpack提供的</span>
components<span class="token punctuation">:</span><span class="token punctuation">{</span>
  <span class="token function-variable function">AddC</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../index'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_27、什么是作用域插槽"><a href="#_27、什么是作用域插槽" aria-hidden="true" class="header-anchor">#</a> 27、什么是作用域插槽</h3> <ul><li>插槽
<ul><li>创建组件虚拟节点,会将组件儿子的虚拟节点保存起来。当初始化的时候,通过插槽属性将儿子进行分类</li> <li>普通插槽渲染的位子是在父组件里面</li></ul></li> <li>作用域插槽
<ul><li>作用域插槽在解析的时候,不会作为组件的孩子节点。会解析成函数,当子组件渲染时,会调用此函数渲染</li> <li>作用域插槽渲染是在当前子组件内</li></ul></li></ul> <h3 id="_28、谈谈你对keep-alive的了解"><a href="#_28、谈谈你对keep-alive的了解" aria-hidden="true" class="header-anchor">#</a> 28、谈谈你对keep-alive的了解?</h3> <ul><li>keep-alive 可以实现组件的缓存,当组件切换时不会对当前组件进行卸载,常用的2属性include/exclude,2个生命周期activated,deactivated 算法LRU算法</li> <li>LRU算法(最近最久未使用法)
<ul><li>[a,b,c,d] 比如用了<code>b</code>就将<code>b</code>落到数组的最后面<code>[a,c,d,b]</code>, 若是添加则往数组的尾部添加<code>[a,c,d,b,e]</code>,若是超过数组的最大长度,则删除数组最前的面<code>a</code>=&gt;<code>[c,d,b,e]</code></li></ul></li></ul> <h3 id="_29、编码优化"><a href="#_29、编码优化" aria-hidden="true" class="header-anchor">#</a> 29、编码优化</h3> <ul><li>1、不要将所有的数据都放在data中,data中的数据都会增加getter和setter，会收集对应的watcher</li> <li>2、vue在v-for 时给每项元素绑定事件需要用事件代理</li> <li>3、spa页面采用keep-alive存在组件(keep-alive使用需谨慎，会导致页面卡顿)</li> <li>4、key保证唯一性</li> <li>5、Object.freeze 冻结数据</li> <li>6、合理使用路由懒加载、异步组件</li> <li>7、尽量采用runtime运行时版本</li> <li>8、数据持久化的问题(防抖、节流)npm</li></ul> <h3 id="_30、vue加载性能优化"><a href="#_30、vue加载性能优化" aria-hidden="true" class="header-anchor">#</a> 30、vue加载性能优化</h3> <ul><li>1、第三方模块按需导入(babel-plugin-component)</li> <li>2、滚动到可视区域动态加载(https://tangbc.github.io/vue-virtual-scroll-list)</li> <li>3、图片懒加载(https://github.com/hilongjw/vue-lazyload.git)</li> <li>4、app-skeleton 骨架屏(一个插件 就是一个loading的效果)</li> <li>5、app-shell app壳</li></ul> <h3 id="_31、优化"><a href="#_31、优化" aria-hidden="true" class="header-anchor">#</a> 31、优化</h3> <ul><li>SEO优化 服务端渲染ssr</li> <li>使用cdn方式加载第三方模块</li> <li>多线程打包 happypack</li> <li>slitChunks 抽离公共文件</li> <li>sourceMap 生成</li></ul> <h3 id="_32、vue3"><a href="#_32、vue3" aria-hidden="true" class="header-anchor">#</a> 32、vue3</h3> <ul><li>Vue3 采用了TS编写</li> <li>支持 Composition API(类似hooks 函数式组件)</li> <li>vue3 中响应式原理改为proxy</li> <li>vdom的对比算法更新 只更新vdom的绑定了鼎泰数据的部分</li></ul> <h3 id="_33、实现hash路由和history路由"><a href="#_33、实现hash路由和history路由" aria-hidden="true" class="header-anchor">#</a> 33、实现hash路由和history路由</h3> <ul><li>onhashchange =&gt; hash (hashChange监听路由的变化)</li> <li>history.pushState =&gt; h5api (他会出现空白) (pushState、popState监听路由变化)</li></ul> <h3 id="_34、action-和-mutation的区别"><a href="#_34、action-和-mutation的区别" aria-hidden="true" class="header-anchor">#</a> 34、action 和 mutation的区别</h3> <ul><li>mutation 是同步更新数据</li> <li>action异步操作 可以获取数据后调用mutation提交最终数据</li></ul> <h3 id="_35、组件自身循环"><a href="#_35、组件自身循环" aria-hidden="true" class="header-anchor">#</a> 35、组件自身循环</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 父组件</span>
 <span class="token operator">&lt;</span>CascaderItem <span class="token punctuation">:</span>num<span class="token operator">=</span><span class="token string">'3'</span><span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token comment">// 子组件</span>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    CascaderItem
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;right&quot;</span> v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">'num&gt;0'</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span>Child <span class="token punctuation">:</span>num<span class="token operator">=</span><span class="token string">&quot;getNum&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">'Child'</span><span class="token punctuation">,</span>
    props<span class="token punctuation">:</span><span class="token punctuation">{</span>
      num<span class="token punctuation">:</span><span class="token punctuation">{</span>
        type<span class="token punctuation">:</span>Number
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>num<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    computed<span class="token punctuation">:</span><span class="token punctuation">{</span>
      <span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">{</span>
        
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>style lang<span class="token operator">=</span><span class="token string">&quot;scss&quot;</span> scoped<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
</code></pre></div><h2 id="vue汇总"><a href="#vue汇总" aria-hidden="true" class="header-anchor">#</a> vue汇总</h2> <h3 id="组件注册"><a href="#组件注册" aria-hidden="true" class="header-anchor">#</a> 组件注册</h3> <ul><li>全局注册和局部注册都一样</li> <li>注意名字 注册的时候可以用 驼峰也可以用-,使用的时候只能用-</li></ul> <div class="language-html extra-class"><pre class="language-html"><code>Vue.component('todo-item',{})

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>todo-item</span> <span class="token attr-name">:todo</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>todo<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>todo-item</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="计算属性"><a href="#计算属性" aria-hidden="true" class="header-anchor">#</a> 计算属性</h3> <ul><li>计算属性是基于它们的响应式依赖进行缓存的</li> <li>默认只有一个get 可以给他提供一个setter</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  fullName<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// getter</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastName
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// setter</span>
    <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> names <span class="token operator">=</span> newValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> names<span class="token punctuation">[</span>names<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="绑定class-style"><a href="#绑定class-style" aria-hidden="true" class="header-anchor">#</a> 绑定class &amp;&amp; style</h3> <ul><li>对象语法 可以动态绑定 也可以传递一个对象 也可以用计算属性</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>div v<span class="token operator">-</span>bind<span class="token punctuation">:</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;classObject&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token comment">// 1、</span>
data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  classObject<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    active<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">'text-danger'</span><span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2、</span>
data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  isActive<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  error<span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">classObject</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      active<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isActive <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">,</span>
      <span class="token string">'text-danger'</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'fatal'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>数组语法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>div v<span class="token operator">-</span>bind<span class="token punctuation">:</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;[activeClass, errorClass]&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  activeClass<span class="token punctuation">:</span> <span class="token string">'active'</span><span class="token punctuation">,</span>
  errorClass<span class="token punctuation">:</span> <span class="token string">'text-danger'</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>组件上,当声明组件的时候给了class ,然后在使用组件的时候也给class,他们会进行合并</li></ul> <h3 id="v-show-和-v-if"><a href="#v-show-和-v-if" aria-hidden="true" class="header-anchor">#</a> v-show 和 v-if</h3> <div class="language-js extra-class"><pre class="language-js"><code>v<span class="token operator">-</span>show 不支持 <span class="token operator">&lt;</span>template<span class="token operator">&gt;</span> 元素，也不支持 v<span class="token operator">-</span><span class="token keyword">else</span>。
</code></pre></div><h3 id="修饰符"><a href="#修饰符" aria-hidden="true" class="header-anchor">#</a> 修饰符</h3> <p>.lazy</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 在“change”时而非“input”时更新 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input v<span class="token operator">-</span>model<span class="token punctuation">.</span>lazy<span class="token operator">=</span><span class="token string">&quot;msg&quot;</span><span class="token operator">&gt;</span>
</code></pre></div><h3 id="递归组件"><a href="#递归组件" aria-hidden="true" class="header-anchor">#</a> 递归组件</h3> <ul><li>用到了name 属性 他代表当前的组件</li></ul> <h3 id="router"><a href="#router" aria-hidden="true" class="header-anchor">#</a> router</h3> <ul><li>两种模式 history &amp;&amp; hash</li> <li>hash 在url上会多<code>/#</code> 原理是通过 监控hashchange变化</li> <li>history 通过监控 onpopstate(出栈,当活动历史记录条目更改时触发,history.pushState()或history.replaceState()不会触发popstate事件),pushstate(进栈则需要我们通过pushState,replaceState手动实现),此模式在刷新的时候需要后端支持,否则会报错</li> <li>404 配置</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  path<span class="token punctuation">:</span><span class="token string">'*'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span>router4
<span class="token punctuation">}</span>
</code></pre></div><ul><li>replace 不会往history栈内添加新数据，替换掉当前的 history 记录。</li> <li>push会当用户点击浏览器后退按钮时，则回到之前的 URL。</li></ul></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/7/2022, 8:03:51 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Study-history/article/reg.html" class="prev">
          正则
        </a></span> <span class="next"><a href="/Study-history/article/axios.html">
          axios
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/Study-history/assets/js/app.a1ad6491.js" defer></script><script src="/Study-history/assets/js/24.7933ac39.js" defer></script>
  </body>
</html>
