<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>upload | NorthUnicorn</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/Study-history/assets/css/0.styles.e2241fa8.css" as="style"><link rel="preload" href="/Study-history/assets/js/app.a1ad6491.js" as="script"><link rel="preload" href="/Study-history/assets/js/19.0e9a993e.js" as="script"><link rel="prefetch" href="/Study-history/assets/js/10.7e604d29.js"><link rel="prefetch" href="/Study-history/assets/js/11.3067a7ca.js"><link rel="prefetch" href="/Study-history/assets/js/12.d1a6fe69.js"><link rel="prefetch" href="/Study-history/assets/js/13.4864be39.js"><link rel="prefetch" href="/Study-history/assets/js/14.30636de0.js"><link rel="prefetch" href="/Study-history/assets/js/15.2bcbbae8.js"><link rel="prefetch" href="/Study-history/assets/js/16.9d7f8d82.js"><link rel="prefetch" href="/Study-history/assets/js/17.0b328dfe.js"><link rel="prefetch" href="/Study-history/assets/js/18.f73ae9e0.js"><link rel="prefetch" href="/Study-history/assets/js/2.d8f505d4.js"><link rel="prefetch" href="/Study-history/assets/js/20.1a0bbb82.js"><link rel="prefetch" href="/Study-history/assets/js/21.23696e8c.js"><link rel="prefetch" href="/Study-history/assets/js/22.0c73380e.js"><link rel="prefetch" href="/Study-history/assets/js/23.c3ff09bc.js"><link rel="prefetch" href="/Study-history/assets/js/24.7933ac39.js"><link rel="prefetch" href="/Study-history/assets/js/25.c8ae28e2.js"><link rel="prefetch" href="/Study-history/assets/js/26.3736bb12.js"><link rel="prefetch" href="/Study-history/assets/js/27.97f3f560.js"><link rel="prefetch" href="/Study-history/assets/js/28.fa4268d5.js"><link rel="prefetch" href="/Study-history/assets/js/29.50a00a75.js"><link rel="prefetch" href="/Study-history/assets/js/3.8796f9d7.js"><link rel="prefetch" href="/Study-history/assets/js/30.25371944.js"><link rel="prefetch" href="/Study-history/assets/js/31.b1b8fd04.js"><link rel="prefetch" href="/Study-history/assets/js/32.f534b2b4.js"><link rel="prefetch" href="/Study-history/assets/js/33.b9e3298a.js"><link rel="prefetch" href="/Study-history/assets/js/34.8ac7105e.js"><link rel="prefetch" href="/Study-history/assets/js/35.ba4dfc73.js"><link rel="prefetch" href="/Study-history/assets/js/36.ef19edf1.js"><link rel="prefetch" href="/Study-history/assets/js/37.0f9caf07.js"><link rel="prefetch" href="/Study-history/assets/js/38.2e4a8c9a.js"><link rel="prefetch" href="/Study-history/assets/js/39.46f87030.js"><link rel="prefetch" href="/Study-history/assets/js/4.c59777f9.js"><link rel="prefetch" href="/Study-history/assets/js/40.e1794eae.js"><link rel="prefetch" href="/Study-history/assets/js/41.5507fc07.js"><link rel="prefetch" href="/Study-history/assets/js/42.caa5814b.js"><link rel="prefetch" href="/Study-history/assets/js/43.6cd8bb3f.js"><link rel="prefetch" href="/Study-history/assets/js/44.2442f75f.js"><link rel="prefetch" href="/Study-history/assets/js/45.9648c0bd.js"><link rel="prefetch" href="/Study-history/assets/js/46.de6e3a74.js"><link rel="prefetch" href="/Study-history/assets/js/47.72c2c6ba.js"><link rel="prefetch" href="/Study-history/assets/js/48.d5004b5b.js"><link rel="prefetch" href="/Study-history/assets/js/49.a2d1d664.js"><link rel="prefetch" href="/Study-history/assets/js/5.9b395665.js"><link rel="prefetch" href="/Study-history/assets/js/50.19b7d6c9.js"><link rel="prefetch" href="/Study-history/assets/js/51.a9a0da08.js"><link rel="prefetch" href="/Study-history/assets/js/52.e99771cc.js"><link rel="prefetch" href="/Study-history/assets/js/53.74e55a43.js"><link rel="prefetch" href="/Study-history/assets/js/54.c4ff7ebc.js"><link rel="prefetch" href="/Study-history/assets/js/55.acadfba7.js"><link rel="prefetch" href="/Study-history/assets/js/56.8fa49260.js"><link rel="prefetch" href="/Study-history/assets/js/57.08f5f4e4.js"><link rel="prefetch" href="/Study-history/assets/js/58.9d13dd4c.js"><link rel="prefetch" href="/Study-history/assets/js/6.d5fd31a3.js"><link rel="prefetch" href="/Study-history/assets/js/7.ec2eb6b8.js"><link rel="prefetch" href="/Study-history/assets/js/8.91dd34c9.js"><link rel="prefetch" href="/Study-history/assets/js/9.814e5587.js">
    <link rel="stylesheet" href="/Study-history/assets/css/0.styles.e2241fa8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Study-history/" class="home-link router-link-active"><!----> <span class="site-name">NorthUnicorn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Study-history/front/" class="nav-link">front</a></div><div class="nav-item"><a href="/Study-history/houduan/" class="nav-link">back</a></div><div class="nav-item"><a href="/Study-history/devOps/" class="nav-link">devOps</a></div><div class="nav-item"><a href="/Study-history/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/Study-history/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/songge7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Study-history/front/" class="nav-link">front</a></div><div class="nav-item"><a href="/Study-history/houduan/" class="nav-link">back</a></div><div class="nav-item"><a href="/Study-history/devOps/" class="nav-link">devOps</a></div><div class="nav-item"><a href="/Study-history/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/Study-history/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/songge7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>article</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/webpack5.html" class="sidebar-link">webpack5 更新版本</a></li><li><a href="/Study-history/article/webpack.html" class="sidebar-link">webpack(基础)</a></li><li><a href="/Study-history/article/module.html" class="sidebar-link">module</a></li><li><a href="/Study-history/article/vueAnalysis.html" class="sidebar-link">vue</a></li><li><a href="/Study-history/article/vueN.html" class="sidebar-link">vue</a></li><li><a href="/Study-history/article/promise.html" class="sidebar-link">promise &amp;&amp; Event Loop</a></li><li><a href="/Study-history/article/frontModle.html" class="sidebar-link">发布订阅模式&amp;&amp;观察者模式</a></li><li><a href="/Study-history/article/vuePlugin.html" class="sidebar-link">vuePlugin</a></li><li><a href="/Study-history/article/jwtPrinciple.html" class="sidebar-link">jwt</a></li><li><a href="/Study-history/article/routerAuth.html" class="sidebar-link">routerAuth</a></li><li><a href="/Study-history/article/statusCode.html" class="sidebar-link">常用的状态码</a></li><li><a href="/Study-history/article/useLibrary.html" class="sidebar-link">常用库</a></li><li><a href="/Study-history/article/reg.html" class="sidebar-link">正则</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>vue</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/vueSource.html" class="sidebar-link">vue source</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>axios</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/axios.html" class="sidebar-link">axios</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>upload</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/upload.html" class="active sidebar-link">upload</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Study-history/article/upload.html#跑通前后端" class="sidebar-link">跑通前后端</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/upload.html#搭建一个图片上传功能" class="sidebar-link">搭建一个图片上传功能</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/upload.html#切片-合并" class="sidebar-link">切片&amp;&amp;合并</a></li><li class="sidebar-sub-header"><a href="/Study-history/article/upload.html#断点续传" class="sidebar-link">断点续传</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>binary</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/binary.html" class="sidebar-link">二进制</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>http</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/article/http.html" class="sidebar-link">http</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="upload"><a href="#upload" aria-hidden="true" class="header-anchor">#</a> upload</h1> <p></p><div class="table-of-contents"><ul><li><a href="#跑通前后端">跑通前后端</a><ul><li><a href="#前端">前端</a></li><li><a href="#后端">后端</a></li></ul></li><li><a href="#搭建一个图片上传功能">搭建一个图片上传功能</a><ul><li><a href="#后端增加接口">后端增加接口</a></li><li><a href="#前端">前端</a></li></ul></li><li><a href="#切片-合并">切片&amp;&amp;合并</a><ul><li><a href="#node版本的切片">node版本的切片</a></li></ul></li><li><a href="#断点续传">断点续传</a><ul><li><a href="#前端切断">前端切断</a></li><li><a href="#后端接口对应">后端接口对应</a></li></ul></li></ul></div><p></p> <ul><li><a href="https://github.com/xiaoqi7777/upload" target="_blank" rel="noopener noreferrer">实现代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>分支master 前端代码 技术react hooks+ts</li> <li>分支back 后端代码 express</li></ul> <h2 id="跑通前后端"><a href="#跑通前后端" aria-hidden="true" class="header-anchor">#</a> 跑通前后端</h2> <ul><li>文件上传 前后端都基于ts,前端采用的react+hooks,后端用的express</li></ul> <h3 id="前端"><a href="#前端" aria-hidden="true" class="header-anchor">#</a> 前端</h3> <ul><li>利用react脚手架搭建一个前端项目</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
  create-react-app client --template=typescript
  cd create-react-app
  cnpm i antd -S
*/</span>
<span class="token comment">// App.tsx</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span>
<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span>  <span class="token punctuation">[</span>number<span class="token punctuation">,</span>setNumber<span class="token punctuation">]</span><span class="token operator">=</span>useState<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">btn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">let</span> rs <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     url<span class="token punctuation">:</span><span class="token string">'/test/123?a=1'</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rs'</span><span class="token punctuation">,</span>rs<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;App&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>btn<span class="token punctuation">}</span><span class="token operator">&gt;</span>接口测试<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token parameter">app</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>number<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>
<span class="token comment">// /utils/request</span>
<span class="token comment">// 封装 ajax</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">interface</span> <span class="token class-name">OPTIONS</span><span class="token punctuation">{</span>
  method<span class="token operator">?</span><span class="token punctuation">:</span>string<span class="token punctuation">,</span>
  url<span class="token operator">?</span><span class="token punctuation">:</span>string<span class="token punctuation">,</span>
  headers<span class="token operator">?</span><span class="token punctuation">:</span>any<span class="token punctuation">,</span>
  data<span class="token operator">?</span><span class="token punctuation">:</span>any
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">:</span><span class="token constant">OPTIONS</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    method<span class="token punctuation">:</span><span class="token string">'GET'</span><span class="token punctuation">,</span>
    headers<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//请求头</span>
    baseUrl<span class="token punctuation">:</span><span class="token string">'http://localhost:8000'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span><span class="token operator">...</span>options<span class="token punctuation">,</span>headers<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token operator">...</span>defaultOptions<span class="token punctuation">.</span>headers<span class="token punctuation">,</span><span class="token operator">...</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>headers<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">:</span>Function<span class="token punctuation">,</span>reject<span class="token punctuation">:</span>Function</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>method<span class="token operator">!</span><span class="token punctuation">,</span>defaultOptions<span class="token punctuation">.</span>baseUrl<span class="token operator">+</span>options<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="后端"><a href="#后端" aria-hidden="true" class="header-anchor">#</a> 后端</h3> <ul><li>利用express 搭建一个后端项目</li> <li>nodemon 监听文件变化 自动重启服务</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
  npx tsconfig.json
  cnpm i fs-extra express morgan http-errors http-status-codes cors  multer multiparty -S
  cnpm i @types/fs-extra @types/node   @types/express @types/morgan @types/http-errors cross-env typescript ts-node ts-node-dev nodemon @types/cors @types/multer @types/multiparty -D
*/</span>

<span class="token comment">// package.json</span>
<span class="token comment">// &quot;dev&quot;:&quot;cross-env PROT=8000 nodemon --exec ts-node --files src/www.ts&quot;</span>

<span class="token comment">// www.ts</span>
<span class="token keyword">import</span> app <span class="token keyword">from</span> <span class="token string">'./app'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">'http'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">8000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> onListening<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">onListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Listening on '</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// app.ts</span>
<span class="token keyword">import</span> express<span class="token punctuation">,</span><span class="token punctuation">{</span>Request<span class="token punctuation">,</span>Response<span class="token punctuation">,</span>NextFunction<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> cors <span class="token keyword">from</span> <span class="token string">'cors'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test/:name'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span>res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span>next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>success<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> app
</code></pre></div><h2 id="搭建一个图片上传功能"><a href="#搭建一个图片上传功能" aria-hidden="true" class="header-anchor">#</a> 搭建一个图片上传功能</h2> <ul><li>利用multiparty解析图片</li></ul> <h3 id="后端增加接口"><a href="#后端增加接口" aria-hidden="true" class="header-anchor">#</a> 后端增加接口</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express<span class="token punctuation">,</span><span class="token punctuation">{</span>Request<span class="token punctuation">,</span>Response<span class="token punctuation">,</span>NextFunction<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> multiparty <span class="token keyword">from</span> <span class="token string">'multiparty'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> cors <span class="token keyword">from</span> <span class="token string">'cors'</span><span class="token punctuation">;</span>
<span class="token comment">// 把原生的fs包装加强</span>
<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs-extra'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PUBLIC_DIR</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'public'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 测试接口</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test/:name'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span>res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span>next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>success<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 图片上传 利用multiparty</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span>res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span>next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">multiparty<span class="token punctuation">.</span>Form</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">:</span>any<span class="token punctuation">,</span>fields<span class="token punctuation">,</span>files</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> fields<span class="token punctuation">.</span>chunk_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//xxx.jpg</span>
    <span class="token keyword">let</span> chunk <span class="token operator">=</span> files<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 文件流</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fields'</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span>chunk<span class="token punctuation">)</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>path<span class="token punctuation">,</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">PUBLIC_DIR</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>success<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> app
</code></pre></div><h3 id="前端-2"><a href="#前端-2" aria-hidden="true" class="header-anchor">#</a> 前端</h3> <ul><li>1、预览图片
<ul><li><code>window.URL.createObjectURL(file)</code> 这个方法可以将传入的图片对象 生成一个图片地址,会导致内存泄露,慎用</li> <li><code>FileReader</code>,reader.addEventListener 也可以获取图片的地址</li></ul></li> <li>2、图片上传
<ul><li><code>FormData</code>h5的api 这个和html的 form 传递是一样的,通过append添加即可</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Upload.tsx</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> ChangeEvent<span class="token punctuation">,</span> useState<span class="token punctuation">,</span>useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Row<span class="token punctuation">,</span> Col<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> Button<span class="token punctuation">,</span> message <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> request <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span>

<span class="token keyword">function</span> <span class="token function">Upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>currentFile<span class="token punctuation">,</span> setCurrentFile<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>objectURL<span class="token punctuation">,</span>setObjectURL<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 图片预览</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>currentFile<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 1、会导致内存泄露</span>
    <span class="token comment">// let objectURL = window.URL.createObjectURL(currentFile)</span>
    <span class="token comment">// setObjectURL(objectURL)</span>
    <span class="token comment">// return () =&gt; window.URL.revokeObjectURL(objectURL)</span>
    <span class="token comment">// 2、建议用这个</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setObjectURL</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>currentFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span>currentFile<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span> ChangeEvent<span class="token operator">&lt;</span>HTMLInputElement<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// event.target.files![0] 就是上传文件的信息</span>
    <span class="token function">setCurrentFile</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`你尚未选择文件`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">allowUpload</span><span class="token punctuation">(</span>currentFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`不支持本类型文件上传`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'chunk'</span><span class="token punctuation">,</span>currentFile<span class="token punctuation">)</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'chunk_name'</span><span class="token punctuation">,</span>currentFile<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token punctuation">:</span><span class="token string">'/upload'</span><span class="token punctuation">,</span>
      method<span class="token punctuation">:</span><span class="token string">'POST'</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span>formData
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span>
    message<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Row<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token comment">/* 按钮点击 */</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>Col span<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">12</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Input type<span class="token operator">=</span><span class="token string">'file'</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> width<span class="token punctuation">:</span> <span class="token number">300</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Input<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Button type<span class="token operator">=</span><span class="token string">&quot;primary&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleUpload<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>上传图片<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Col<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token comment">/* 图片预览 */</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>Col span<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">12</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token punctuation">{</span>objectURL <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token punctuation">{</span>objectURL<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>width<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">}</span> alt<span class="token operator">=</span><span class="token string">'视频'</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Col<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Row<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 限制图片上传条件</span>
<span class="token keyword">function</span> <span class="token function">allowUpload</span><span class="token punctuation">(</span><span class="token parameter">currentFile<span class="token punctuation">:</span> File</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> fileType <span class="token operator">=</span> currentFile<span class="token punctuation">.</span>type<span class="token punctuation">;</span><span class="token comment">// type: &quot;image/jpeg&quot;</span>
  <span class="token keyword">let</span> validFileTypes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;image/jpeg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;image/png&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;image/gif&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;video/mp3&quot;</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> isLessThan2G <span class="token operator">=</span> currentFile<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">2</span>
  <span class="token keyword">return</span> validFileTypes<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>fileType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isLessThan2G
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Upload
</code></pre></div><h2 id="切片-合并"><a href="#切片-合并" aria-hidden="true" class="header-anchor">#</a> 切片&amp;&amp;合并</h2> <ul><li>视频/图片上传 遇到大文件 一般是前端进行切断处理,然后在分段传给后端处理</li></ul> <h3 id="node版本的切片"><a href="#node版本的切片" aria-hidden="true" class="header-anchor">#</a> node版本的切片</h3> <ul><li>切片 读文件 循环写入文件 每次写入的大小自定义 用slice来切割流文件</li> <li>合并 读文件 读取一个一个的片段 利用pipe 读一个片段就写一份内容</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// utils.ts</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> fs<span class="token punctuation">,</span> <span class="token punctuation">{</span> WriteStream <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'fs-extra'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">DEFAULT_SIZE</span> <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">PUBLIC_DIR</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'public'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">TEMP_DIR</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'temp'</span><span class="token punctuation">)</span>

<span class="token comment">// 切片</span>
<span class="token comment">// 读文件 循环写入文件 每次写入的大小自定义 用slice来切割流文件</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">splitChunks</span><span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">:</span>string<span class="token punctuation">,</span>size<span class="token punctuation">:</span>number<span class="token operator">=</span><span class="token constant">DEFAULT_SIZE</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 读流</span>
  <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
  <span class="token comment">// 写入的地址</span>
  <span class="token keyword">const</span> chunksDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">TEMP_DIR</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
  <span class="token comment">// 创建文件</span>
  <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">mkdirp</span><span class="token punctuation">(</span>chunksDir<span class="token punctuation">)</span>
  <span class="token keyword">let</span> current<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> length<span class="token operator">=</span>content<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>current<span class="token operator">&lt;</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>
      path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>chunksDir<span class="token punctuation">,</span>filename<span class="token operator">+</span><span class="token string">'_'</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>
      content<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>current<span class="token operator">+</span>size<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
    current<span class="token operator">+=</span>size
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// splitChunks('2000574.jpg')</span>

<span class="token keyword">function</span> <span class="token function">pipeStream</span><span class="token punctuation">(</span><span class="token parameter">filePath<span class="token punctuation">:</span>string<span class="token punctuation">,</span>ws<span class="token punctuation">:</span>WriteStream</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">:</span>Function<span class="token punctuation">,</span>_reject<span class="token punctuation">:</span>Function</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
    rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 合并</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">mergeChunks</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">:</span>string<span class="token punctuation">,</span> size<span class="token punctuation">:</span>number <span class="token operator">=</span> <span class="token constant">DEFAULT_SIZE</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">PUBLIC_DIR</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
  <span class="token keyword">let</span> chunksDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">TEMP_DIR</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
  <span class="token comment">// fs.readdir 读目录</span>
  <span class="token keyword">const</span> chunkFiles <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>chunksDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  chunkFiles<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span>any<span class="token punctuation">,</span>b<span class="token punctuation">:</span>any</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">Number</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">Number</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 合并</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>chunkFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">chunkFile<span class="token punctuation">:</span>string<span class="token punctuation">,</span>index<span class="token punctuation">:</span>number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">pipeStream</span> <span class="token punctuation">(</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>chunksDir<span class="token punctuation">,</span>chunkFile<span class="token punctuation">)</span><span class="token punctuation">,</span>
    fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span><span class="token punctuation">{</span>
      start<span class="token punctuation">:</span>index <span class="token operator">*</span> size
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 删除目录</span>
  <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>chunksDir<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">mergeChunks</span><span class="token punctuation">(</span><span class="token string">'2000574.jpg'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="断点续传"><a href="#断点续传" aria-hidden="true" class="header-anchor">#</a> 断点续传</h2> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader" target="_blank" rel="noopener noreferrer">FileReader<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <code>实例.readAsArrayBuffer()</code>用来读取文件 <code>实例.onload=(event)=&gt;{console.log(event.target.result)}</code>onload 加载完成 文件里的文本会在这里被打印出来</li> <li>XMLHttpRequest对象用到的方法
<ul><li><code>xhr.upload.onprogress = ()=&gt;{}</code>(xhr.upload 上传的过程有onprogress onprogress等处理事件),xhr每次上传的时候 执行传递过来的方法,让页面的进度条定期修改</li> <li><code>xhr.abort()</code> 如果请求已被发送，则立刻中止请求。如果继续接着调用之前的传递数据接口</li></ul></li> <li>worker的用法
<ul><li>他是多线程</li> <li><code>let worker = new Worker('/hash.js')</code>通过 worker.postMessage(data) 给另外一端传递数据,worker.onmessage=()=&gt;{} 可以监听到另外一端传递过来的数据</li> <li><code>hash.js 文件</code>self.onmessage=()=&gt;{} 监听到数据, 同样self.postMessage(data) 给外面发数据</li></ul></li> <li>断点续传流程
<ul><li>前端：
<ul><li>1、前端上传图片到浏览器,进行片段切割,切割方法<code>createChunks</code>利用slice方法进行切片,</li> <li>2、利用<code>worker</code>多线程 去计算hash值, 切片后再计算hash是为了速度,若是文件特别大的时候计算就相当耗时<code>buffers.forEach(buffer =&gt; spark.append(buffer))</code></li> <li>3、等待hash计算好之后,将总片段进行包装,加入<code>filename</code>&amp;&amp;<code>chunk_name</code>等值,主要<code>chunk_name</code>这个是单个切片的名字,他是有hash+数组中顺序的位子,在和切片的时候用到</li> <li>4、上传总切片,要校验当前的切片是否是续传,已经上传完成,则提示秒传成功,退出。若只传递了部分或者没有传递,则获取已经传递的信息,通过现在的总切片数据进行过滤,保留剩下没有传递的chunk,上传数据</li> <li>5、等待所有的数据上传之后,告诉服务器可以合并切片</li> <li>6、增加暂停按钮需要数据,在发送数据的时候,将回调函数传递过去<code>(xhr:XMLHttpRequest) =&gt; part.xhr = xhr</code>,把xhr实例赋到当前切片内,等按钮触发暂停的时候,遍历当前的切片获取到xhr实例,调用<code>xhr.abort()</code>停止发送</li> <li>6、恢复直接把当前的切片发送给后端,既可</li></ul></li> <li>后端:
<ul><li>文件片段传递到后端,他会先放到临时区域,等待前端发送合并片段的指令,此时后端将所有临时的片段合成完成的文件放到指定的区域,删除临时区域的所有文件</li> <li>接口1、<code>/verify/:filename</code>是否发生断点续传。第一个用hash值去文件保存的区域内查看文件是否存在,存在即之前已经上传成功。第二个去看临时区域内是否有hash值的的临时文件,若有则说明之前已经传递了部分数据,读取数据大小返回给前端既可以。若都没有则说明之前没传递过任何信息</li> <li>接口2、<code>/upload/:filename/:chunk_name/:start</code>上传文件，利用了node的 pipe双工流,<code>req.pipe(ws)</code> 创建可写流<code>fs.createWriteStream(chunkFilePath, {start,flags:'a'})</code>往临时文件内写 <code>start</code>是开始位子，每写入一个片段位子都在变化，就是他的长度,<code>flags</code>为a 则是追加的意思。最后要注意 监控可写流完成/关闭的时候关闭</li> <li>接口3、<code>/merge/:filename</code>合并所有的片段,到制定的文件夹内</li></ul></li></ul></li></ul> <h3 id="前端切断"><a href="#前端切断" aria-hidden="true" class="header-anchor">#</a> 前端切断</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// hash.js</span>
  <span class="token comment">// self固定写法 代表当前窗口</span>
  self<span class="token punctuation">.</span><span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'https://cdn.bootcss.com/spark-md5/3.0.0/spark-md5.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// partList 保存在所有的切片</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>partList<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>data
    <span class="token keyword">const</span> spark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">self<span class="token punctuation">.</span>SparkMD5<span class="token punctuation">.</span>ArrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 计算总体的hash百分比</span>
    <span class="token keyword">let</span> percent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 每次计算完一个part 相当于完成了百分之几</span>
    <span class="token keyword">let</span> perSize <span class="token operator">=</span> <span class="token number">100</span><span class="token operator">/</span>partList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">let</span> buffers <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>partList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>chunk<span class="token punctuation">,</span>size<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// h5读取文件</span>
      <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
      <span class="token comment">// 加载完成</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        percent <span class="token operator">+=</span> perSize
        self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>percent<span class="token punctuation">:</span><span class="token function">Number</span><span class="token punctuation">(</span>percent<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    buffers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=&gt;</span> spark<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>percent<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>hash<span class="token punctuation">:</span>spark<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">// Upload.tsx</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> ChangeEvent<span class="token punctuation">,</span> useState<span class="token punctuation">,</span>useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Row<span class="token punctuation">,</span> Col<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> Button<span class="token punctuation">,</span> message<span class="token punctuation">,</span> Progress<span class="token punctuation">,</span> Table <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> request <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span>
<span class="token keyword">const</span> <span class="token constant">DEFAULT_SIZE</span> <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">20</span>
<span class="token keyword">enum</span> UploadStatus<span class="token punctuation">{</span>
  <span class="token constant">INIT</span><span class="token punctuation">,</span>
  <span class="token constant">PAUSE</span><span class="token punctuation">,</span>
  <span class="token constant">UPLOADING</span>
<span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">Part</span><span class="token punctuation">{</span>
  chunk<span class="token punctuation">:</span>Blob<span class="token punctuation">;</span>
  size<span class="token punctuation">:</span>number<span class="token punctuation">;</span>
  filename<span class="token operator">?</span><span class="token punctuation">:</span>string<span class="token punctuation">;</span>
  chunk_name<span class="token operator">?</span><span class="token punctuation">:</span>string<span class="token punctuation">;</span>
  loaded<span class="token operator">?</span><span class="token punctuation">:</span>number<span class="token punctuation">;</span>
  percent<span class="token operator">?</span><span class="token punctuation">:</span>number<span class="token punctuation">;</span>
  xhr<span class="token operator">?</span><span class="token punctuation">:</span>any<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">Upload</span><span class="token punctuation">{</span>
  filename<span class="token punctuation">:</span>string<span class="token punctuation">;</span>
  size<span class="token punctuation">:</span>number
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>uploadStatus<span class="token punctuation">,</span>setUploadStatus<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>UploadStatus<span class="token operator">&gt;</span><span class="token punctuation">(</span>UploadStatus<span class="token punctuation">.</span><span class="token constant">INIT</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>currentFile<span class="token punctuation">,</span> setCurrentFile<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>File<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>objectURL<span class="token punctuation">,</span>setObjectURL<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>hashPercent<span class="token punctuation">,</span>setHashPercent<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>filename<span class="token punctuation">,</span>setFilename<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// PartList 存放切片的数据</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>partList<span class="token punctuation">,</span>setPartList<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>Part<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>currentFile<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setObjectURL</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>currentFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span>currentFile<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span> ChangeEvent<span class="token operator">&lt;</span>HTMLInputElement<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// event.target.files![0] 就是上传文件的信息</span>
    <span class="token function">setCurrentFile</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`你尚未选择文件`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">allowUpload</span><span class="token punctuation">(</span>currentFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`不支持本类型文件上传`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 弹出进度条</span>
    <span class="token function">setUploadStatus</span><span class="token punctuation">(</span>UploadStatus<span class="token punctuation">.</span><span class="token constant">UPLOADING</span><span class="token punctuation">)</span>
    <span class="token comment">// 分片上传 createChunks根据切片的大小 将文件进行切割</span>
    <span class="token keyword">let</span> partList<span class="token punctuation">:</span>Part<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createChunks</span><span class="token punctuation">(</span>currentFile<span class="token punctuation">)</span>
    <span class="token comment">// 将切割的文件 上传 hash计算 利用Worker创建一个子经常进行计算</span>
    <span class="token keyword">let</span> fileHash <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">calculateHash</span><span class="token punctuation">(</span>partList<span class="token punctuation">)</span>
    <span class="token keyword">let</span> lastDoIndex <span class="token operator">=</span> currentFile<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> extName <span class="token operator">=</span> currentFile<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastDoIndex<span class="token punctuation">)</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileHash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token function">setFilename</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    partList <span class="token operator">=</span> partList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>chunk<span class="token punctuation">,</span>size<span class="token punctuation">,</span>loaded<span class="token punctuation">,</span>percent<span class="token punctuation">}</span><span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      filename<span class="token punctuation">,</span> <span class="token comment">// hash.jpg</span>
      chunk_name<span class="token punctuation">:</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
      chunk<span class="token punctuation">,</span>
      size<span class="token punctuation">,</span>
      loaded<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
      percent<span class="token punctuation">:</span><span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">setPartList</span><span class="token punctuation">(</span>partList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'所有的切片集合'</span><span class="token punctuation">,</span>partList<span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">uploadParts</span><span class="token punctuation">(</span>partList<span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">calculateHash</span><span class="token punctuation">(</span><span class="token parameter">partList<span class="token punctuation">:</span>Part<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">:</span>Function<span class="token punctuation">,</span>reject<span class="token punctuation">:</span>Function</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// /hash.js 他会找public/hash的位子</span>
      <span class="token keyword">let</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'/hash.js'</span><span class="token punctuation">)</span>
      worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>partList<span class="token punctuation">}</span><span class="token punctuation">)</span>
      worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span>percent<span class="token punctuation">,</span>hash<span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>data
        <span class="token function">setHashPercent</span><span class="token punctuation">(</span>percent<span class="token punctuation">)</span>
        <span class="token comment">// 有hash 就说明切割完成</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// verify 功能就是查看数据是否上传完成  已经返回已上传的数据大小 和 名字(当刷新页面的时候 会接着传递)</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">:</span>string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>  <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token punctuation">:</span><span class="token template-string"><span class="token string">`/verify/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
      method<span class="token punctuation">:</span><span class="token string">'get'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadParts</span><span class="token punctuation">(</span><span class="token parameter">partList<span class="token punctuation">:</span>Part<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>filename<span class="token punctuation">:</span>string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// partList 是所有的切片</span>
    <span class="token comment">// uploadList 已经上传过的所有信息</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">verify</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'uploadList'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
    <span class="token keyword">let</span>  <span class="token punctuation">{</span> needUpload<span class="token punctuation">,</span>uploadList <span class="token punctuation">}</span> <span class="token operator">=</span> data

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'needUpload'</span><span class="token punctuation">,</span>needUpload<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needUpload<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'秒传成功'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// uploadList 已经上传的数据包信息</span>
    <span class="token comment">// partList 总的数据包</span>
    <span class="token keyword">let</span> requests <span class="token operator">=</span> <span class="token function">createRequests</span><span class="token punctuation">(</span>partList<span class="token punctuation">,</span>uploadList<span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token punctuation">:</span><span class="token template-string"><span class="token string">`/merge/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
      method<span class="token punctuation">:</span><span class="token string">'GET'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
  <span class="token keyword">function</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setUploadStatus</span><span class="token punctuation">(</span>UploadStatus<span class="token punctuation">.</span><span class="token constant">INIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setHashPercent</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPartList</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setFilename</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">createRequests</span><span class="token punctuation">(</span><span class="token parameter">partList<span class="token punctuation">:</span>Part<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>uploadList<span class="token punctuation">:</span>Upload<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>filename<span class="token punctuation">:</span>string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> partList<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">part<span class="token punctuation">:</span>Part</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      part<span class="token punctuation">.</span>loaded <span class="token operator">=</span> part<span class="token punctuation">.</span>loaded<span class="token operator">?</span>part<span class="token punctuation">.</span>loaded<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">// uploadList 已经上传过的列表</span>
      <span class="token keyword">let</span> uploadFile <span class="token operator">=</span> uploadList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span>item<span class="token punctuation">.</span>filename <span class="token operator">===</span> part<span class="token punctuation">.</span>chunk_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 没有上传过 直接退出</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>uploadFile<span class="token punctuation">)</span><span class="token punctuation">{</span>
        part<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 已经上传的字节数0</span>
        part<span class="token punctuation">.</span>percent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 已经上传的百分比就是0 分片上传过的半分比就是0</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 过滤已经上传过的</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>uploadFile<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> part<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">{</span>
        part<span class="token punctuation">.</span>loaded <span class="token operator">=</span> uploadFile<span class="token punctuation">.</span>size<span class="token punctuation">;</span><span class="token comment">// 已经上传的字节数0</span>
        part<span class="token punctuation">.</span>percent <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>loaded<span class="token operator">/</span>part<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 已经上传的百分比就是0 分片上传过的半分比就是0</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">part<span class="token punctuation">:</span>Part</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token punctuation">:</span><span class="token template-string"><span class="token string">`/upload/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>part<span class="token punctuation">.</span>chunk_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>part<span class="token punctuation">.</span>loaded<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
      method<span class="token punctuation">:</span><span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token comment">// application/octet-stream 字节流</span>
      headers<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token punctuation">:</span><span class="token string">'application/octet-stream'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 在发送请的时候 将xhr保存在partList中</span>
      <span class="token function-variable function">setXHR</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token parameter">xhr<span class="token punctuation">:</span>XMLHttpRequest</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> part<span class="token punctuation">.</span>xhr <span class="token operator">=</span> xhr<span class="token punctuation">,</span>
      <span class="token function-variable function">onProgress</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span>ProgressEvent</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        part<span class="token punctuation">.</span>percent <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>loaded<span class="token operator">!</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>loaded<span class="token operator">!</span><span class="token punctuation">)</span><span class="token operator">/</span>part<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span>size<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 页面刷新</span>
        <span class="token function">setPartList</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>partList<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span>part<span class="token punctuation">.</span>chunk
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 暂停</span>
  <span class="token keyword">function</span> <span class="token function">handlePause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 如果请求已被发送，则立刻中止请求。</span>
    partList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">part<span class="token punctuation">:</span>Part</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> part<span class="token punctuation">.</span>xhr <span class="token operator">&amp;&amp;</span> part<span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">setUploadStatus</span><span class="token punctuation">(</span>UploadStatus<span class="token punctuation">.</span><span class="token constant">PAUSE</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 恢复</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setUploadStatus</span><span class="token punctuation">(</span>UploadStatus<span class="token punctuation">.</span><span class="token constant">UPLOADING</span><span class="token punctuation">)</span>
    <span class="token comment">// 发送请求</span>
    <span class="token keyword">await</span> <span class="token function">uploadParts</span><span class="token punctuation">(</span>partList<span class="token punctuation">,</span>filename<span class="token operator">!</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span>
  <span class="token comment">// 总进度</span>
  <span class="token keyword">let</span> totalPercent <span class="token operator">=</span> partList<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">?</span> partList<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span>number<span class="token punctuation">,</span>b<span class="token punctuation">:</span>Part</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>a<span class="token operator">+</span>b<span class="token punctuation">.</span>percent<span class="token operator">!</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">/</span>partList<span class="token punctuation">.</span>length  <span class="token punctuation">:</span><span class="token number">0</span>

  <span class="token keyword">const</span> columns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span><span class="token string">'切片名称'</span><span class="token punctuation">,</span>
      dataIndex<span class="token punctuation">:</span><span class="token string">&quot;filename&quot;</span><span class="token punctuation">,</span>
      key<span class="token punctuation">:</span><span class="token string">&quot;filename&quot;</span><span class="token punctuation">,</span>
      width<span class="token punctuation">:</span><span class="token string">&quot;20%&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span><span class="token string">'进度'</span><span class="token punctuation">,</span>
      dataIndex<span class="token punctuation">:</span><span class="token string">&quot;percent&quot;</span><span class="token punctuation">,</span>
      key<span class="token punctuation">:</span><span class="token string">&quot;percent&quot;</span><span class="token punctuation">,</span>
      width<span class="token punctuation">:</span><span class="token string">&quot;80%&quot;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">render</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span>number</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Progress percent<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">let</span> uploadProgress <span class="token operator">=</span> uploadStatus <span class="token operator">!==</span> UploadStatus<span class="token punctuation">.</span><span class="token constant">INIT</span> <span class="token operator">?</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>Row<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Col span<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token constant">HASH</span>总进度
        <span class="token operator">&lt;</span><span class="token operator">/</span>Col<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Col span<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">20</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Progress percent<span class="token operator">=</span><span class="token punctuation">{</span>hashPercent<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Col<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Row<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Row<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Col span<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          总进度
        <span class="token operator">&lt;</span><span class="token operator">/</span>Col<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Col span<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">20</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Progress percent<span class="token operator">=</span><span class="token punctuation">{</span>totalPercent<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Col<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Row<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Table 
        columns<span class="token operator">=</span> <span class="token punctuation">{</span>columns<span class="token punctuation">}</span>
        dataSource <span class="token operator">=</span> <span class="token punctuation">{</span>partList<span class="token punctuation">}</span>
        rowKey<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">row</span> <span class="token operator">=&gt;</span> row<span class="token punctuation">.</span>chunk_name<span class="token operator">!</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Row<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token comment">/* 按钮点击 */</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>Col span<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">12</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Input type<span class="token operator">=</span><span class="token string">'file'</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> width<span class="token punctuation">:</span> <span class="token number">300</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Input<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Button type<span class="token operator">=</span><span class="token string">&quot;primary&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleUpload<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>上传图片<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
          <span class="token punctuation">{</span>
            uploadStatus <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span><span class="token constant">UPLOADING</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>Button type<span class="token operator">=</span><span class="token string">&quot;primary&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>handlePause<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>marginLeft<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>暂停<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
          <span class="token punctuation">}</span>
          <span class="token punctuation">{</span>
            uploadStatus <span class="token operator">===</span> UploadStatus<span class="token punctuation">.</span><span class="token constant">PAUSE</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>Button type<span class="token operator">=</span><span class="token string">&quot;primary&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleResume<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>marginLeft<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>恢复<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
          <span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Col<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token comment">/* 图片预览 */</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>Col span<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">12</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token punctuation">{</span>objectURL <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token punctuation">{</span>objectURL<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>width<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">}</span> alt<span class="token operator">=</span><span class="token string">'视频'</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Col<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Row<span class="token operator">&gt;</span>
      <span class="token punctuation">{</span>uploadProgress<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">allowUpload</span><span class="token punctuation">(</span><span class="token parameter">currentFile<span class="token punctuation">:</span> File</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> fileType <span class="token operator">=</span> currentFile<span class="token punctuation">.</span>type<span class="token punctuation">;</span><span class="token comment">// type: &quot;image/jpeg&quot;</span>
  <span class="token keyword">let</span> validFileTypes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;image/jpeg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;image/png&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;image/gif&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;video/mp3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;video/avi&quot;</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> isLessThan2G <span class="token operator">=</span> currentFile<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">2</span>
  <span class="token keyword">return</span> validFileTypes<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>fileType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isLessThan2G
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createChunks</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">:</span>File</span><span class="token punctuation">)</span><span class="token punctuation">:</span>Part<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> partList<span class="token punctuation">:</span>Part<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>current<span class="token operator">&lt;</span>file<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> chunk <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>current<span class="token operator">+</span><span class="token constant">DEFAULT_SIZE</span><span class="token punctuation">)</span>
    partList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>chunk<span class="token punctuation">,</span>size<span class="token punctuation">:</span>chunk<span class="token punctuation">.</span>size<span class="token punctuation">}</span><span class="token punctuation">)</span>
    current <span class="token operator">+=</span> <span class="token constant">DEFAULT_SIZE</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> partList
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Upload
<span class="token comment">// utils.tsx</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">interface</span> <span class="token class-name">OPTIONS</span><span class="token punctuation">{</span>
  method<span class="token operator">?</span><span class="token punctuation">:</span>string<span class="token punctuation">,</span>
  url<span class="token operator">?</span><span class="token punctuation">:</span>string<span class="token punctuation">,</span>
  headers<span class="token operator">?</span><span class="token punctuation">:</span>any<span class="token punctuation">,</span>
  data<span class="token operator">?</span><span class="token punctuation">:</span>any<span class="token punctuation">,</span>
  onProgress<span class="token operator">?</span><span class="token punctuation">:</span>any<span class="token punctuation">,</span>
  setXHR<span class="token operator">?</span><span class="token punctuation">:</span>any
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">:</span><span class="token constant">OPTIONS</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>Promise<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    method<span class="token punctuation">:</span><span class="token string">'GET'</span><span class="token punctuation">,</span>
    headers<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//请求头</span>
    baseUrl<span class="token punctuation">:</span><span class="token string">'http://localhost:8000'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span><span class="token operator">...</span>options<span class="token punctuation">,</span>headers<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token operator">...</span>defaultOptions<span class="token punctuation">.</span>headers<span class="token punctuation">,</span><span class="token operator">...</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>headers<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">:</span>Function<span class="token punctuation">,</span>reject<span class="token punctuation">:</span>Function</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>method<span class="token operator">!</span><span class="token punctuation">,</span>defaultOptions<span class="token punctuation">.</span>baseUrl<span class="token operator">+</span>options<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span>
    <span class="token comment">// xhr.upload 指上传的过程 onprogress onprogress处理事件</span>
    xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>onprogress <span class="token operator">=</span> options<span class="token punctuation">.</span>onProgress
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>setXHR<span class="token punctuation">)</span><span class="token punctuation">{</span>
      options<span class="token punctuation">.</span><span class="token function">setXHR</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="后端接口对应"><a href="#后端接口对应" aria-hidden="true" class="header-anchor">#</a> 后端接口对应</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.ts</span>
<span class="token keyword">import</span> express<span class="token punctuation">,</span><span class="token punctuation">{</span>Request<span class="token punctuation">,</span>Response<span class="token punctuation">,</span>NextFunction<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> multiparty <span class="token keyword">from</span> <span class="token string">'multiparty'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> cors <span class="token keyword">from</span> <span class="token string">'cors'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'http-status-codes'</span><span class="token punctuation">;</span><span class="token comment">//500</span>
<span class="token keyword">import</span> createError <span class="token keyword">from</span> <span class="token string">'http-errors'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>mergeChunks<span class="token punctuation">,</span> <span class="token constant">PUBLIC_DIR</span><span class="token punctuation">,</span><span class="token constant">TEMP_DIR</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span>
<span class="token comment">// 把原生的fs包装加强</span>
<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs-extra'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>extended<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 测试接口</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test/:name'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span>res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span>next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'==&gt;'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>success<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 图片上传 利用multiparty</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span>res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span>next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">multiparty<span class="token punctuation">.</span>Form</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">:</span>any<span class="token punctuation">,</span>fields<span class="token punctuation">,</span>files</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> fields<span class="token punctuation">.</span>chunk_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//xxx.jpg</span>
    <span class="token keyword">let</span> chunk <span class="token operator">=</span> files<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 文件流</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>path<span class="token punctuation">,</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">PUBLIC_DIR</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>success<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload/:filename/:chunk_name/:start'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span> _next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> filename<span class="token punctuation">,</span> chunk_name <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span> 
  <span class="token keyword">let</span> start<span class="token punctuation">:</span>number <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>start<span class="token punctuation">)</span>
  <span class="token keyword">let</span> chunk_dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">TEMP_DIR</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span>  
  <span class="token keyword">let</span> exist <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">pathExists</span><span class="token punctuation">(</span>chunk_dir<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>exist<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span>chunk_dir<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> 
  <span class="token keyword">let</span> chunkFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>chunk_dir<span class="token punctuation">,</span>chunk_name<span class="token punctuation">)</span>
  <span class="token comment">// start 0 开始写入的位子 </span>
  <span class="token comment">// flags 'a' 追加的意思</span>
  <span class="token keyword">let</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>chunkFilePath<span class="token punctuation">,</span> <span class="token punctuation">{</span>start<span class="token punctuation">,</span>flags<span class="token punctuation">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>success<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  req<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 每次先计算hash值</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/verify/:filename'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span> _next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token punctuation">:</span>Promise<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  <span class="token keyword">let</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">PUBLIC_DIR</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
  <span class="token keyword">let</span> exitFile <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">pathExists</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件是否合并'</span><span class="token punctuation">,</span>exitFile<span class="token punctuation">)</span>
  <span class="token comment">// 只有传完 才会进去这 因为只有最后一个hash进行合并的时候 `PUBLIC_DIR`才会有数据</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exitFile<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 已经完整上传过了</span>
    res<span class="token punctuation">.</span><span class="token function">json</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      success<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
      needUpload<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment">// 因为已经上传过了,所以不在上传了,可以实现秒传</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 片段</span>
  <span class="token keyword">let</span> tempDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">TEMP_DIR</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> exist <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">pathExists</span><span class="token punctuation">(</span>tempDir<span class="token punctuation">)</span>
  <span class="token keyword">let</span> uploadList<span class="token punctuation">:</span>any<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 如果已经传入了片段 </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uploadList <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>tempDir<span class="token punctuation">)</span>
    uploadList <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>uploadList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">:</span>string</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// 读取 已经上传的文件信息 返回</span>
      <span class="token keyword">let</span> stat <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>tempDir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        filename<span class="token punctuation">,</span>
        size<span class="token punctuation">:</span>stat<span class="token punctuation">.</span>size <span class="token comment">//现在的文件大小 </span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    success<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    needUpload<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    uploadList<span class="token comment">// 已经上传的文件列表</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/merge/:filename'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span> _next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params
  <span class="token keyword">await</span> <span class="token function">mergeChunks</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>success<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 没有路由匹配 会进入这</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span> _res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span>next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 错误中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">error<span class="token punctuation">:</span>any<span class="token punctuation">,</span> _req<span class="token punctuation">:</span>Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span>Response<span class="token punctuation">,</span> _next<span class="token punctuation">:</span>NextFunction</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    success<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
    error
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> app
</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/7/2022, 8:03:51 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Study-history/article/axios.html" class="prev">
          axios
        </a></span> <span class="next"><a href="/Study-history/article/binary.html">
          二进制
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/Study-history/assets/js/app.a1ad6491.js" defer></script><script src="/Study-history/assets/js/19.0e9a993e.js" defer></script>
  </body>
</html>
