<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webpack(基础) | NorthUnicorn</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/Study-history/assets/css/0.styles.e2241fa8.css" as="style"><link rel="preload" href="/Study-history/assets/js/app.a1ad6491.js" as="script"><link rel="preload" href="/Study-history/assets/js/41.5507fc07.js" as="script"><link rel="prefetch" href="/Study-history/assets/js/10.7e604d29.js"><link rel="prefetch" href="/Study-history/assets/js/11.3067a7ca.js"><link rel="prefetch" href="/Study-history/assets/js/12.d1a6fe69.js"><link rel="prefetch" href="/Study-history/assets/js/13.4864be39.js"><link rel="prefetch" href="/Study-history/assets/js/14.30636de0.js"><link rel="prefetch" href="/Study-history/assets/js/15.2bcbbae8.js"><link rel="prefetch" href="/Study-history/assets/js/16.9d7f8d82.js"><link rel="prefetch" href="/Study-history/assets/js/17.0b328dfe.js"><link rel="prefetch" href="/Study-history/assets/js/18.f73ae9e0.js"><link rel="prefetch" href="/Study-history/assets/js/19.0e9a993e.js"><link rel="prefetch" href="/Study-history/assets/js/2.d8f505d4.js"><link rel="prefetch" href="/Study-history/assets/js/20.1a0bbb82.js"><link rel="prefetch" href="/Study-history/assets/js/21.23696e8c.js"><link rel="prefetch" href="/Study-history/assets/js/22.0c73380e.js"><link rel="prefetch" href="/Study-history/assets/js/23.c3ff09bc.js"><link rel="prefetch" href="/Study-history/assets/js/24.7933ac39.js"><link rel="prefetch" href="/Study-history/assets/js/25.c8ae28e2.js"><link rel="prefetch" href="/Study-history/assets/js/26.3736bb12.js"><link rel="prefetch" href="/Study-history/assets/js/27.97f3f560.js"><link rel="prefetch" href="/Study-history/assets/js/28.fa4268d5.js"><link rel="prefetch" href="/Study-history/assets/js/29.50a00a75.js"><link rel="prefetch" href="/Study-history/assets/js/3.8796f9d7.js"><link rel="prefetch" href="/Study-history/assets/js/30.25371944.js"><link rel="prefetch" href="/Study-history/assets/js/31.b1b8fd04.js"><link rel="prefetch" href="/Study-history/assets/js/32.f534b2b4.js"><link rel="prefetch" href="/Study-history/assets/js/33.b9e3298a.js"><link rel="prefetch" href="/Study-history/assets/js/34.8ac7105e.js"><link rel="prefetch" href="/Study-history/assets/js/35.ba4dfc73.js"><link rel="prefetch" href="/Study-history/assets/js/36.ef19edf1.js"><link rel="prefetch" href="/Study-history/assets/js/37.0f9caf07.js"><link rel="prefetch" href="/Study-history/assets/js/38.2e4a8c9a.js"><link rel="prefetch" href="/Study-history/assets/js/39.46f87030.js"><link rel="prefetch" href="/Study-history/assets/js/4.c59777f9.js"><link rel="prefetch" href="/Study-history/assets/js/40.e1794eae.js"><link rel="prefetch" href="/Study-history/assets/js/42.caa5814b.js"><link rel="prefetch" href="/Study-history/assets/js/43.6cd8bb3f.js"><link rel="prefetch" href="/Study-history/assets/js/44.2442f75f.js"><link rel="prefetch" href="/Study-history/assets/js/45.9648c0bd.js"><link rel="prefetch" href="/Study-history/assets/js/46.de6e3a74.js"><link rel="prefetch" href="/Study-history/assets/js/47.72c2c6ba.js"><link rel="prefetch" href="/Study-history/assets/js/48.d5004b5b.js"><link rel="prefetch" href="/Study-history/assets/js/49.a2d1d664.js"><link rel="prefetch" href="/Study-history/assets/js/5.9b395665.js"><link rel="prefetch" href="/Study-history/assets/js/50.19b7d6c9.js"><link rel="prefetch" href="/Study-history/assets/js/51.a9a0da08.js"><link rel="prefetch" href="/Study-history/assets/js/52.e99771cc.js"><link rel="prefetch" href="/Study-history/assets/js/53.74e55a43.js"><link rel="prefetch" href="/Study-history/assets/js/54.c4ff7ebc.js"><link rel="prefetch" href="/Study-history/assets/js/55.acadfba7.js"><link rel="prefetch" href="/Study-history/assets/js/56.8fa49260.js"><link rel="prefetch" href="/Study-history/assets/js/57.08f5f4e4.js"><link rel="prefetch" href="/Study-history/assets/js/58.9d13dd4c.js"><link rel="prefetch" href="/Study-history/assets/js/6.d5fd31a3.js"><link rel="prefetch" href="/Study-history/assets/js/7.ec2eb6b8.js"><link rel="prefetch" href="/Study-history/assets/js/8.91dd34c9.js"><link rel="prefetch" href="/Study-history/assets/js/9.814e5587.js">
    <link rel="stylesheet" href="/Study-history/assets/css/0.styles.e2241fa8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Study-history/" class="home-link router-link-active"><!----> <span class="site-name">NorthUnicorn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Study-history/front/" class="nav-link router-link-active">front</a></div><div class="nav-item"><a href="/Study-history/houduan/" class="nav-link">back</a></div><div class="nav-item"><a href="/Study-history/devOps/" class="nav-link">devOps</a></div><div class="nav-item"><a href="/Study-history/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/Study-history/article/" class="nav-link">article</a></div><div class="nav-item"><a href="https://github.com/songge7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Study-history/front/" class="nav-link router-link-active">front</a></div><div class="nav-item"><a href="/Study-history/houduan/" class="nav-link">back</a></div><div class="nav-item"><a href="/Study-history/devOps/" class="nav-link">devOps</a></div><div class="nav-item"><a href="/Study-history/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/Study-history/article/" class="nav-link">article</a></div><div class="nav-item"><a href="https://github.com/songge7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>front</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/front/css.html" class="sidebar-link">css技巧汇总</a></li><li><a href="/Study-history/front/js.html" class="sidebar-link">js</a></li><li><a href="/Study-history/front/react.html" class="sidebar-link">react 汇总</a></li><li><a href="/Study-history/front/vue.html" class="sidebar-link">vue 汇总</a></li><li><a href="/Study-history/front/vuepress.html" class="sidebar-link">vuepress</a></li><li><a href="/Study-history/front/phone.html" class="sidebar-link">移动端</a></li><li><a href="/Study-history/front/webpack.html" class="active sidebar-link">webpack(基础)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#base" class="sidebar-link">base</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#个个击破" class="sidebar-link">个个击破</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#配置" class="sidebar-link">配置</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#webpack-源码入口分析" class="sidebar-link">webpack 源码入口分析</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#tapable分类" class="sidebar-link">tapable分类</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#ast-语法解析" class="sidebar-link">AST 语法解析</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#loader解析" class="sidebar-link">loader解析</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#plugin解析" class="sidebar-link">plugin解析</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#handwritewebapck" class="sidebar-link">handWriteWebapck</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#vue-ssr流程" class="sidebar-link">vue-ssr流程</a></li><li class="sidebar-sub-header"><a href="/Study-history/front/webpack.html#配置一个webpack-vue-支持ssr" class="sidebar-link">配置一个webpack-vue 支持ssr</a></li></ul></li><li><a href="/Study-history/front/video.html" class="sidebar-link">视频</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>js</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Study-history/front/jsBase.html" class="sidebar-link">js基础</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="webpack-基础"><a href="#webpack-基础" aria-hidden="true" class="header-anchor">#</a> webpack(基础)</h1> <p></p><div class="table-of-contents"><ul><li><a href="#base">base</a></li><li><a href="#个个击破">个个击破</a><ul><li><a href="#loader">loader?</a></li><li><a href="#处理html">处理html</a></li><li><a href="#处理css">处理css</a></li><li><a href="#rem2px">rem2px</a></li><li><a href="#在html中引入文件">在html中引入文件</a></li><li><a href="#处理图片">处理图片</a></li><li><a href="#压缩图片">压缩图片</a></li><li><a href="#处理字体">处理字体</a></li><li><a href="#处理js">处理js</a></li><li><a href="#css压缩-js压缩">css压缩&amp;&amp;js压缩</a></li><li><a href="#代码切割">代码切割</a></li></ul></li><li><a href="#配置">配置</a><ul><li><a href="#glob-查找目录的所有文件">glob 查找目录的所有文件</a></li><li><a href="#devtool-打包调试">devtool 打包调试</a></li><li><a href="#mode">mode</a></li><li><a href="#hash">hash</a></li><li><a href="#处理第三方库引用">处理第三方库引用</a></li><li><a href="#watch">watch</a></li><li><a href="#常用小插件">常用小插件</a></li><li><a href="#devserver">devServer</a></li><li><a href="#热更新">热更新</a></li><li><a href="#resolve">resolve</a></li><li><a href="#resolveloader">resolveLoader</a></li><li><a href="#noparse">noParse</a></li><li><a href="#defineplugin">DefinePlugin</a></li><li><a href="#ignoreplugin">IgnorePlugin</a></li><li><a href="#区分不同环境">区分不同环境</a></li><li><a href="#webpack-merge-拆分配置">webpack-merge 拆分配置</a></li><li><a href="#webpack-dev-middleware">webpack-dev-middleware</a></li><li><a href="#多入口mpa">多入口MPA</a></li><li><a href="#日志优化">日志优化</a></li><li><a href="#费时分析">费时分析</a></li><li><a href="#webpack-bundle-analyzer">webpack-bundle-analyzer</a></li><li><a href="#polyfill">polyfill</a></li><li><a href="#librarytarget-library">libraryTarget &amp;&amp; library</a></li><li><a href="#npm-发包">npm 发包</a></li><li><a href="#动态链接库dll">动态链接库DLL</a></li><li><a href="#tree-shaking">Tree Shaking</a></li><li><a href="#开启scope-hoisting-作用域提升">开启Scope Hoisting(作用域提升)</a></li><li><a href="#代码块-公开课-等源码看完再处理">代码块 (公开课,等源码看完再处理)</a></li><li><a href="#设置环境变量">设置环境变量</a></li></ul></li><li><a href="#webpack-源码入口分析">webpack 源码入口分析</a><ul><li><a href="#编译和启动">编译和启动</a></li><li><a href="#webpack的执行流程">webpack的执行流程</a></li><li><a href="#stats-对象">Stats 对象</a></li><li><a href="#import-动态引入-异步加载">import 动态引入(异步加载)</a></li><li><a href="#module-chunk-assets-关系">module chunk assets 关系</a></li><li><a href="#webpack的插件机制">webpack的插件机制</a></li></ul></li><li><a href="#tapable分类">tapable分类</a><ul><li><a href="#_1、synchook-串行同步执行-不关心返回值">1、SyncHook 串行同步执行,不关心返回值</a></li><li><a href="#_2、syncbailhook-串行同步执行，有一个返回值不为null则跳过剩下的逻辑">2、SyncBailHook 串行同步执行，有一个返回值不为null则跳过剩下的逻辑</a></li><li><a href="#_3、syncwaterfallhook-瀑布-上一个函数有返回值就会传递给下一个做参数">3、SyncWaterfallHook  瀑布 上一个函数有返回值就会传递给下一个做参数</a></li><li><a href="#_4、syncloophook-监听函数返回true表示继续循环，返回undefine表示结束循环">4、SyncLoopHook 监听函数返回true表示继续循环，返回undefine表示结束循环</a></li><li><a href="#_5、asyncparallelhook-异步并行执行钩子">5、AsyncParallelHook 异步并行执行钩子</a></li><li><a href="#_6、asyncparallelbailhook-带保险的异步并行执行钩子">6、AsyncParallelBailHook 带保险的异步并行执行钩子</a></li><li><a href="#_7、asyncserieshook-异步串行钩子">7、AsyncSeriesHook 异步串行钩子</a></li><li><a href="#_8、asyncseriesbailhook">8、AsyncSeriesBailHook</a></li><li><a href="#_9、asyncserieswaterfallhook">9、AsyncSeriesWaterfallHook</a></li><li><a href="#_10、tapable用法">10、tapable用法</a></li></ul></li><li><a href="#ast-语法解析">AST 语法解析</a><ul><li><a href="#转换箭头函数">转换箭头函数</a></li></ul></li><li><a href="#loader解析">loader解析</a><ul><li><a href="#loader运行的总体流程">loader运行的总体流程</a></li><li><a href="#loader类型">loader类型</a></li><li><a href="#用法准则">用法准则</a></li><li><a href="#获得-loader-的-options">获得 Loader 的 options</a></li><li><a href="#异步处理">异步处理</a></li><li><a href="#同步处理">同步处理</a></li><li><a href="#其他-api-https-webpack-js-org-api-loaders">其他API</a></li><li><a href="#loader实战">loader实战</a></li><li><a href="#pitch">pitch</a></li><li><a href="#loader-utils">loader-utils</a></li><li><a href="#_1、babel-loader">1、babel-loader</a></li><li><a href="#_2、banner-loader">2、banner-loader</a></li><li><a href="#_3、style-loader">3、style-loader</a></li><li><a href="#_4、css-loader">4、css-loader</a></li><li><a href="#exact-loader">exact-loader</a></li><li><a href="#file-loader">file-loader</a></li><li><a href="#url-loader">url-loader</a></li><li><a href="#sprite-loader">sprite-loader</a></li><li><a href="#px2rem-loader">px2rem-loader</a></li></ul></li><li><a href="#plugin解析">plugin解析</a><ul><li><a href="#创建插件">创建插件</a></li><li><a href="#compiler-和-compilation">Compiler 和 Compilation</a></li></ul></li><li><a href="#handwritewebapck">handWriteWebapck</a><ul><li><a href="#webpack流程概括">Webpack流程概括</a></li><li><a href="#安装依赖包">安装依赖包</a></li><li><a href="#_8、增加loader解析功能">8、增加loader解析功能</a></li><li><a href="#_9、增加plugin解析功能">9、增加plugin解析功能</a></li></ul></li><li><a href="#vue-ssr流程">vue-ssr流程</a></li><li><a href="#配置一个webpack-vue-支持ssr">配置一个webpack-vue 支持ssr</a><ul><li><a href="#创建webpack相关的文件">创建webpack相关的文件</a></li><li><a href="#components-bar-vue">/components/Bar.vue</a></li><li><a href="#components-foo-vue">/components/Foo.vue</a></li><li><a href="#app-js">App.js</a></li><li><a href="#router-js">router.js</a></li><li><a href="#store-js">store.js</a></li><li><a href="#main-js">main.js</a></li><li><a href="#client-js">client.js</a></li><li><a href="#server-js">server.js</a></li><li><a href="#node-server-js">node-server.js</a></li></ul></li></ul></div><p></p> <h2 id="base"><a href="#base" aria-hidden="true" class="header-anchor">#</a> base</h2> <ul><li>webacpk是啥
<ul><li>WebPack可以看做是模块打包机：它做的事情是，分析你的项目结构，找到JavaScript模块以及其它的一些浏览器不能直接运行的拓展语言（Scss，TypeScript等），并将其打包为合适的格式以供浏览器使用。</li></ul></li> <li>webpack核心成员
<ul><li>Entry 入口,入口文件</li> <li>Module 模块,一个文件对于一个模块,Webpack 会从配置的 Entry 开始递归找出所有依赖的模块。</li> <li>Chunk 代码块,一个 Chunk 由多个模块组合而成，用于代码合并与分割</li> <li>Loader 模块转换器,用于把模块原内容转换成新的内容</li> <li>Plugin 拓展插件,在webpack构建的生命周期中 注入拓展逻辑 来改变构建结果</li> <li>Output 输出结果</li></ul></li> <li>webpack 基本搭建(基于webpack4)
<ul><li>npm install webpack webpack-cli -D</li> <li>创建src目录和dist/index.html(里面引入打包后的文件)</li> <li>创建webpack.config.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> htmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    mode<span class="token punctuation">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>
    entry<span class="token punctuation">:</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    output<span class="token punctuation">:</span><span class="token punctuation">{</span>
      path<span class="token punctuation">:</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      filename<span class="token punctuation">:</span><span class="token string">'[name].js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">htmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        template<span class="token punctuation">:</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token punctuation">:</span><span class="token string">'index.html'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="个个击破"><a href="#个个击破" aria-hidden="true" class="header-anchor">#</a> 个个击破</h2> <h3 id="loader"><a href="#loader" aria-hidden="true" class="header-anchor">#</a> loader?</h3> <ul><li>通过使用不同的Loader,Webpack可以要把不同的文件都转成JS文件,比如CSS、ES6/7、JSX等</li> <li>test:正则匹配 拓展名</li> <li>use:loader名称</li> <li>include/exclude:屏蔽或者包含处理的文件夹</li> <li>query 为loader提供额外的设置选项</li> <li>四种写法<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// loader </span>
<span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token regex">/\.css/</span><span class="token punctuation">,</span>
  loader<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// use</span>
<span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token regex">/\.css/</span><span class="token punctuation">,</span>
  use<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// use+loader</span>
<span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token regex">/\.css/</span><span class="token punctuation">,</span>
  include<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
  use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      loader<span class="token punctuation">:</span> <span class="token string">'style-loader'</span><span class="token punctuation">,</span>
      options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          insertAt<span class="token punctuation">:</span><span class="token string">'top'</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// 行内loader </span>
<span class="token keyword">import</span> <span class="token string">'style-loader!css-loader!./index.css'</span>
</code></pre></div></li></ul> <h3 id="处理html"><a href="#处理html" aria-hidden="true" class="header-anchor">#</a> 处理html</h3> <div class="language-js extra-class"><pre class="language-js"><code>  npm i html<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span><span class="token constant">D</span>

  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token punctuation">:</span> <span class="token string">'./src/index.html'</span><span class="token punctuation">,</span> <span class="token comment">// 指定的模板名字</span>
    filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span> <span class="token comment">// 产出的文件名</span>
    hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 为了避免缓存,可以在产出的资源后面添加hash值</span>
    chunks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'common'</span><span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//引入多个js文件 默认是乱序, 要加入的配置(manual 手动) 才安排数组顺序加入</span>
    chunksSortMode<span class="token punctuation">:</span> <span class="token string">'manual'</span><span class="token punctuation">,</span> <span class="token comment">// 对引入代码块进行排序 </span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div> <h3 id="处理css"><a href="#处理css" aria-hidden="true" class="header-anchor">#</a> 处理css</h3> <ul><li>mini-css-extract-plugin 将css单独提取出来 link自动引入
<ul><li>filename 打包入口文件</li> <li>chunkFilename 用来打包import('module')方法中引入的模块</li> <li>参考 js 异步加载 类似</li></ul></li> <li>style-loader 将文件引入(内连)</li> <li>css-loader 的作用是处理css中的 @import 和 url 这样的外部资源</li> <li>less-loader less/node-sass sass-loader 处理sass和less</li> <li><code>purgecss-webpack-plugin glob</code>,一般与 glob、glob-all 配合使用, 必须和 mini-css-extract-plugin配合使用,可以去除未使用的 css
<ul><li>注意:使用的时候 一般是处理 js 里面的样式文件  html 模板里面的处理不了</li></ul></li> <li>postcss-loader autoprefixer 增加前缀
<ul><li>用法</li> <li>在处理css 里面增加一个<code>postcss-loader</code>处理器</li> <li>第二个增加一个配置文件 postcss.config.js 或者用 options添加配置</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> purgecssWebpackPlugin <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'purgecss-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> MiniCssExtractPlugin <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mini-css-extract-plugin'</span><span class="token punctuation">)</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token comment">//参数类似于webpackOptions.output</span>
      <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          filename<span class="token punctuation">:</span> <span class="token string">'[name].css'</span><span class="token punctuation">,</span>
          chunkFilename<span class="token punctuation">:</span><span class="token string">'[id].css'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    <span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.css/</span><span class="token punctuation">,</span>
      include<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token punctuation">:</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'less-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.scss$/</span><span class="token punctuation">,</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'sass-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 增加前缀</span>
    <span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span> <span class="token comment">// 如果用到import 或者 require 文件 是css</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'postcss-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// postcss.config.js</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
      plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'autoprefixer'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">new</span> <span class="token class-name">purgecssWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      paths<span class="token punctuation">:</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**/*`</span></span> <span class="token punctuation">,</span><span class="token punctuation">{</span>nodir<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">// 不匹配目录，只匹配文件</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="rem2px"><a href="#rem2px" aria-hidden="true" class="header-anchor">#</a> rem2px</h3> <ul><li>rem2px <code>px2rem-loader lib-flexible</code> <ul><li>计算 font-size</li> <li>这个逻辑代码 尽量放到head 标签中 在页面绘制前加载</li> <li>remUnit 配置 代表页面 1rem 是多少 物理像素  通常将页面划分10个rem 所以这里一般是页面的宽度的十分之一</li> <li>dpr 指物理像素(手机像素)比逻辑像素(css像素)</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  test<span class="token punctuation">:</span><span class="token regex">/\.css/</span><span class="token punctuation">,</span>
  use<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    loader<span class="token punctuation">:</span><span class="token string">'px2rem-loader'</span><span class="token punctuation">,</span>
    options<span class="token punctuation">:</span><span class="token punctuation">{</span>
      remUnit<span class="token punctuation">:</span><span class="token number">75</span><span class="token punctuation">,</span><span class="token comment">//1個rem是75像素 若宽度是375px 则被转换成5</span>
      remPrecesion<span class="token punctuation">:</span><span class="token number">8</span><span class="token comment">//rem的精度 保留8位</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> docEle <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement
<span class="token keyword">function</span> <span class="token function">setRemUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// docEle.style.fontSize = docEle.clientWidth/5 + 'px'</span>
  docEle<span class="token punctuation">.</span>style<span class="token punctuation">.</span>fontSize <span class="token operator">=</span> <span class="token string">'10vw'</span>
<span class="token punctuation">}</span>
<span class="token function">setRemUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span>setRemUnit<span class="token punctuation">)</span>
</code></pre></div><h3 id="在html中引入文件"><a href="#在html中引入文件" aria-hidden="true" class="header-anchor">#</a> 在html中引入文件</h3> <ul><li>在html中引入文件 他会通过 html-webpack-plugin 转换 这里可以通过固定的语法 加载<code>${}</code> <ul><li><code>raw-loader</code>加载文件原始内容</li></ul></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 引入html文件 --&gt;</span>
  ${require('raw-loader!./mate.html').default}
  <span class="token comment">&lt;!-- 引入css文件 !!是忽略其他loader处理 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">$</span><span class="token punctuation">{</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'!!raw-loader!./inline.css'</span><span class="token punctuation">)</span>.default<span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// html-webpack-plugin 能识别${}</span>
    <span class="token comment">// 源文件交给raw-loader(行内loader)处理</span>
    <span class="token comment">// raw-loader 加载文件原始内容</span>
    $<span class="token punctuation">{</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'raw-loader!../node_modules/lib-flexible/flexible.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">}</span> 
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="处理图片"><a href="#处理图片" aria-hidden="true" class="header-anchor">#</a> 处理图片</h3> <ul><li>file-loader 将图片复制到打包文件内 生成一个新的图片名字</li> <li>url-loader 内置了file-loader 添加配置 如果图片小于limit 他会变成base64字符串</li> <li>html-withimg-loader 在html中使用图片</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  test<span class="token punctuation">:</span><span class="token regex">/\.(jpg|png|bmp|gif|svg|ttf|woff|woff2|eot)/</span><span class="token punctuation">,</span>
    use<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      loader<span class="token punctuation">:</span><span class="token string">'url-loader'</span><span class="token punctuation">,</span>
      options<span class="token punctuation">:</span><span class="token punctuation">{</span>
        limit<span class="token punctuation">:</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">,</span>
        <span class="token comment">// name 修改名字 可以处理路径</span>
        name<span class="token punctuation">:</span><span class="token string">'img/[name].[hash].[ext]'</span><span class="token punctuation">,</span>
        <span class="token comment">// outputPath 专门处理路径</span>
        outputPath<span class="token punctuation">:</span> <span class="token string">'images'</span><span class="token punctuation">,</span>
        publicPath<span class="token punctuation">:</span><span class="token string">'../images'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token regex">/\.(html|htm)$/</span><span class="token punctuation">,</span>
  use<span class="token punctuation">:</span> <span class="token string">'html-withimg-loader'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="压缩图片"><a href="#压缩图片" aria-hidden="true" class="header-anchor">#</a> 压缩图片</h3> <ul><li><code>image-webpack-loader</code>可以帮助我们对图片进行压缩和优化(image-webpack-loader windows下载有问题)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token regex">/\.(png|svg|jpg|gif|jpeg|ico)$/</span><span class="token punctuation">,</span>
  use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">'file-loader'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token punctuation">:</span> <span class="token string">'image-webpack-loader'</span><span class="token punctuation">,</span>
      options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        mozjpeg<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          progressive<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          quality<span class="token punctuation">:</span> <span class="token number">65</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// optipng.enabled: false will disable optipng</span>
        optipng<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          enabled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        pngquant<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          quality<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.65</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          speed<span class="token punctuation">:</span> <span class="token number">4</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        gifsicle<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          interlaced<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// the webp option will enable WEBP</span>
        webp<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          quality<span class="token punctuation">:</span> <span class="token number">75</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="处理字体"><a href="#处理字体" aria-hidden="true" class="header-anchor">#</a> 处理字体</h3> <ul><li>配置loader</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
 test<span class="token punctuation">:</span><span class="token regex">/\.(woff|ttf|eot|svg|otf)$/</span><span class="token punctuation">,</span>
     use<span class="token punctuation">:</span><span class="token punctuation">{</span>
        loader<span class="token punctuation">:</span><span class="token string">'url-loader'</span><span class="token punctuation">,</span>
        options<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token comment">//如果要加载的图片大小小于10K的话，就把这张图片转成base64编码内嵌到html网页中去</span>
          limit<span class="token punctuation">:</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">,</span>
          outputPath<span class="token punctuation">:</span> <span class="token string">'images'</span><span class="token punctuation">,</span>
          publicPath<span class="token punctuation">:</span><span class="token string">'../images'</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>使用字体文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>@font<span class="token operator">-</span>face <span class="token punctuation">{</span>
    src<span class="token punctuation">:</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'./fonts/HabanoST.otf'</span><span class="token punctuation">)</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'truetype'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    font<span class="token operator">-</span>family<span class="token punctuation">:</span> <span class="token string">'HabanoST'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>welcome <span class="token punctuation">{</span>
    font<span class="token operator">-</span>size<span class="token punctuation">:</span><span class="token number">100</span>px<span class="token punctuation">;</span>
    font<span class="token operator">-</span>family<span class="token punctuation">:</span> <span class="token string">'HabanoST'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="处理js"><a href="#处理js" aria-hidden="true" class="header-anchor">#</a> 处理js</h3> <ul><li><p>cnpm i -D babel-loader @babel/core @babel/preset-react @babel/preset-env</p></li> <li><p>cnpm i -D @babel/plugin-proposal-decorators @babel/plugin-proposal-class-properties</p></li> <li><p>@ 代表一类库</p></li> <li><p>配置有两种写法 下面是options配置 还可以创建一个.babelrc文件 将options里的对象 复制过</p></li> <li><p><code>cnpm i -S @babel/plugin-transform-runtime @babel/runtime</code>  @babel/plugin-transform-runtime 是插件 他会依赖@babel/runtime</p></li> <li><p>options 里面内容尽量放到 .babelrc文件 测试 不然会报错(测试)</p></li> <li><p>eslint 处理代码校验 <code>cnpm i eslint eslint-loader babel-eslint -D</code>  配合vscode插件<code>eslint</code>保存自动处理代码</p></li> <li><p>eslint 配合 vscode 就可以对单个js文件直接进行代码检查不需要webpack</p> <ul><li>eslintrc 需要安裝的库 <code>cnpm i eslint eslint-loader babel-eslint eslint-config-airbnb -D</code></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vscode setting配置</span>
    <span class="token comment">// #每次保存的时候自动格式化 他eslint保存 还有点冲突(格式化代码的时候 会把最后一行空格删除,eslint 需要保存这一行)</span>
    <span class="token string">&quot;editor.formatOnSave&quot;</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token comment">// #每次保存的时候将代码按eslint格式进行修复</span>
    <span class="token string">&quot;editor.codeActionsOnSave&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;source.fixAll.eslint&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// .eslintrc.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    parser<span class="token punctuation">:</span> <span class="token string">&quot;babel-eslint&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 把源码转成语法树的工具</span>
    <span class="token keyword">extends</span><span class="token punctuation">:</span> <span class="token string">&quot;airbnb&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 继承airbnb规则</span>
    env<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 指定运行环境</span>
        browser<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        node<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;linebreak-style&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;off&quot;</span><span class="token punctuation">,</span>
        indent<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 缩进风格</span>
        quotes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;double&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 引号类型</span>
        semi<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;always&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 关闭语句强制分号结尾</span>
        <span class="token string">&quot;no-console&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 禁止使用console</span>
        <span class="token string">&quot;arrow-parens&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 箭头函数用小括号括起来</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>eslint 是核心库 eslint-loader loader作用 babel-eslint 转义高级语法</li> <li>创建配置文件 .eslintrc.js</li> <li><a href="https://github.com/airbnb/javascript/tree/master/packages/eslint-config-airbnb" target="_blank" rel="noopener noreferrer">eslint-config-airbnb<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>airbnb需要的 <code>cnpm i eslint-config-airbnb eslint-loader eslint eslint-plugin-import eslint-plugin-react eslint-plugin-react-hooks and eslint-plugin-jsx-a11y -D</code></li> <li>安裝好 eslint 插件 和 配置 .eslintrc.js文件 不需要开启webpack就可以代码修复</li> <li>在.eslintrc.js文件配置和可以eslint插件一起使用  在webpack里面loader 内配置 仅仅在是 打包的时候 用</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    test<span class="token punctuation">:</span> <span class="token regex">/\.jsx?$/</span><span class="token punctuation">,</span>
    use<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
        options<span class="token punctuation">:</span><span class="token punctuation">{</span>
         <span class="token string">&quot;presets&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;@babel/preset-react&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token string">&quot;plugins&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span><span class="token string">&quot;@babel/plugin-proposal-decorators&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">&quot;legacy&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">&quot;@babel/plugin-proposal-class-properties&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">&quot;loose&quot;</span> <span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
         <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    include<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exclude<span class="token punctuation">:</span><span class="token regex">/node_modules/</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
  use<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
    options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;presets&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment">// 插件的集合</span>
        <span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span> <span class="token comment">//转义ES6 ES7</span>
        <span class="token string">&quot;@babel/preset-react&quot;</span><span class="token punctuation">,</span> <span class="token comment">//转义 jsx语法</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">&quot;plugins&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment">// 每个插件代表一个规则 需要传递参数 就写成数组</span>
        <span class="token punctuation">[</span><span class="token string">&quot;@babel/plugin-proposal-decorators&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> legacy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">// 处理装饰器语法</span>
        <span class="token punctuation">[</span><span class="token string">&quot;@babel/plugin-proposal-class-properties&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> loose<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//处理类的属性 </span>
        <span class="token comment">// loose松散模式 </span>
        <span class="token punctuation">[</span><span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
              corejs<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
              helpers<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
              regenerator<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
              useESModules<span class="token punctuation">:</span><span class="token boolean">true</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
class A{
    static a=1
}
let a = new A()
console.log('index111',a,A.a)
*/</span>
<span class="token punctuation">{</span>
  loader<span class="token punctuation">:</span><span class="token string">'eslint-loader'</span><span class="token punctuation">,</span>
  include<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./src'</span><span class="token punctuation">)</span>
  <span class="token comment">// exclude: /node_modules/</span>
<span class="token punctuation">}</span>
<span class="token comment">//.eslintrc</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;parser&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;babel-eslint&quot;</span><span class="token punctuation">,</span><span class="token comment">// 把源码转成语法树的工具</span>
  <span class="token string">&quot;extends&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;airbnb&quot;</span><span class="token punctuation">,</span><span class="token comment">// 继承airbnb规则</span>
  env<span class="token punctuation">:</span><span class="token punctuation">{</span> <span class="token comment">//指定运行环境</span>
    browser<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    node<span class="token punctuation">:</span><span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  rules<span class="token punctuation">:</span><span class="token punctuation">{</span>
    <span class="token string">&quot;linebreak-style&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;off&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;indent&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//缩进风格</span>
    <span class="token string">&quot;quotes&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;double&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//引号类型 </span>
    <span class="token string">&quot;semi&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;always&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//关闭语句强制分号结尾</span>
    <span class="token string">&quot;no-console&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token comment">//禁止使用console</span>
    <span class="token string">&quot;arrow-parens&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">//箭头函数用小括号括起来</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="css压缩-js压缩"><a href="#css压缩-js压缩" aria-hidden="true" class="header-anchor">#</a> css压缩&amp;&amp;js压缩</h3> <ul><li>mode设置<code>development</code>是不压缩的,<code>production</code>打包的时候自动压缩</li> <li>用terser-webpack-plugin替换掉uglifyjs-webpack-plugin解决uglifyjs不支持es6语法问题</li> <li>注意项 mode必须设置production,此外配置了optimization选项原有的js 在production 打包压缩会失效,要手动引起插件开启</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> TerserPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'terser-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 压缩js</span>
<span class="token keyword">const</span> OptimizeCSSAssetsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;optimize-css-assets-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 压缩css</span>
  
  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 这里放优化的内容</span>
    minimizer<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment">//表示放优化的插件</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        include<span class="token punctuation">:</span><span class="token regex">/\.min\.js/</span><span class="token punctuation">,</span>对那些文件压缩
       
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">OptimizeCSSAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        assetNameRegExp<span class="token punctuation">:</span><span class="token regex">/\.min\.css/</span><span class="token punctuation">,</span>对那些文件压缩
        parallel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//开启多进程并进行压缩</span>
        cache<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//开启缓存</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="代码切割"><a href="#代码切割" aria-hidden="true" class="header-anchor">#</a> 代码切割</h3> <div class="language-js extra-class"><pre class="language-js"><code> optimization<span class="token punctuation">:</span><span class="token punctuation">{</span>
    splitChunks<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token comment">//分隔代码块</span>
      cacheGroups<span class="token punctuation">:</span><span class="token punctuation">{</span>
        vendor<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token comment">//打包第三方</span>
          chunks<span class="token punctuation">:</span><span class="token string">'initial'</span><span class="token punctuation">,</span><span class="token comment">//指定分隔的类型,默认有3中选项 all async initial</span>
          name<span class="token punctuation">:</span><span class="token string">'vendors'</span><span class="token punctuation">,</span><span class="token comment">// 给分隔出去的代码块 起一个名字 vendors</span>
          test<span class="token punctuation">:</span><span class="token regex">/node_modules/</span><span class="token punctuation">,</span><span class="token comment">//如果模块ID匹配这个正则的话,就会添加到vendors代码块中</span>
          priority<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token comment">//优先级</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        commons<span class="token punctuation">:</span><span class="token punctuation">{</span>
          chunks<span class="token punctuation">:</span><span class="token string">'initial'</span><span class="token punctuation">,</span>
          name<span class="token punctuation">:</span><span class="token string">'commons'</span><span class="token punctuation">,</span>
          minSize<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//最小提取的字节</span>
          minChunks<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token comment">// 最少被几个chunk引用需要提取</span>
          priority<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">20</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="配置"><a href="#配置" aria-hidden="true" class="header-anchor">#</a> 配置</h2> <h3 id="glob-查找目录的所有文件"><a href="#glob-查找目录的所有文件" aria-hidden="true" class="header-anchor">#</a> glob 查找目录的所有文件</h3> <ul><li>cnpm i -S glob</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span>

<span class="token comment">// glob.sync(`${path.join(__dirname,'src')}/**/*` ,{nodir:true})// 不匹配目录，只匹配文件</span>
<span class="token keyword">let</span> rs <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'./src/**/*.{js,gif}'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span> <span class="token comment">//返回src目录下所有的js和gif文件 不管多少层目录</span>
</code></pre></div><h3 id="devtool-打包调试"><a href="#devtool-打包调试" aria-hidden="true" class="header-anchor">#</a> devtool 打包调试</h3> <ul><li>sourcemap 性能最差,效果最好,会生成一个source-map文件 能定位到行和列
<ul><li>不能缓存source-map文件,每次编译都会生成新的代码块文件,在生成环境下会影响性能</li> <li>source-map生成配置文件 mappings里面的数据就是一个代码映射</li></ul></li> <li>eval 用最好的性能,但是只能映射到编译后的代码 主要是把编译前和后的代码关联起来
<ul><li>生成代码 每个模块都被eval执行 进行缓存，并且存在 sourceURL 映射到对应的源码路径(dev启动服务),带eval的构建模式能cache SourceMap</li> <li>1、不需要生成单独的source-map文件</li> <li>2、eval代码包裹起来代码可以缓存</li></ul></li> <li>cheap(廉价的)
<ul><li>不包含列表信息</li> <li>cheap-source-map 定位到行 但是是编译后的文件(babel 处理后的，不包含loader等)</li></ul></li> <li>module
<ul><li>包含loader的source-map(比如jsx to js,babel的source-map,源文件显示需要babel等loader处理,打包后的都是不需要loader处理的),否则无法定义源文件</li> <li>cheap-module-source-map 定位到行 显示的源文件的代码</li></ul></li> <li>inline
<ul><li>不会生成单独的source-map文件 将.map作为DataURL(base64)嵌入 到打包文件内</li></ul></li></ul> <h3 id="mode"><a href="#mode" aria-hidden="true" class="header-anchor">#</a> mode</h3> <ul><li>production 默认会压缩js css不会压缩 要开启 optimization选项优化</li> <li>development 不会压缩</li> <li>none 啥都没</li> <li>两种设置的方式</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">1</span>、在webpack mode赋值
<span class="token number">2</span>、在<span class="token keyword">package</span><span class="token punctuation">.</span>json配置
<span class="token string">&quot;build:dev&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack  --mode development&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;build:prod&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack  --mode production&quot;</span>
</code></pre></div><h3 id="hash"><a href="#hash" aria-hidden="true" class="header-anchor">#</a> hash</h3> <ul><li>hash
<ul><li>代表本次编译,每次编译一次,hash会变, 所有文件的hash都一样 默认是32位</li></ul></li> <li>chunkhash
<ul><li>一个chunk代表一组模块(也就是对应着一个打包后的入口文件) 只要模块内只一个文件 发生变化 chunkhash就会变</li> <li>如果 output 用chunkhash 那么 他生的文件  chunkhash值不一样<code>不建议</code></li> <li>当css 和 js 同时打包到一个js文件内,js 发生变化 chunkhash 会跟着变化,但是 contenthash 不会变化</li></ul></li> <li>contenthash
<ul><li>指单个文件内容变化 他才变化</li></ul></li> <li>注意  output filename/html 输出文件 只能用单独使用3个hash中的一种  因为 contenthash 指的是单个文件,contenthash会有很多，而filename/html是产出的是一个大文件,同样chunkhash 也是由多个文件组成</li></ul> <h3 id="处理第三方库引用"><a href="#处理第三方库引用" aria-hidden="true" class="header-anchor">#</a> 处理第三方库引用</h3> <ul><li>1、那个页面需要 直接只用</li> <li>2、类似<code>lodash</code>&amp;&amp;<code>jquery</code>库 很多地方都能用到 可以配置全局里面
<ul><li>webpack配置ProvidePlugin后，在使用时将不再需要import和require进行引入，直接使用即可</li> <li>函数会自动添加到当前模块的上下文，无需显示声明</li> <li>这种注入模块相当于向模块内部注入了一个局部变量</li></ul></li> <li>3、通过<code>expose-loader</code>暴露插件</li> <li>引入了第三方库又不想打包
<ul><li>1、externals 通过script 每个页面引入模块 同时在用externals给他处理</li> <li>2、<code>html-webpack-externals-plugin</code>插件处理 通过引入cnd ,注意此插件要放到  htmlWebpackPlugin 后面</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'@'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2</span>
<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    _<span class="token punctuation">:</span><span class="token string">'lodash'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 3</span>
<span class="token comment">// ?是传参  !是分隔loader 和 原模块</span>
<span class="token keyword">import</span> <span class="token string">&quot;expose-loader?$!jquery&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 或者</span>
<span class="token punctuation">{</span> 
  test<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;jquery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  loader<span class="token punctuation">:</span> <span class="token string">&quot;expose-loader?jQuery&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4、通过cdn 又想用import 语法 就要externals 配置</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span>
externals<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  jquery<span class="token punctuation">:</span> <span class="token string">'jQuery'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// 5、通过插件  在页面中引入$模块即可使用</span>
<span class="token keyword">new</span> <span class="token class-name">htmlWebpackExternalsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  externals<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      module<span class="token punctuation">:</span><span class="token string">'$'</span><span class="token punctuation">,</span><span class="token comment">//页面引入模块的名字</span>
      entry<span class="token punctuation">:</span><span class="token string">'https://cdn.bootcss.com/jquery/3.4.1/jquery.js'</span><span class="token punctuation">,</span>
      global<span class="token punctuation">:</span><span class="token string">'jQuery'</span><span class="token punctuation">,</span><span class="token comment">//从全局对象的那个属性上获取导出的值</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="watch"><a href="#watch" aria-hidden="true" class="header-anchor">#</a> watch</h3> <ul><li>当代码发生修改后可以自动重新编译</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//默认false,也就是不开启</span>
  watch<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">//只有开启监听模式时，watchOptions才有意义</span>
  watchOptions<span class="token punctuation">:</span><span class="token punctuation">{</span>
      <span class="token comment">//默认为空，不监听的文件或者文件夹，支持正则匹配</span>
      ignored<span class="token punctuation">:</span><span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
      <span class="token comment">//监听到变化发生后会等300ms再去执行，默认300ms</span>
      aggregateTimeout<span class="token punctuation">:</span><span class="token number">300</span><span class="token punctuation">,</span>
      <span class="token comment">//判断文件是否发生变化是通过不停的询问文件系统指定议是有变化实现的，默认每秒问1000次</span>
      poll<span class="token punctuation">:</span><span class="token number">1000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="常用小插件"><a href="#常用小插件" aria-hidden="true" class="header-anchor">#</a> 常用小插件</h3> <ul><li>添加商标</li> <li>拷贝静态文件 <code>copy-webpack-plugin</code></li> <li>情况 <code>clean-webpack-plugin</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>BannerPlugin</span><span class="token punctuation">(</span><span class="token string">'测试11'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token class-name">CopyWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token keyword">from</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'src/assets'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//静态资源目录源地址</span>
  to<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist/assets'</span><span class="token punctuation">)</span> <span class="token comment">//目标地址，相对于output的path目录</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>cleanOnceBeforeBuildPatterns<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'**/*'</span><span class="token punctuation">,</span> <span class="token string">'!static-files*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="devserver"><a href="#devserver" aria-hidden="true" class="header-anchor">#</a> devServer</h3> <ul><li><code>webpack-dev-server</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 如果你使用了devServer那么所有产出的文件都会写到内存里,而不是写入到硬盘上,主要是为了速度</span>
  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    contentBase<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 指定开启那个目录</span>
    port<span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span><span class="token string">'localhost'</span><span class="token punctuation">,</span>
    compress<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//相当于启动gzip压缩</span>
    <span class="token comment">// before 是一个钩子 此钩子会在web-dev-server启动之前执行</span>
    <span class="token function">before</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 可以通过localhost:8080/users 直接访问到</span>
      app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>name<span class="token punctuation">:</span><span class="token string">'zzzz'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    proxy<span class="token punctuation">:</span><span class="token punctuation">{</span>
      <span class="token comment">// &quot;/api&quot;:&quot;http://localhost:3000&quot;,//这个情况是 访问 localhost:8080/api/users =&gt;映射到 localhost:3000/api/users</span>
      <span class="token string">&quot;/api&quot;</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
        target<span class="token punctuation">:</span><span class="token string">&quot;http://localhost:3000&quot;</span><span class="token punctuation">,</span>
        pathRewrite<span class="token punctuation">:</span><span class="token punctuation">{</span>
          <span class="token string">&quot;^/api&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token comment">// api开头的 改为空</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">// 这种情况是  访问 localhost:8080/api/users =&gt;映射到 localhost:3000/users</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="热更新"><a href="#热更新" aria-hidden="true" class="header-anchor">#</a> 热更新</h3> <ul><li>配置hot
<ul><li>DevServer 默认不会开启模块热替换模式，要开启该模式，只需在启动时带上参数 --hot</li> <li>cnpm i webpack@4.39.1 webpack-cli@3.3.6 webpack-dev-server@3.7.2 mime html-webpack-plugin express socket.io -S</li> <li>若配置不上 就删掉第三方库重新单独下载测试</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>devServer<span class="token punctuation">:</span><span class="token punctuation">{</span>
  <span class="token comment">// 告诉 DevServer 要开启模块热替换模式</span>
  hot<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      
<span class="token punctuation">}</span>  
plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
  <span class="token comment">// new webpack.NamedModulesPlugin(), // 用于启动 HMR 时可以显示模块的相对路径</span>
  <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Hot Module Replacement 的插件</span>
<span class="token punctuation">]</span>

<span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>fun2<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./func'</span>
<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> result
<span class="token comment">// 只有当开启了模块热替换时 module.hot 才存在</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// accept 函数的第一个参数指出当前文件接受哪些子模块的替换，这里表示只接受 ./AppComponent 这个子模块</span>
  <span class="token comment">// 第2个参数用于在新的子模块加载完毕后需要执行的逻辑</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./func.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新的 AppComponent 加载成功后重新执行下组建渲染逻辑</span>
    <span class="token keyword">let</span> func <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./func'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> rs <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> rs
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// func.js</span>
<span class="token keyword">function</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'func231'</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'fu1111111111122'</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  fun1<span class="token punctuation">,</span>
  fun2
<span class="token punctuation">}</span>

<span class="token comment">// react例子</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./index.css'</span><span class="token punctuation">;</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 只有当开启了模块热替换时 module.hot 才存在</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// accept 函数的第一个参数指出当前文件接受哪些子模块的替换，这里表示只接受 ./AppComponent 这个子模块</span>
  <span class="token comment">// 第2个参数用于在新的子模块加载完毕后需要执行的逻辑</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./App'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新的 AppComponent 加载成功后重新执行下组建渲染逻辑</span>
    <span class="token keyword">let</span> App<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./App'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>  
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="resolve"><a href="#resolve" aria-hidden="true" class="header-anchor">#</a> resolve</h3> <ul><li>文件查找规则,指定extension之后可以不用在 require 或者 import的时候加扩展名,会依次尝试添加扩展名进行匹配</li> <li>alias 配置别名</li> <li>modules 查找模块</li> <li>mainFields 默认情况下package.json 文件则按文件中main 字段的文件名来查找</li> <li>mainFiles 当目录下没有package.json文件,我们说会默认使用目录下的index.js文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>resolve<span class="token punctuation">:</span><span class="token punctuation">{</span>
<span class="token comment">// 按顺序 先找.js 在往后找</span>
  extension<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span><span class="token string">'.jsx'</span><span class="token punctuation">,</span><span class="token string">'.json'</span><span class="token punctuation">,</span><span class="token string">'.css'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token comment">//  配置别名 import bootstrap 直接找后面的文件</span>
  alias<span class="token punctuation">:</span><span class="token punctuation">{</span>
    <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&quot;node_modules/bootstrap/dist/css/bootstrap.css&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'components'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// import rs from 'components/data.js' ==&gt;定位到path.join(__dirname,'src','data.js')</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 第一个是减少查找路径 增快查找速度 第二个是添加额外额查找路径 只有是引入的时候 不添加路径 直接写包名</span>
  modules<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span><span class="token string">'zfmoudle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  mainFields<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'browser'</span><span class="token punctuation">,</span><span class="token string">'module'</span><span class="token punctuation">,</span><span class="token string">'main'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  mainFiles<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="resolveloader"><a href="#resolveloader" aria-hidden="true" class="header-anchor">#</a> resolveLoader</h3> <ul><li>用于配置解析 loader 时的 resolve 配置,和文件查找的resolve配置差不多 这个一般是配置自己写的loader</li></ul> <div class="language-js extra-class"><pre class="language-js"><code> resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span>
   <span class="token comment">// 第三方模块默认 查找的位子</span>
    modules<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    extensions<span class="token punctuation">:</span><span class="token punctuation">[</span> <span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 配置别名</span>
    alias<span class="token punctuation">:</span><span class="token punctuation">{</span>
      <span class="token comment">// 在loader中使用 loader1 就指向 __dirname/loaders/loaders1.js</span>
      loader1<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'loaders'</span><span class="token punctuation">,</span><span class="token string">'loaders1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    mainFields<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'loader'</span><span class="token punctuation">,</span> <span class="token string">'main'</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="noparse"><a href="#noparse" aria-hidden="true" class="header-anchor">#</a> noParse</h3> <ul><li>module.noParse 字段，可以用于配置哪些模块文件的内容不需要进行解析</li> <li>不需要解析依赖（即无依赖） 的第三方大型类库等，可以通过这个字段来配置，以提高整体的构建速度</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// jquery lodash都是不需要依赖别的库</span>
module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  noParse<span class="token punctuation">:</span> <span class="token regex">/jquery|lodash/</span><span class="token punctuation">,</span> <span class="token comment">// 正则表达式</span>
  <span class="token comment">// 或者使用函数</span>
  <span class="token function">noParse</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">/</span>jquery<span class="token operator">|</span>lodash<span class="token operator">/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="defineplugin"><a href="#defineplugin" aria-hidden="true" class="header-anchor">#</a> DefinePlugin</h3> <ul><li>DefinePlugin创建一些在编译时可以配置的全局常量</li> <li>如果配置的值是字符串，那么整个字符串会被当成代码片段来执行，其结果作为最终变量的值</li> <li>如果配置的值不是字符串，也不是一个对象字面量，那么该值会被转为一个字符串，如 true，最后的结果是 'true'</li> <li>如果配置的是一个对象字面量，那么该对象的所有 key 会以同样的方式去定义</li> <li>JSON.stringify(true) 的结果是 'true'</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token constant">PRODUCTION</span><span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">VERSION</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token constant">EXPRESSION</span><span class="token punctuation">:</span> <span class="token string">&quot;1+2&quot;</span><span class="token punctuation">,</span>
    <span class="token constant">COPYRIGHT</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token constant">AUTHOR</span><span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">&quot;测试11&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="ignoreplugin"><a href="#ignoreplugin" aria-hidden="true" class="header-anchor">#</a> IgnorePlugin</h3> <ul><li>IgnorePlugin用于忽略某些特定的模块，让 webpack 不把这些指定的模块打包进去</li> <li>第一个是匹配引入模块路径的正则表达式</li> <li>第二个是匹配模块的对应上下文，即所在目录名</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 使用moment的时候  所有的语言包可以引入了 给可以给他忽略 在手动引入所需要的语言 --&gt;</span>
  <span class="token comment">// js中</span>
  <span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">'moment'</span><span class="token punctuation">;</span>
  <span class="token comment">//手动引入所需要的语言</span>
  <span class="token keyword">import</span> <span class="token string">'moment/locale/zh-cn'</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
  plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorePlugin</span><span class="token punctuation">(</span><span class="token string">'/\.\/locale/'</span><span class="token punctuation">,</span><span class="token regex">/moment/</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
</code></pre></div><h3 id="区分不同环境"><a href="#区分不同环境" aria-hidden="true" class="header-anchor">#</a> 区分不同环境</h3> <ul><li>设置环境变量</li> <li>这个不会影响 mode 也就是不会改变打包的结果</li> <li>webpack.config.js 配置文件 可以是对应 同样也可以是函数,函数里面有2个参数第一个就是env环境变量 第二个是所有的参数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;build:dev&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack  --env=development&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;build:prod&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack  --env=production&quot;</span>

<span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">env<span class="token punctuation">,</span>argv</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mode<span class="token punctuation">:</span>env<span class="token punctuation">,</span><span class="token comment">//动态设置环境变量</span>
  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 这里放优化的内容</span>
    <span class="token comment">// 优化打包 如果是生产环境就压缩 否则不压缩</span>
    minimizer<span class="token punctuation">:</span>env<span class="token operator">===</span><span class="token string">'production'</span><span class="token operator">?</span><span class="token punctuation">[</span> <span class="token comment">// 表示放优化的插件</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        parallel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启多进程并进行压缩</span>
        cache<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启缓存</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">OptimizeCSSAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 同时在js内可以获取到</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'==='</span><span class="token punctuation">,</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="webpack-merge-拆分配置"><a href="#webpack-merge-拆分配置" aria-hidden="true" class="header-anchor">#</a> webpack-merge 拆分配置</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack/webpack.client.js</span>
<span class="token keyword">let</span> htmlPluginWebpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>
  smart
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">smart</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/client.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">htmlPluginWebpack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="webpack-dev-middleware"><a href="#webpack-dev-middleware" aria-hidden="true" class="header-anchor">#</a> webpack-dev-middleware</h3> <ul><li>webpack-dev-middleware 就是在express中提供 静态服务能力的一个中间件</li> <li>原来是用webpack-dev-server 启动本地服务的 现在直接有express 项目开启服务(配上这个插件)</li> <li>同时webpack-dev-server原理也是这样的  他内部用的express也是引入这个插件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpackDevMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-middleware'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpackOptions <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span>
webpackOptions<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token string">'development'</span>
<span class="token comment">// compiler 代表整个编译对象</span>
<span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>webpackOptions<span class="token punctuation">)</span> 
<span class="token comment">/**
 * 中间件做了什么 compiler.run
 * 1、启动编译 compiler.run
 * 2、使用一个中间件,用来响应客户端对打包后的文件请求
 */</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="多入口mpa"><a href="#多入口mpa" aria-hidden="true" class="header-anchor">#</a> 多入口MPA</h3> <ul><li>两种处理办法
<ul><li>1、多个js入口写多个entry 多个html 写多个HtmlWebpackPlugin 配置</li> <li>2、创建多个html和js文件 在将他们引入一一对应,动态生成entry和HtmlWebpackPlugin</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HtmlWebpackPlugin<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> htmlWebpackPlugins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> entry<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> entryFiles <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'./src/**/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
entryFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryFile<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> entryName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entry<span class="token punctuation">[</span>entryName<span class="token punctuation">]</span><span class="token operator">=</span>entryFile<span class="token punctuation">;</span>
    htmlWebpackPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        template<span class="token punctuation">:</span><span class="token template-string"><span class="token string">`./src/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entryName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html`</span></span><span class="token punctuation">,</span>
        filename<span class="token punctuation">:</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entryName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html`</span></span><span class="token punctuation">,</span>
        chunks<span class="token punctuation">:</span><span class="token punctuation">[</span>entryName<span class="token punctuation">]</span><span class="token punctuation">,</span>
        inject<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
        minify<span class="token punctuation">:</span><span class="token punctuation">{</span>
            html5<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            collapseWhitespace<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            preserveLineBreaks<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            minifyCSS<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            minifyJS<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            removeComments<span class="token punctuation">:</span><span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    entry<span class="token punctuation">,</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token comment">//other plugins</span>
        <span class="token operator">...</span>htmlWebpackPlugins
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="日志优化"><a href="#日志优化" aria-hidden="true" class="header-anchor">#</a> 日志优化</h3> <ul><li>日志太多太少都不美观</li> <li>可以修改<code>stats</code> <ul><li>errors-only	只在错误时输出</li> <li>minimal	    发生错误和新的编译时输出</li> <li>none		    没有输出</li> <li>normal		  标准输出</li> <li>verbose		  全部输出</li></ul></li> <li>friendly-errors-webpack-plugin 上面状态不会有成功或者失败的提示,安装插件后才有
<ul><li>success 构建成功的日志提示</li> <li>warning 构建警告的日志提示</li> <li>error 构建报错的日志提示</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">FriendlyErrorsWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><h3 id="费时分析"><a href="#费时分析" aria-hidden="true" class="header-anchor">#</a> 费时分析</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> SpeedMeasureWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'speed-measure-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> smw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpeedMeasureWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span>smw<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="webpack-bundle-analyzer"><a href="#webpack-bundle-analyzer" aria-hidden="true" class="header-anchor">#</a> webpack-bundle-analyzer</h3> <ul><li>是一个webpack的插件，需要配合webpack和webpack-cli一起使用。这个插件的功能是生成代码分析报告，帮助提升代码质量和网站性能</li> <li>cnpm i webpack-bundle-analyzer</li> <li>配置脚本
<ul><li><code>&quot;generateAnalyzFile&quot;: &quot;webpack --profile --json &gt; stats.json&quot;, // 生成分析文件</code></li> <li><code>&quot;analyz&quot;: &quot;webpack-bundle-analyzer --port 8888 ./dist/stats.json&quot; // 启动展示打包报告的http服务器</code></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-bundle-analyzer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      analyzerMode<span class="token punctuation">:</span> <span class="token string">'disabled'</span><span class="token punctuation">,</span> <span class="token comment">// 不启动展示打包报告的http服务器</span>
      generateStatsFile<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否生成stats.json文件</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// 使用默认配置</span>
    <span class="token comment">// 默认配置的具体配置项</span>
    <span class="token comment">// new BundleAnalyzerPlugin({</span>
    <span class="token comment">//   analyzerMode: 'server',</span>
    <span class="token comment">//   analyzerHost: '127.0.0.1',</span>
    <span class="token comment">//   analyzerPort: '8888',</span>
    <span class="token comment">//   reportFilename: 'report.html',</span>
    <span class="token comment">//   defaultSizes: 'parsed',</span>
    <span class="token comment">//   openAnalyzer: true,</span>
    <span class="token comment">//   generateStatsFile: false,</span>
    <span class="token comment">//   statsFilename: 'stats.json',</span>
    <span class="token comment">//   statsOptions: null,</span>
    <span class="token comment">//   excludeAssets: null,</span>
    <span class="token comment">//   logLevel: info</span>
    <span class="token comment">// })</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="polyfill"><a href="#polyfill" aria-hidden="true" class="header-anchor">#</a> polyfill</h3> <ul><li>babel-polyfill</li> <li>Babel默认只转换新的JavaScript语法（syntax），如箭头函数等，而不转换新的API，比如Iterator、Generator、Set、Maps、Proxy、Reflect、Symbol、Promise等全局对象，以及一些定义在全局对象上的方法（比如Object.assign）都不会转码；因此我们需要polyfill</li> <li>polyfill （它需要在源代码之前运行），我们需要让它成为一个 dependency（上线时的依赖）,而不是一个 devDependency（开发时的依赖）；</li> <li>polyfill-service
<ul><li>自动化的 JavaScript Polyfill 服务</li> <li>Polyfill.io 通过分析请求头信息中的 UserAgent 实现自动加载浏览器所需的 polyfills</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://polyfill.io/v3/polyfill.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h3 id="librarytarget-library"><a href="#librarytarget-library" aria-hidden="true" class="header-anchor">#</a> libraryTarget &amp;&amp; library</h3> <ul><li>当用 Webpack 去构建一个可以被其他模块导入使用的库时需要用到它们</li> <li>output.library 导出库的名称</li> <li>output.libraryExport 配置要导出的模块中哪些子模块需要被导出。
<ul><li>它只有在 output.libraryTarget 被设置成 commonjs 或者 commonjs2 时使用才有意义</li> <li>当值为 default 时，针对的<code>libraryTarget 为commonjs2</code> 因为 commonjs2 导出的是 default</li> <li>当值为 xx  自定义的时候, 针对的<code>libraryTarget 为commonjs</code> 因为 commonjs 是导出的 xx 为单个导出的对象</li> <li>在浏览器测试他的时候 用umd 进行 不然其他2中浏览器不支持导出方式</li></ul></li> <li>output.libraryTarget 配置以何种方式导出库,是字符串的枚举类型，支持以下配置</li> <li>libraryTarget	 使用者的引入方式	使用者提供给被使用者的模块的方式 (可以自己自定义)
<ul><li>1、var(默认)  =&gt; 只能以script标签的形式引入我们的库	只能以全局变量的形式提供这些被依赖的模块  只要是var 都要用script 标签引入</li> <li>2、commonjs/commonjs2(node导出模块) 要配合  libraryExport选择使用(默认 <code>default</code>,在写好的文件中 我们会通过export default 批量导出,如果当个导出的话 default就换成单个导出的名字)</li> <li>commonjs    =&gt; exports 单个导出</li> <li>commonjs2   =&gt; module.exports 整体导出</li> <li>3、umd	    =&gt; 可以用script、commonjs、amd引入	按对应的方式引入</li> <li>注意 umd 会把所有的模式发包 window 是浏览器才有的 global</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>library<span class="token punctuation">:</span><span class="token string">'xxx'</span><span class="token punctuation">,</span><span class="token comment">// 导出库的名称</span>
libraryTarget<span class="token punctuation">:</span><span class="token string">'var'</span><span class="token punctuation">,</span><span class="token comment">// 以何种方式导出</span>
libraryExport<span class="token punctuation">:</span><span class="token string">'default'</span><span class="token comment">// 导出那种属性</span>

<span class="token comment">// src/index.js</span>
<span class="token comment">// 单个导出用commonjs libraryExport设置为导出的名字</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> a<span class="token operator">+</span>b
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">minus</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> a<span class="token operator">-</span>b
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">multipty</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> b<span class="token operator">*</span>a
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> a<span class="token operator">/</span>b
<span class="token punctuation">}</span>
<span class="token comment">// 整体导出用commonjs2  libraryExport设置为 default</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  add<span class="token punctuation">,</span>
  minus<span class="token punctuation">,</span>
  multipty<span class="token punctuation">,</span>
  divide
<span class="token punctuation">}</span>
<span class="token comment">// index.js 是package.json main对应的字段 别人用的入口</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/index.min.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/index.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="npm-发包"><a href="#npm-发包" aria-hidden="true" class="header-anchor">#</a> npm 发包</h3> <ul><li><p>devOps songg songge920322</p></li> <li><p>nrm use npm 切换源</p></li> <li><p>npm search xx 搜索xx名字是否有人用</p></li> <li><p>devOps 登录</p></li> <li><p>npm publish 发包</p></li></ul> <h3 id="动态链接库dll"><a href="#动态链接库dll" aria-hidden="true" class="header-anchor">#</a> 动态链接库DLL</h3> <ul><li>DllPlugin插件： 用于打包出一个个动态连接库 <code>const DllPlugin = require('webpack/lib/DllPlugin');</code></li> <li>DllReferencePlugin: 在配置文件中引入DllPlugin插件打包好的动态连接库 <code>const DllReferencePlugin = require('webpack/lib/DllReferencePlugin')</code></li> <li>流程:DllPlugin 插件将一些第三方库文件进行打包,DllReferencePlugin 插件是引入之前打包的配置文件,最后在index.html 里面引入之前的打包好的js文件库</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将第三方文件打包出来</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> DllPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/DllPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">:</span><span class="token string">'development'</span><span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span><span class="token punctuation">{</span>
    react<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span><span class="token string">'react-dom'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">// 希望把这些第三方库文件进行单独打包,就可以提高主体文件的打包速度</span>
  output<span class="token punctuation">:</span><span class="token punctuation">{</span>
    path<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token punctuation">:</span><span class="token string">'[name].dll.js'</span><span class="token punctuation">,</span><span class="token comment">// 打包出来一个文件react.dll.js</span>
    libraryTarget<span class="token punctuation">:</span><span class="token string">'var'</span><span class="token punctuation">,</span><span class="token comment">// 默认是var 这个全局变量,如果以这种方式导出的话,只能用脚本的方式进行全局访问</span>
    library<span class="token punctuation">:</span><span class="token string">'_dll_[name]'</span><span class="token comment">//指定 文件导出的名字</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span><span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span><span class="token string">'_dll_[name]'</span><span class="token punctuation">,</span><span class="token comment">// 这个与library 对应一致</span>
      path<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">,</span><span class="token string">'[name].manifest.json'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// 在配置webpack引入</span>
<span class="token keyword">const</span> DllReferencePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/DllReferencePlugin'</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  manifest<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">,</span><span class="token string">'react.manifest.json'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token comment">// 在入口文件 scrpit标签引入</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;../dist//react.dll.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h3 id="tree-shaking"><a href="#tree-shaking" aria-hidden="true" class="header-anchor">#</a> Tree Shaking</h3> <ul><li>一个模块可以有多个方法，只要其中某个方法使用到了，则整个文件都会被打到bundle里面去，tree shaking就是只把用到的方法打入bundle,没用到的方法会uglify阶段擦除掉</li> <li>原理是利用es6模块的特点,只能作为模块顶层语句出现,import的模块名只能是字符串常量</li> <li>webpack默认支持，在.babelrc里设置module:false即可在production mode下默认开启</li> <li>The 'modules' option must be one of 'false' to indicate no module processing .babelrc</li> <li>还要注意把devtool设置为null</li> <li>用法避坑,需要注意的地方
<ul><li>一定要注意尽量用es6 modules</li> <li>尽量编写没有副作用的代码</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token string">&quot;presets&quot;</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;modules&quot;</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//转译 ES6 ES7</span>
      <span class="token string">&quot;@babel/preset-react&quot;</span><span class="token comment">//转译JSX语法</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

<span class="token comment">// 用法</span>
<span class="token comment">// 1、没有导入和使用</span>
<span class="token keyword">function</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'func1'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token string">'func2'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  func1<span class="token punctuation">,</span>
  func2
<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>func2<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./functions'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> result2 <span class="token operator">=</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2、代码不会被执行，不可到达</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'false'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//3、代码执行的结果不会被用到</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>func2<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./functions'</span><span class="token punctuation">;</span>
<span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//4、代码中只会影响死变量，只写不读</span>
<span class="token keyword">var</span> aabbcc<span class="token operator">=</span><span class="token string">'aabbcc'</span><span class="token punctuation">;</span>
aabbcc<span class="token operator">=</span><span class="token string">'eeffgg'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="开启scope-hoisting-作用域提升"><a href="#开启scope-hoisting-作用域提升" aria-hidden="true" class="header-anchor">#</a> 开启Scope Hoisting(作用域提升)</h3> <ul><li>Scope Hoisting 可以让 Webpack 打包出来的代码文件更小、运行的更快， 它又译作 &quot;作用域提升&quot;，是在 Webpack3 中新推出的功能。</li> <li>初webpack转换后的模块会包裹上一层函数,import会转换成require</li> <li>代码体积更小，因为函数申明语句会产生大量代码</li> <li>代码在运行时因为创建的函数作用域更少了，内存开销也随之变小</li> <li>大量作用域包裹代码会导致体积增大</li> <li>运行时创建的函数作用域变多，内存开销增大</li> <li>scope hoisting的原理是将所有的模块按照引用顺序放在一个函数作用域里，然后适当地重命名一些变量以防止命名冲突</li> <li>这个功能在mode为production下默认开启,开发环境要用 webpack.optimize.ModuleConcatenationPlugin插件</li> <li>也要使用ES6 Module,CJS不支持</li></ul> <h3 id="代码块-公开课-等源码看完再处理"><a href="#代码块-公开课-等源码看完再处理" aria-hidden="true" class="header-anchor">#</a> 代码块 (公开课,等源码看完再处理)</h3> <ul><li>entry配置:通过多个entry文件来实现</li> <li>动态加载(按需加载):通过主动使用import来动态加载
<ul><li>1、首先如果遇到了 import 会把这个import的模块单独放到一个代码块中,这个代码块会单独生成一个文件</li> <li>2、首次加载的时候 只需要加载main.js 当遇到Import语句的时候 会向服务器发送一个jsonp请求,请求被分隔出去异步代码,然后合并到原来的modules,然后去加载这个新的模块,并且把这个模块的exports导出对象向后传递</li></ul></li> <li>抽取公共代码:使用 <code>splitChunks</code> 配置来抽取公共代码</li></ul> <h3 id="设置环境变量"><a href="#设置环境变量" aria-hidden="true" class="header-anchor">#</a> 设置环境变量</h3> <ul><li>设置环境变量
<ul><li>只能在node中获取(好像只能这个用&amp;&amp; 只能在node中获取 process.env.NODE_ENV_XX获取)</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token string">&quot;dev&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;set NODE_ENV_XX=xxx&amp;&amp;webpack-dev-server --config webpack.base.js&quot;</span><span class="token punctuation">,</span>
</code></pre></div><ul><li><code>cross-env</code> 安装库</li> <li>配置脚本<code>&quot;dev&quot;: &quot;cross-env NODE_ENV_SS=testing webpack-dev-server&quot;</code> 注意 cross-env 放在前面</li> <li>利用define plugin 导出到全局访问</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token constant">TEST</span><span class="token punctuation">:</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV_SS</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre></div><ul><li><code>process.env.NODE_ENV</code>可以在前端js文件内获取到</li></ul> <h2 id="webpack-源码入口分析"><a href="#webpack-源码入口分析" aria-hidden="true" class="header-anchor">#</a> webpack 源码入口分析</h2> <ul><li>npx webpack 执行的时候 他会找node_modules/bin/webacp.cmd</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  %~dp0 是指当前的目录</span>
<span class="token comment">// 他会去找 _webpack@4.41.2@webpack\bin\webpack.js</span>
@<span class="token constant">SETLOCAL</span>

@<span class="token constant">IF</span> <span class="token constant">EXIST</span> <span class="token string">&quot;%~dp0\node.exe&quot;</span> <span class="token punctuation">(</span>
  @<span class="token constant">SET</span> <span class="token string">&quot;_prog=%~dp0\node.exe&quot;</span>
<span class="token punctuation">)</span> <span class="token constant">ELSE</span> <span class="token punctuation">(</span>
  @<span class="token constant">SET</span> <span class="token string">&quot;_prog=node&quot;</span>
  @<span class="token constant">SET</span> <span class="token constant">PATHEXT</span><span class="token operator">=</span><span class="token operator">%</span><span class="token constant">PATHEXT</span><span class="token punctuation">:</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token constant">JS</span><span class="token punctuation">;</span><span class="token operator">=</span><span class="token punctuation">;</span><span class="token operator">%</span>
<span class="token punctuation">)</span>

<span class="token string">&quot;%_prog%&quot;</span>  <span class="token string">&quot;%~dp0\..\_webpack@4.41.2@webpack\bin\webpack.js&quot;</span> <span class="token operator">%</span><span class="token operator">*</span>
@<span class="token constant">ENDLOCAL</span>
</code></pre></div><ul><li>webpack/bin/cli 是打包的入口</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 此文件可以单独 运行 他会执行打包</span>
<span class="token comment">// 执行打包的核心 ..\_webpack@4.41.2@webpack\bin\webpack.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pkgPath <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`webpack-cli/package.json`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// eslint-disable-next-line node/no-missing-require</span>
<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>pkgPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// eslint-disable-next-line node/no-missing-require</span>
<span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>pkgPath<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//webpack-cli</span>
  <span class="token string">&quot;./bin/cli.js&quot;</span><span class="token comment">// webpack-cli/./bin/cli.js 这个是一切打包的入口 打断点就在这儿</span>
  <span class="token comment">// pkg.bin['webpack-cli']</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="编译和启动"><a href="#编译和启动" aria-hidden="true" class="header-anchor">#</a> 编译和启动</h3> <ul><li>比喻
<ul><li>Compiler 全局只有一个</li> <li>Compilation 代表一次的编译 是有多个的</li></ul></li> <li>Compiler和Compilation都继承自Tapable</li> <li>Compiler是每个Webpack配置对应的一个Compiler对象,记录Webpack的什么周期</li> <li>在构建过程中,每次构建都会产生一个Compilation,Compilation是构建周期的产物</li> <li>Compiler模块是webpack最核心的模块</li> <li>每次执行构建的时候,都会先实例化一个Compiler对象,然后调用它的 <code>run</code> 方法来开启一次完整的编译</li> <li>启动</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack-cli核心打包逻辑</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../webpack.config.js'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
<span class="token keyword">debugger</span><span class="token punctuation">;</span>
compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>stats</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token comment">/*
    返回的是主要含有modules、chunks和assets三个属性值的对象。
    entries 这里放的是入口模块
    chunks 编译出来了几个代码
    modules 编译出来的模块
    assets key 是文件的名称 值是文件内容
  stats.toJson(内部的) 用来过滤(这是为false)打印的数据 
  */</span>  
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    entries<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    chunks<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    modules<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    assets<span class="token punctuation">:</span><span class="token boolean">true</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>通过上面的的debugger 调试 进入到Compiler.js 找到 this.hooks 将下面的代码调试加入 可以打印webpack的整体流程</li> <li>Compiler 里面很多hooks</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过实例获取 构造函数</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hookName</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookName<span class="token punctuation">]</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>hook<span class="token punctuation">.</span>tap<span class="token punctuation">)</span><span class="token punctuation">{</span>
    hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'show'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> hookType <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hookName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hookType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hook<span class="token punctuation">.</span>_args<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="webpack的执行流程"><a href="#webpack的执行流程" aria-hidden="true" class="header-anchor">#</a> webpack的执行流程</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
environment    设置node环境变量
afterEnvironment    设置环境变量完成
entryOption   解析入口文件
afterPlugins     挂载插件结束 webpack.config.js会挂载很多插件
afterResolvers    在路径解析器初始化后触发 核心是给一个路径 他就能找到绝对路径
beforeRun  编译前
run  开始编译
normalModuleFactory 创建普通模块工厂  
contextModuleFactory   创建上下文模块工厂
beforeCompile  开始启动编译前
compile  编译
thisCompilation 开始启动编译  
compilation  创建一个 compilation
make  最核心的代码 是从入口文件开始编译
afterCompile  编译完成
shouldEmit  询问是否要生成文件
emit  生成文件
assetEmitted  资源已经生成
afterEmit 生成完成
done 整个编译完成
*/</span>
</code></pre></div><h3 id="stats-对象"><a href="#stats-对象" aria-hidden="true" class="header-anchor">#</a> Stats 对象</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;generateAnalyzFile&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;webpack --profile --json &gt; stats.json&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 生成分析文件</span>
<span class="token comment">// 或者</span>
<span class="token comment">// npx webpack --profile --json &gt; stats.json</span>
</code></pre></div><h3 id="import-动态引入-异步加载"><a href="#import-动态引入-异步加载" aria-hidden="true" class="header-anchor">#</a> import 动态引入(异步加载)</h3> <ul><li>打包后的文件名字 会默认加数字</li> <li>可以通过 webpackChunkname 处理</li> <li>也可以通过 output 的chunkFilename 配置(注意 filename不能写死 否则不生效)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName:'lazy' */</span><span class="token string">'./lazy.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 通过点击按钮 在加载代码</span>
<span class="token keyword">let</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'异步加载额外的模块'</span>
button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName:'lazy' */</span><span class="token string">'./title.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span>
</code></pre></div><h3 id="module-chunk-assets-关系"><a href="#module-chunk-assets-关系" aria-hidden="true" class="header-anchor">#</a> module chunk assets 关系</h3> <ul><li>module 是每个文件打包的对象</li> <li>chunk 是一个入口文件所有的代码  包含多个module</li> <li>assets 将要打包的资源</li></ul> <h3 id="webpack的插件机制"><a href="#webpack的插件机制" aria-hidden="true" class="header-anchor">#</a> webpack的插件机制</h3> <ul><li>webpack实现插件机制的大体方式是</li> <li>创建 - webpack在其内部对象上创建各种钩子；</li> <li>注册 - 插件将自己的方法注册到对应钩子上，交给webpack；</li> <li>调用 - webpack编译过程中，会适时地触发相应钩子，因此也就触发了插件的方法</li> <li>Webpack本质上是一种事件流的机制，它的工作流程就是将各个插件串联起来，而实现这一切的核心就是Tapable，webpack中最核心的负责编译的Compiler和负责创建bundle的Compilation都是Tapable的实例
通过事件和注册和监听，触发webpack生命周期中的函数方法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>
    SyncHook<span class="token punctuation">,</span>
    SyncBailHook<span class="token punctuation">,</span>
    SyncWaterfallHook<span class="token punctuation">,</span>
    SyncLoopHook<span class="token punctuation">,</span>
    AsyncParallelHook<span class="token punctuation">,</span>
    AsyncParallelBailHook<span class="token punctuation">,</span>
    AsyncSeriesHook<span class="token punctuation">,</span>
    AsyncSeriesBailHook<span class="token punctuation">,</span>
    AsyncSeriesWaterfallHook
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="tapable分类"><a href="#tapable分类" aria-hidden="true" class="header-anchor">#</a> tapable分类</h2> <ul><li>Hook类型可以分为 同步Sync 和 异步Async,异步又分为并行 和 串行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
类型	使用要点
Basic	基本型: 不关心监听函数的返回值
Bail	保险式: 只要监听函数中有返回值(不为undefined)，则跳过之后的监听函数
Waterfall	瀑布式: 上一步的返回值交给下一步使用
Loop	循环类型: 如果该监听函数返回true,则这个监听函数会反复执行(从头开始执行)，如果返回undefined则退出循环

1、所有的构造函数都接收一个可选参数,参数是一个参数名的字符串数组
2、参数的名字可以任意填写,但参数数组的长度必须要根据实际接收的参数个数一致
3、如果回调函数的不接收参数,可以传入空数组
4、在实例化的时候传入的数组长度有用,值没有用途
5、执行call,参数个数和实例化时的数组长度有关
6、回调的时候是按先入先出的顺序执行的,先放先执行
*/</span>
</code></pre></div><ul><li>SyncHook
<ul><li>SyncHook是一个构造函数 实例上有2个属性 tap 注册 call 发布 执行之前注册的函数</li></ul></li> <li>SyncBailHook
<ul><li>他的特点是 返回的值不是undefined 就会停止后续的调用</li></ul></li> <li>SyncWaterfallHook
<ul><li>用法如名字 瀑布流 如有返回值就传递给下一个回调函数,如没有就给传入的值</li></ul></li> <li>SyncLoppHook
<ul><li>不停的循环执行回调函数,直到函数的结果等于underfined,但是每次循环都是重头开始</li></ul></li> <li>AsyncParallelHook
<ul><li>异步并行执行钩子 就是普通的异步</li> <li>实例 有tapAsync 注册/callAsync 发布,tapPromise/promise</li></ul></li> <li>intercept 拦截
<ul><li>所有钩子都提供额外的拦截器 api</li> <li>call 每次在call之前触发</li> <li>tap 每次在挂载监听时候触发</li> <li>register 下一个拦截器的register参数 取决于上一个register的返回值</li> <li>loop 每次循环执行此拦截器</li></ul></li> <li>Context(上下文)
<ul><li>context:true 就是支持上下文 后面的函数就有context对象</li> <li>他是全局唯一的 在那儿修改 都能获取</li></ul></li></ul> <h3 id="_1、synchook-串行同步执行-不关心返回值"><a href="#_1、synchook-串行同步执行-不关心返回值" aria-hidden="true" class="header-anchor">#</a> 1、SyncHook 串行同步执行,不关心返回值</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {SyncHook}=require('tapable');</span>
<span class="token keyword">class</span> <span class="token class-name">SyncHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">task</span><span class="token operator">=&gt;</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">queue</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2、syncbailhook-串行同步执行，有一个返回值不为null则跳过剩下的逻辑"><a href="#_2、syncbailhook-串行同步执行，有一个返回值不为null则跳过剩下的逻辑" aria-hidden="true" class="header-anchor">#</a> 2、SyncBailHook 串行同步执行，有一个返回值不为null则跳过剩下的逻辑</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {SyncBailHook}=require('tapable');</span>
<span class="token keyword">class</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// for (let i=0;i&lt;this.tasks.length;i++){</span>
        <span class="token comment">//     let ret=this.tasks[i](...arguments);</span>
        <span class="token comment">//     if (ret)</span>
        <span class="token comment">//         break;</span>
        <span class="token comment">// }</span>
        <span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>ret<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            ret<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'Wrong'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">queue</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3、syncwaterfallhook-瀑布-上一个函数有返回值就会传递给下一个做参数"><a href="#_3、syncwaterfallhook-瀑布-上一个函数有返回值就会传递给下一个做参数" aria-hidden="true" class="header-anchor">#</a> 3、SyncWaterfallHook  瀑布 上一个函数有返回值就会传递给下一个做参数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span><span class="token operator">...</span>tasks<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">;</span>
        tasks<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ret<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">task</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//this.tasks.reduce((a,b) =&gt; (...args) =&gt; b(a(...args)))(...arguments);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>age</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">queue</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4、syncloophook-监听函数返回true表示继续循环，返回undefine表示结束循环"><a href="#_4、syncloophook-监听函数返回true表示继续循环，返回undefine表示结束循环" aria-hidden="true" class="header-anchor">#</a> 4、SyncLoopHook 监听函数返回true表示继续循环，返回undefine表示结束循环</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {SyncHook}=require('tapable');</span>
<span class="token keyword">class</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> ret<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                ret <span class="token operator">=</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>ret <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">queue</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_5、asyncparallelhook-异步并行执行钩子"><a href="#_5、asyncparallelhook-异步并行执行钩子" aria-hidden="true" class="header-anchor">#</a> 5、AsyncParallelHook 异步并行执行钩子</h3> <ul><li>5.1、tap</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {AsyncParallelHook}=require('tapable');</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args<span class="token operator">=</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> callback<span class="token operator">=</span>args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>5.2、tapAsync</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {AsyncParallelHook}=require('tapable');</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args<span class="token operator">=</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> callback<span class="token operator">=</span>args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">function</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>i <span class="token operator">==</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>5.3、tapPromise</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {AsyncParallelHook}=require('tapable');</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> promises <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_6、asyncparallelbailhook-带保险的异步并行执行钩子"><a href="#_6、asyncparallelbailhook-带保险的异步并行执行钩子" aria-hidden="true" class="header-anchor">#</a> 6、AsyncParallelBailHook 带保险的异步并行执行钩子</h3> <ul><li>6.1、tap</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {AsyncParallelBailHook} = require('tapable');</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncParallelBailHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args<span class="token operator">=</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> callback<span class="token operator">=</span>args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> ret<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AsyncParallelBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Wrong&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>6.2、tapAsync</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {AsyncParallelBailHook} = require('tapable');</span>

<span class="token keyword">class</span> <span class="token class-name">AsyncParallelBailHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args<span class="token operator">=</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> finalCallback<span class="token operator">=</span>args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>total<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">function</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">==</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>total<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> task<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AsyncParallelBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'Wrong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>6.2、tapPromise</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {AsyncParallelBailHook} = require('tapable');</span>

<span class="token keyword">class</span> <span class="token class-name">AsyncParallelBailHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args<span class="token operator">=</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> promises <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

queue<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_7、asyncserieshook-异步串行钩子"><a href="#_7、asyncserieshook-异步串行钩子" aria-hidden="true" class="header-anchor">#</a> 7、AsyncSeriesHook 异步串行钩子</h3> <ul><li>7.1、tap</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span>AsyncSeriesHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>total<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> task<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>7.2、tapAsync</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">AsyncSeriesBailHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> finalCallback <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">finalCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>7.3、tapPromise</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//first是第一个函数， tasks是剩下的函数</span>
        <span class="token keyword">let</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> <span class="token operator">...</span>tasks<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">;</span>
        <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8、asyncseriesbailhook"><a href="#_8、asyncseriesbailhook" aria-hidden="true" class="header-anchor">#</a> 8、AsyncSeriesBailHook</h3> <ul><li>8.1、tap</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span>AsyncSeriesBailHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Wrong&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>8.2、tabAsync</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {AsyncSeriesBailHook}=require('tapable');</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncSeriesBailHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args<span class="token operator">=</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> callback<span class="token operator">=</span>args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token function-variable function">next</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span>  <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> task<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            task<span class="token operator">?</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'wrong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>8.3、tapPromise</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span>AsyncSeriesBailHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//resolve();</span>
           <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_9、asyncserieswaterfallhook"><a href="#_9、asyncserieswaterfallhook" aria-hidden="true" class="header-anchor">#</a> 9、AsyncSeriesWaterfallHook</h3> <ul><li>9.1、tap</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span>AsyncSeriesWaterfallHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>9.2、tapAsync</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//let {AsyncSeriesBailHook}=require('tapable');</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args<span class="token operator">=</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> callback<span class="token operator">=</span>args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token function-variable function">next</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span>  <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> task<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">task</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>9.3、tapPromise</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span>AsyncSeriesWaterfallHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncSeriesWaterfallHook</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token function">promise</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//first是第一个函数， tasks是剩下的函数</span>
       <span class="token keyword">let</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> <span class="token operator">...</span>tasks<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">;</span>
       <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">b</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'sg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_10、tapable用法"><a href="#_10、tapable用法" aria-hidden="true" class="header-anchor">#</a> 10、tapable用法</h3> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">,</span>SyncHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tapable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 t<span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
     myHook<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;my-hook&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> called<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 t<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">myHook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;my-hook&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> called <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 t<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">myHook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// 同步</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>SyncHook<span class="token punctuation">,</span> SyncBailHook<span class="token punctuation">,</span>SyncWaterfallHook<span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Lesson1</span><span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token comment">// 必须传递一个值过去</span>
     arch<span class="token punctuation">:</span><span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 注册监听函数</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">arch</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//注册这两个事件</span>
l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'xxxxxxxx'</span><span class="token punctuation">)</span> <span class="token comment">//启动钩子</span>


<span class="token comment">// 阻塞</span>
<span class="token keyword">class</span> <span class="token class-name">Lesson2</span><span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
     arch<span class="token punctuation">:</span><span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 注册监听函数</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
     <span class="token comment">// return '想停止学习'</span>
     <span class="token comment">//如是返回 undefined 就继续执行</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">arch</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//注册这两个事件</span>
l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">)</span> <span class="token comment">//启动钩子</span>

<span class="token comment">// 瀑布</span>
<span class="token keyword">class</span> <span class="token class-name">Lesson3</span><span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
     arch<span class="token punctuation">:</span><span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 注册监听函数</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token comment">//xx</span>
     <span class="token keyword">return</span> <span class="token string">'想停止学习'</span>
     <span class="token comment">//如是返回 undefined 就继续执行</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token comment">//想停止学习</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">arch</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//注册这两个事件</span>
l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">)</span> <span class="token comment">//启动钩子</span>


<span class="token keyword">class</span> <span class="token class-name">Lesson</span><span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
     arch<span class="token punctuation">:</span><span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 注册监听函数</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
     <span class="token keyword">return</span> <span class="token operator">++</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">===</span> <span class="token number">3</span><span class="token operator">?</span> <span class="token string">'undefined'</span> <span class="token punctuation">:</span><span class="token string">'随便'</span>
     <span class="token comment">//如是返回不是undefined 就一直循环 </span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

 <span class="token punctuation">}</span>
 <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">arch</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//注册这两个事件</span>
l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">)</span> <span class="token comment">//启动钩子</span>

<span class="token comment">// 异步 并行钩子 需要等待所有的并发异步事件执行后在执行回调方法</span>
<span class="token comment">// 注册方法 分为 tap/tapAsync </span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>AsyncParallelHook<span class="token punctuation">,</span>AsyncSeriesHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Lesson1</span><span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
     arch<span class="token punctuation">:</span><span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 注册监听函数</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">w</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//注册这两个事件</span>
l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">)</span> <span class="token comment">//启动钩子</span>

<span class="token comment">// 异步串行</span>
<span class="token keyword">class</span> <span class="token class-name">Lesson</span><span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
     arch<span class="token punctuation">:</span><span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 注册监听函数</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
       <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

 <span class="token punctuation">}</span>
 <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//注册这两个事件</span>
l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">)</span> <span class="token comment">//启动钩子</span>

<span class="token keyword">class</span> <span class="token class-name">Lesson3</span><span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
     arch<span class="token punctuation">:</span><span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 注册监听函数</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
       <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

 <span class="token punctuation">}</span>
 <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//注册这两个事件</span>
l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">)</span> <span class="token comment">//启动钩子</span>

<span class="token comment">// AsyncSeriesWaterfallHook 异步</span>
<span class="token keyword">class</span> <span class="token class-name">Lesson4</span><span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
     arch<span class="token punctuation">:</span><span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 注册监听函数</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
       <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//注册这两个事件</span>
l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">)</span> <span class="token comment">//启动钩子</span>
</code></pre></div><h2 id="ast-语法解析"><a href="#ast-语法解析" aria-hidden="true" class="header-anchor">#</a> AST 语法解析</h2> <ul><li>webpack和Lint等很多的工具和库的核心都是通过Abstract Syntax Tree抽象语法树这个概念来实现对代码的检查、分析等操作的。通过了解抽象语法树这个概念，你也可以随手编写类似的工具</li> <li>用途
<ul><li>代码语法的检查、代码风格的检查、代码的格式化、代码的高亮、代码错误提示、代码自动补全等等
如JSLint、JSHint对代码错误或风格的检查，发现一些潜在的错误
IDE的错误提示、格式化、高亮、自动补全等等</li> <li>优化变更代码，改变代码结构使达到想要的结构
<ul><li>代码打包工具webpack、rollup等等</li> <li>CommonJS、AMD、CMD、UMD等代码规范之间的转化</li> <li>CoffeeScript、TypeScript、JSX等转化为原生Javascript</li></ul></li></ul></li></ul> <img src="/Study-history/img/ast.jpg"> <ul><li>JavaScript Parser
<ul><li>JavaScript Parser，把js源码转化为抽象语法树的解析器。</li> <li>浏览器会把js源码通过解析器转为抽象语法树，再进一步转化为字节码或直接生成机器码。</li> <li>一般来说每个js引擎都会有自己的抽象语法树格式，Chrome的v8引擎，firefox的SpiderMonkey引擎等等，MDN提供了详细SpiderMonkey AST format的详细说明，算是业界的标准。</li> <li>常用的JavaScript Parser有
<ul><li>esprima</li> <li>traceur</li> <li>acorn</li> <li>shift</li></ul></li> <li>esprima用法 <a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">ast参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <ul><li>通过 <a href="https://www.npmjs.com/package/esprima" target="_blank" rel="noopener noreferrer">esprima<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 把源码转化为AST</li> <li>通过 <a href="https://www.npmjs.com/package/estraverse" target="_blank" rel="noopener noreferrer">estraverse<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 遍历并更新AST</li> <li>通过 <a href="https://www.npmjs.com/package/escodegen" target="_blank" rel="noopener noreferrer">escodegen<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 将AST重新生成源码</li></ul></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  cnpm i esprima estraverse escodegen<span class="token operator">-</span> <span class="token constant">S</span>

  <span class="token keyword">let</span> esprima <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esprima'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> estraverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'estraverse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> escodegen <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;escodegen&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">'function ast(){}'</span><span class="token punctuation">;</span>
  <span class="token comment">// 解析</span>
  <span class="token keyword">let</span> ast<span class="token operator">=</span>esprima<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> indent<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">pad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">' '</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>indent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 遍历节点</span>
  estraverse<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span><span class="token punctuation">{</span>
      <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">pad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'FunctionDeclaration'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ast_rename'</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          indent<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          indent<span class="token operator">-=</span><span class="token number">2</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">pad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将AST重新生成源码</span>
  <span class="token keyword">let</span> generated <span class="token operator">=</span> escodegen<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>generated<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="转换箭头函数"><a href="#转换箭头函数" aria-hidden="true" class="header-anchor">#</a> 转换箭头函数</h3> <pre><code>- 访问者模式Visitor 对于某个对象或者一组对象，不同的访问者，产生的结果不同，执行操作也不同
</code></pre> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">//转换前</span>
  <span class="token keyword">const</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>a<span class="token operator">+</span>b
  <span class="token comment">//转换后</span>
  <span class="token comment">// 实现</span>
  <span class="token keyword">let</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babel-types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token string">`const sum = (a,b)=&gt;a+b`</span></span><span class="token punctuation">;</span>
  <span class="token comment">// path.node  父节点</span>
  <span class="token comment">// path.parentPath 父路径</span>
  <span class="token keyword">let</span> transformArrowFunctions <span class="token operator">=</span> <span class="token punctuation">{</span>
      visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token function-variable function">ArrowFunctionExpression</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">let</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
              <span class="token keyword">let</span> id <span class="token operator">=</span> path<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
              <span class="token keyword">let</span> params <span class="token operator">=</span> node<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
              <span class="token keyword">let</span> body<span class="token operator">=</span>t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                  t<span class="token punctuation">.</span><span class="token function">returnStatement</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
              <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">let</span> functionExpression <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">functionExpression</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>params<span class="token punctuation">,</span>body<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>functionExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>transformArrowFunctions<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="loader解析"><a href="#loader解析" aria-hidden="true" class="header-anchor">#</a> loader解析</h2> <h3 id="loader运行的总体流程"><a href="#loader运行的总体流程" aria-hidden="true" class="header-anchor">#</a> loader运行的总体流程</h3> <ul><li>loader配置
<ul><li>匹配(test)单个 loader，你可以简单通过在 rule 对象设置 path.resolve 指向这个本地文件</li> <li>匹配(test)多个 loaders modules</li> <li>alias</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token punctuation">{</span>
    test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span>
    use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        loader<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'path/to/loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        options<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./loaders/babel-loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./loaders/css-loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;style-loader&quot;</span><span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./loaders/style-loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;file-loader&quot;</span><span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./loaders/file-loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;url-loader&quot;</span><span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./loaders/url-loader.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="loader类型"><a href="#loader类型" aria-hidden="true" class="header-anchor">#</a> loader类型</h3> <ul><li>enforce 设置loader执行顺序</li> <li>loader的叠加顺序 proloader -&gt; normalloader -&gt; inline2 -&gt; inline1 -&gt; postloader</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 行内loader</span>
<span class="token function">require</span> <span class="token punctuation">(</span><span class="token string">'inline1!inline2!./hello'</span><span class="token punctuation">)</span>
<span class="token comment">// pre前置 post后置 normal普通</span>
<span class="token punctuation">{</span>test<span class="token punctuation">:</span><span class="token regex">/hello\.js$/</span><span class="token punctuation">,</span>loader<span class="token punctuation">:</span><span class="token string">'preloader'</span><span class="token punctuation">,</span>enforce<span class="token punctuation">:</span><span class="token string">'pre'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>test<span class="token punctuation">:</span><span class="token regex">/hello\.js$/</span><span class="token punctuation">,</span>loader<span class="token punctuation">:</span><span class="token string">'postloader'</span><span class="token punctuation">,</span>enforce<span class="token punctuation">:</span><span class="token string">'post'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>test<span class="token punctuation">:</span><span class="token regex">/hello\.js$/</span><span class="token punctuation">,</span>loader<span class="token punctuation">:</span><span class="token string">'normalloader'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>变量
<ul><li>!   不要前置loader</li> <li>-!  不要普通loader和前置</li> <li>!!  只要内联loader(不要前置 后置 普通loader)</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span> <span class="token punctuation">(</span><span class="token string">'-!inline1!inline2!./hello'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="用法准则"><a href="#用法准则" aria-hidden="true" class="header-anchor">#</a> 用法准则</h3> <ul><li><p>loaders 应该只做单一任务。这不仅使每个 loader 易维护，也可以在更多场景链式调用</p></li> <li><p>链式/利用 loader 可以链式调用的优势。写五个简单的 loader 实现五项任务，而不是一个 loader 实现五项任务</p></li> <li><p>无状态/确保 loader 在不同模块转换之间不保存状态。每次运行都应该独立于其他编译模块以及相同模块之前的编译结果。</p></li> <li><p>loader 工具库</p> <ul><li><a href="https://github.com/webpack/loader-utils" target="_blank" rel="noopener noreferrer">loader-utils<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 包。它提供了许多有用的工具，但最常用的一种工具是获取传递给 loader 的选项</li> <li><a href="https://github.com/webpack/schema-utils" target="_blank" rel="noopener noreferrer">schema-utils<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 包配合 loader-utils，用于保证 loader 选项，进行与 JSON Schema 结构一致的校验</li></ul></li> <li><p>绝对路径</p> <ul><li>不要在模块代码中插入绝对路径，因为当项目根路径变化时，文件绝对路径也会变化。loader-utils 中的 stringifyRequest 方法，可以将绝对路径转化为相对路径。</li></ul></li> <li><p>同等依赖</p> <ul><li>如果你的 loader 简单包裹另外一个包，你应该把这个包作为一个 peerDependency 引入</li> <li></li></ul></li> <li><p>API</p> <ul><li>webpack充分地利用缓存来提高编译效率
<ul><li>this.cacheable()</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 关闭该 Loader 的缓存功能 true则开启</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>raw
<ul><li>默认的情况源文件是以 UTF-8 字符串的形式传入给 Loader,设置module.exports.raw = true可使用 buffer 的形式进行处理</li> <li>在默认的情况下，Webpack 传给 Loader 的原内容都是 UTF-8 格式编码的字符串。 但有些场景下 Loader 不是处理文本文件，而是处理二进制文件，例如 file-loader，就需要 Webpack 给 Loader 传入二进制格式的数据。 为此，你需要这样编写 Loader：</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在 exports.raw === true 时，Webpack 传给 Loader 的 source 是 Buffer 类型的</span>
    source <span class="token keyword">instanceof</span> <span class="token class-name">Buffer</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// Loader 返回的类型也可以是 Buffer 类型的</span>
    <span class="token comment">// 在 exports.raw !== true 时，Loader 也可以返回 Buffer 类型的结果</span>
    <span class="token keyword">return</span> source<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 通过 exports.raw 属性告诉 Webpack 该 Loader 是否需要二进制数据 </span>
  module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h3 id="获得-loader-的-options"><a href="#获得-loader-的-options" aria-hidden="true" class="header-anchor">#</a> 获得 Loader 的 options</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack自带的工具包 </span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取到用户给当前 Loader 传入的 options</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="异步处理"><a href="#异步处理" aria-hidden="true" class="header-anchor">#</a> 异步处理</h3> <pre><code>- this.async();
</code></pre> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 让 Loader 缓存</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 做异步的事</span>
      <span class="token function">doSomeAsyncOperation</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="同步处理"><a href="#同步处理" aria-hidden="true" class="header-anchor">#</a> 同步处理</h3> <ul><li>Loader有些场景下还需要返回除了内容之外的东西。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过 this.callback 告诉 Webpack 返回的结果</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sourceMaps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 当你使用 this.callback 返回内容时，该 Loader 必须返回 undefined，</span>
    <span class="token comment">// 以让 Webpack 知道该 Loader 返回的结果在 this.callback 中，而不是 return 中 </span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>
    <span class="token comment">// 当无法转换原内容时，给 Webpack 返回一个 Error</span>
    err<span class="token punctuation">:</span> Error <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 原内容转换后的内容</span>
    content<span class="token punctuation">:</span> string <span class="token operator">|</span> Buffer<span class="token punctuation">,</span>
    <span class="token comment">// 用于把转换后的内容得出原内容的 Source Map，方便调试</span>
    sourceMap<span class="token operator">?</span><span class="token punctuation">:</span> SourceMap<span class="token punctuation">,</span>
    <span class="token comment">// 如果本次转换为原内容生成了 AST 语法树，可以把这个 AST 返回，</span>
    <span class="token comment">// 以方便之后需要 AST 的 Loader 复用该 AST，以避免重复生成 AST，提升性能</span>
    abstractSyntaxTree<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token constant">AST</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="其他api"><a href="#其他api" aria-hidden="true" class="header-anchor">#</a> 其他<a href="https://webpack.js.org/api/loaders/" target="_blank" rel="noopener noreferrer">API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <table><thead><tr><th>方法名</th> <th style="text-align:center">含义</th></tr></thead> <tbody><tr><td>this.context</td> <td style="text-align:center">当前处理文件的所在目录，假如当前 Loader 处理的文件是 /src/main.js，则 this.context 就等于 /src</td></tr> <tr><td>this.resource</td> <td style="text-align:center">当前处理文件的完整请求路径，包括 querystring，例如 /src/main.js?name=1。</td></tr> <tr><td>this.resourcePath</td> <td style="text-align:center">当前处理文件的路径，例如 /src/main.js</td></tr> <tr><td>this.resourceQuery</td> <td style="text-align:center">当前处理文件的 querystring</td></tr> <tr><td>this.target</td> <td style="text-align:center">等于 Webpack 配置中的 Target</td></tr> <tr><td>this.loadModule</td> <td style="text-align:center">但 Loader 在处理一个文件时，如果依赖其它文件的处理结果才能得出当前文件的结果时,就可以通过 this.loadModule(request: string, callback: function(err, source, sourceMap, module)) 去获得 request 对应文件的处理结果</td></tr> <tr><td>this.resolve</td> <td style="text-align:center">像 require 语句一样获得指定文件的完整路径，使用方法为 resolve(context: string, request: string, callback: function(err, result: string)</td></tr> <tr><td>this.addDependency</td> <td style="text-align:center">给当前处理文件添加其依赖的文件，以便再其依赖的文件发生变化时，会重新调用 Loader 处理该文件。使用方法为 addDependency(file: string)</td></tr> <tr><td>this.addContextDependency</td> <td style="text-align:center">和 addDependency 类似，但 addContextDependency 是把整个目录加入到当前正在处理文件的依赖中。使用方法为 addContextDependency(directory: string)</td></tr> <tr><td>this.clearDependencies</td> <td style="text-align:center">清除当前正在处理文件的所有依赖，使用方法为 clearDependencies()</td></tr> <tr><td>this.emitFile</td> <td style="text-align:center">输出一个文件，使用方法为 emitFile(name: string, content: Buffer/string, sourceMap: {...})</td></tr> <tr><td>loader-utils.stringifyRequest</td> <td style="text-align:center">把一个请求字符串转成一个字符串，以便能在require或者import中使用以避免绝对路径。如果你在一个loder中生成代码的话请使用这个而不要用JSON.stringify()</td></tr> <tr><td>loader-utils.interpolateName</td> <td style="text-align:center">使用多个占位符或一个正则表达式转换一个文件名的模块。这个模板和正则表达式被设置为查询参数，在当前loader的上下文中被称为name或者regExp</td></tr></tbody></table> <h3 id="loader实战"><a href="#loader实战" aria-hidden="true" class="header-anchor">#</a> loader实战</h3> <ul><li>内联loader
<ul><li>! 不要前置loader</li> <li>-! 不要普通loader和前置</li> <li>!! 只要内联loader(不要前置 后置 普通loader)</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span> <span class="token punctuation">(</span><span class="token string">'-!inline1!inline2!./hello'</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>处理 webpack 内部 loader 处理源码 简单解析</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">getSource</span><span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> rules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules<span class="token punctuation">;</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token comment">// 拿到每个规则来处理</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rules<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> rule <span class="token operator">=</span> rules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span>test<span class="token punctuation">,</span>use<span class="token punctuation">}</span> <span class="token operator">=</span> rule<span class="token punctuation">;</span>
      <span class="token keyword">let</span> len <span class="token operator">=</span> use<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">function</span> <span class="token function">normalLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> loader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>use<span class="token punctuation">[</span>len<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 递归调用loader</span>
            content <span class="token operator">=</span> <span class="token function">loader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token function">normalLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token function">normalLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> content
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="pitch"><a href="#pitch" aria-hidden="true" class="header-anchor">#</a> pitch</h3> <pre><code>- 比如a!b!c!module, 正常调用顺序应该是c、b、a，但是真正调用顺序是 a(pitch)、b(pitch)、c(pitch)、c、b、a,如果其中任何一个loader pitch返回值不为undefined 那么它以及它右边的loader normal 已经执行完毕 值会传给上一个loader normal ,如果值为 undefined 就不影响loader normal
- 比如如果b返回了字符串&quot;result b&quot;, 接下来只有a会被系统执行，且a的loader收到的参数是result b
- pitch与loader本身方法的执行顺序图
</code></pre> <div class="language-js extra-class"><pre class="language-js"><code>      <span class="token operator">|</span><span class="token operator">-</span> a<span class="token operator">-</span>loader <span class="token template-string"><span class="token string">`pitch`</span></span>
        <span class="token operator">|</span><span class="token operator">-</span> b<span class="token operator">-</span>loader <span class="token template-string"><span class="token string">`pitch`</span></span>
          <span class="token operator">|</span><span class="token operator">-</span> c<span class="token operator">-</span>loader <span class="token template-string"><span class="token string">`pitch`</span></span>
            <span class="token operator">|</span><span class="token operator">-</span> requested module is picked up <span class="token keyword">as</span> a dependency
          <span class="token operator">|</span><span class="token operator">-</span> c<span class="token operator">-</span>loader normal execution
        <span class="token operator">|</span><span class="token operator">-</span> b<span class="token operator">-</span>loader normal execution
      <span class="token operator">|</span><span class="token operator">-</span> a<span class="token operator">-</span>loader normal execution

      <span class="token comment">// 3个loader</span>
      <span class="token comment">// loader1 文件</span>
      <span class="token keyword">function</span> <span class="token function">loader1</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//normal</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1111'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> source
      <span class="token punctuation">}</span>
      loader1<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">//pitch</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loader1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader1

      <span class="token comment">// loader2 文件</span>
      <span class="token keyword">function</span> <span class="token function">loader1</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'222'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> source
      <span class="token punctuation">}</span>
      loader1<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loader3'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader1


      <span class="token comment">// loader3 文件</span>
      <span class="token keyword">function</span> <span class="token function">loader1</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'333'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> source
      <span class="token punctuation">}</span>
      loader1<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loader3'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader1

      rules<span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          test<span class="token punctuation">:</span><span class="token regex">/.js$/</span><span class="token punctuation">,</span>
          use<span class="token punctuation">:</span><span class="token punctuation">{</span>
            loader<span class="token punctuation">:</span><span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/loaders/loader1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/loaders/loader2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/loaders/loader3'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
      <span class="token comment">// 正常情况下没有pitch 执行顺序应该是 loader3=&gt;loader2=&gt;loader1=&gt;</span>
      <span class="token comment">// 加入pitch loader1.pitch =&gt; loader2.pitch =&gt; loader3.pitch =&gt;loader3=&gt;loader2=&gt;loader1</span>
      <span class="token comment">/* 
        pitch作用 
        若返回一个 字符串 那么跳过后面的pitch 和跳过当前的loader 进入下一个loader
        比如 loader2.pitch return一个字符串 loader1.pitch =&gt; loader2.pitch =&gt;loader1 (loader3.pitch =&gt;loader3=&gt;loader2 不会执行)
      */</span>
    <span class="token template-string"><span class="token string">``</span></span><span class="token template-string"><span class="token string">`
  - 处理css
    - css-loader 的作用是处理css中的 @import 和 url 这样的外部资源
    - style-loader 的作用是把样式插入到 DOM中，方法是在head中插入一个style标签，并把样式写入到这个标签的 innerHTML里
    - less-loader Compiles Less to CSS
  - less-loader.js
  `</span></span><span class="token template-string"><span class="token string">``</span></span>js
    <span class="token keyword">let</span> less <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'less'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        less<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span> filename<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> output<span class="token punctuation">.</span>css<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="loader-utils"><a href="#loader-utils" aria-hidden="true" class="header-anchor">#</a> loader-utils</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 1、stringifyRequest</span>
  <span class="token comment">// 作用将路径转换为绝对路径 在loader中使用</span>
  loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">'地址'</span><span class="token punctuation">)</span> 
  <span class="token comment">// 2、getOptions</span>
  <span class="token comment">// loaderUtils.getOptions能获取当前的options 配置</span>
  <span class="token keyword">let</span>  options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// 3、interpolateName</span>
  <span class="token comment">// loaderUtils.interpolateName 方法可以根据 options.name 以及文件内容生成一个唯一的文件名 url（一般配置都会带上hash，否则很可能由于文件重名而冲突）</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">interpolateName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>filename <span class="token operator">||</span> <span class="token string">&quot;[hash]&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// content 当前的resource</span>
  
</code></pre></div><h3 id="_1、babel-loader"><a href="#_1、babel-loader" aria-hidden="true" class="header-anchor">#</a> 1、babel-loader</h3> <ul><li>babel 插件写法(提交例子可以参考 箭头函数的转换=&gt;搜索 ArrowFunctionExpression)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> transformArrayFunction <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// visitor 可以访问源代码生成的语法树的所有节点,捕获特定的节点</span>
  visitor<span class="token punctuation">:</span><span class="token punctuation">{</span>
    <span class="token comment">// 节点</span>
    <span class="token function-variable function">Identifier</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span>state</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> rs <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span><span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>transformArrayFunction<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>rs</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>babel.transform</code> 将源代码 转义成ast,他的作用只是ast 其他的处理全部交给插件处理,同时加入配置 这里的options和webpack loader里面的配置是一模一样的</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
  <span class="token comment">// </span>
  <span class="token keyword">let</span>  options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
   options <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token operator">...</span>options<span class="token punctuation">,</span><span class="token comment">//二选一</span>
    <span class="token comment">// presets:[  &quot;@babel/preset-env&quot;],</span>
    sourceMaps<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">// 告诉babel我要生成sourcemap 如果提供了 webpack sourcemap就用它的 不给它自己弄 , 要设置 devtool:'source-map' 自己设置后names 选项就有值了</span>
    filename<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token comment">// 内部的api this上提供的 当前处理文件的路径，例如 /src/main.js</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//  转义之后会生成3个文件</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span>map<span class="token punctuation">,</span>ast<span class="token punctuation">}</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span>map<span class="token punctuation">,</span>ast<span class="token punctuation">)</span>
  <span class="token comment">// 我们可以吧sourcemap ast 都传给webpack 这样webpack就不需要自己吧源代码转语法树了，也不需要自己生成sourcemap</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>code<span class="token punctuation">,</span>map<span class="token punctuation">,</span>ast<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="_2、banner-loader"><a href="#_2、banner-loader" aria-hidden="true" class="header-anchor">#</a> 2、banner-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> validateOptions <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'schema-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//把loader改为异步,任务完成后需要手工执行callback</span>
    <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//启用loader缓存</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cacheable <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用来验证options的合法性</span>
    <span class="token keyword">let</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span> 
        type<span class="token punctuation">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
        properties<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            filename<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                type<span class="token punctuation">:</span> <span class="token string">'string'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            text<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                type<span class="token punctuation">:</span> <span class="token string">'string'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//通过工具方法获取options</span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用来验证options的合法性</span>
    <span class="token function">validateOptions</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token string">'Banner-Loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> text<span class="token punctuation">,</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> text <span class="token operator">+</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> text</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> text <span class="token operator">+</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
</code></pre></div><h3 id="_3、style-loader"><a href="#_3、style-loader" aria-hidden="true" class="header-anchor">#</a> 3、style-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> loaderUtils<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;loader-utils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> script<span class="token operator">=</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`
        let style = document.createElement(&quot;style&quot;);
        style.innerHTML = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
        document.head.appendChild(style);
      `</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// JSON.stringify 在处理的时候 会添加\r\n 要将他们删除 否则会报错</span>
  style <span class="token operator">=</span> style<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/(\\n|\\r)/g</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> script<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
  <span class="token comment">/*
    pitch 作用是 让两个loader配合使用
    
    ** 最后 require是在浏览器执行的
    
    如果不加 !! 会出现死循环
    
    处理 css 的时候  会先执行 style pitch 如果用loader处理(他无法处理js) 在pitch处理的时候他能通过`remindingRequest`获取剩下的loader 这里要在loader加!! 表示 只能当前的loader(或者叫内联loader处理) 如果不他 他还会走到`style-loader`内 会造成无线循环
  
  */</span> 
  loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
      var style = document.createElement(&quot;style&quot;);
      style.innerHTML = require(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;!!&quot;</span> <span class="token operator">+</span> request<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);
      document.head.appendChild(style);
  `</span></span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> style<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
</code></pre></div><h3 id="_4、css-loader"><a href="#_4、css-loader" aria-hidden="true" class="header-anchor">#</a> 4、css-loader</h3> <ul><li>作用是处理css中的 @import 和 url 这样的外部资源</li> <li>安装<code>postcss</code> 将css 转换成ast语法树</li> <li>postcss 是用来解析css 转换成ast(类似)
<ul><li>他和babel一样只有分解功能 没有变化功能,具体操作需要插件</li></ul></li> <li>用法(下面是固定格式,具体例子看下面 css-loader)</li> <li>css-loader的原理 解析css 语法 找到 url 个 @import 将他们替换成 <code>require</code> 语法,将处理的数据 返回给 style-loader 处理</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 插件 <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">logo</span><span class="token punctuation">(</span><span class="token string">'rs'</span><span class="token punctuation">,</span>rs<span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 简单版本 模仿 <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token regex">/url\((.+?)\)/g</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> current<span class="token punctuation">;</span>
      <span class="token keyword">let</span> pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token string">`let lists = [];`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>current <span class="token operator">=</span> reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> <span class="token punctuation">[</span>matchUrl<span class="token punctuation">,</span> p<span class="token punctuation">]</span> <span class="token operator">=</span> current<span class="token punctuation">;</span>
          <span class="token keyword">let</span> index <span class="token operator">=</span> reg<span class="token punctuation">.</span>lastIndex <span class="token operator">-</span> matchUrl<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`lists.push(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          pos <span class="token operator">=</span> reg<span class="token punctuation">.</span>lastIndex<span class="token punctuation">;</span>
          arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`lists.push(&quot;url(&quot;+require(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>p<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)+&quot;)&quot;)`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`lists.push(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`module.exports = lists.join('')`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>

  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 原理 <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'css-selector-tokenizer'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span>urlItems<span class="token punctuation">,</span>importItems<span class="token punctuation">}</span> <span class="token operator">=</span> options
      <span class="token comment">// 遍历 import 语法</span>
      css<span class="token punctuation">.</span><span class="token function">walkAtRules</span><span class="token punctuation">(</span><span class="token regex">/^import$/</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> values<span class="token punctuation">.</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment">//{value:'./base.css'}</span>
        importItems<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 遍历每一条规则</span>
      css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 将字符串转成对象</span>
        <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token comment">// '75px solid red'</span>
        values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token keyword">let</span> url <span class="token operator">=</span> item<span class="token punctuation">.</span>url
              item<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`_CSS_URL_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>urlItems<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_`</span></span>
              urlItems<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token comment">// .avatar.gif</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 将对象转成字符串</span>
        decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
      importItems<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      urlItems<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// loaderUtils.stringifyRequest他 可以把一个绝对路径 转换成合适loader的相对路径</span>
    <span class="token comment">// background-img:url(./avatar.gif)</span>
    <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> importJs <span class="token operator">=</span> options<span class="token punctuation">.</span>importItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">imp</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// return '&quot;+require(&quot;'+imp+'&quot;)+&quot;'</span>
        <span class="token keyword">return</span> <span class="token string">&quot;require(&quot;</span><span class="token operator">+</span>loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>imp<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;)&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token comment">// @import './base.css';</span>
      <span class="token keyword">let</span> cssString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>css<span class="token punctuation">)</span><span class="token comment">// url('_CSS_URL_0_')</span>
    
      <span class="token comment">// 替换 @import './base.css'</span>
      cssString <span class="token operator">=</span> cssString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/@import\s+?.+?;/</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// 替换 url('_CSS_URL_0_')</span>
      cssString <span class="token operator">=</span> cssString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/_CSS_URL_(\d+?)_/g</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">,</span>group1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> imageUrl <span class="token operator">=</span> options<span class="token punctuation">.</span>urlItems<span class="token punctuation">[</span><span class="token operator">+</span>group1<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//  打包的时候 imageUrl 变成真实的地址  最后 require是在浏览器执行的</span>
        <span class="token keyword">return</span> <span class="token string">'&quot;+require(&quot;'</span><span class="token operator">+</span>imageUrl<span class="token operator">+</span><span class="token string">'&quot;)+&quot;'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'importJs'</span><span class="token punctuation">,</span>importJs<span class="token punctuation">)</span>
        <span class="token comment">// ${importJs}</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token template-string"><span class="token string">`
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>importJs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cssString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
      `</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="exact-loader"><a href="#exact-loader" aria-hidden="true" class="header-anchor">#</a> exact-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">//把CSS文件单独放置到一个文件中去，然后在页面中通过link标签去引入</span>
  <span class="token keyword">let</span> <span class="token function-variable function">loader</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//发射或者说输出一个文件，这个文件的内容 就是css文件的内容</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token string">'main.css'</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> script <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
      let link  = document.createElement('link');
      link.setAttribute('rel','stylesheet');
      link.setAttribute('href','main.css');
      document.head.appendChild(link);
    `</span></span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> script<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
</code></pre></div><h3 id="file-loader"><a href="#file-loader" aria-hidden="true" class="header-anchor">#</a> file-loader</h3> <ul><li>file-loader 并不会对文件内容进行任何转换，只是复制一份文件内容，并根据配置为他生成一个唯一的文件名。</li> <li>通过 loaderUtils.interpolateName 方法可以根据 options.name 以及文件内容生成一个唯一的文件名 url（一般配置都会带上hash，否则很可能由于文件重名而冲突）</li> <li>通过 this.emitFile(url, content) 告诉 webpack 我需要创建一个文件，webpack会根据参数创建对应的文件，放在 public path 目录下</li> <li>返回 module.exports = ${JSON.stringify(url)},这样就会把原来的文件路径替换为编译后的路径</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> getOptions<span class="token punctuation">,</span> interpolateName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> options<span class="token operator">=</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">interpolateName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>filename <span class="token operator">||</span> <span class="token string">&quot;[hash]&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      url <span class="token operator">=</span> url  <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//发射一个文件 向输出里保存一个文件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
</code></pre></div><h3 id="url-loader"><a href="#url-loader" aria-hidden="true" class="header-anchor">#</a> url-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span> getOptions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> options<span class="token operator">=</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> limit<span class="token punctuation">,</span> fallback<span class="token operator">=</span><span class="token string">'file-loader'</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      limit <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>limit<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> mimetype<span class="token operator">=</span>mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>limit <span class="token operator">||</span> source<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> base64 <span class="token operator">=</span> <span class="token template-string"><span class="token string">`data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mimetype<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>source<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>base64<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> fileLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>fallback <span class="token operator">||</span> <span class="token string">'file-loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">fileLoader</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
</code></pre></div><h3 id="sprite-loader"><a href="#sprite-loader" aria-hidden="true" class="header-anchor">#</a> sprite-loader</h3> <ul><li>用法 在图片后面加?sprite 做标识  loader内部 判断有这个 会组合成一张图片 在给他们增加一个<code>background-position</code>属性</li></ul> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.one</span><span class="token punctuation">{</span>
  <span class="token property">background-image</span><span class="token punctuation">:</span><span class="token url">url(../img/1.jpg?sprite)</span> <span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.two</span><span class="token punctuation">{</span>
  <span class="token property">background-image</span><span class="token punctuation">:</span><span class="token url">url(../img/2.jpg?sprite)</span> <span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.three</span><span class="token punctuation">{</span>
  <span class="token property">background-image</span><span class="token punctuation">:</span><span class="token url">url(../img/3.jpg?sprite)</span> <span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> SpriteSmith <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'spritesmith'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'css-selector-tokenizer'</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token comment">//this.context 代表被加载资源的上下文目录</span>
    <span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">postcssOptions</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'url'</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'?sprite'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 拼一个路径 找到的是这个图片的绝对路径</span>
                <span class="token keyword">let</span> url <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>context<span class="token punctuation">,</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
                item<span class="token punctuation">.</span>url <span class="token operator">=</span> postcssOptions<span class="token punctuation">.</span>spriteFilename<span class="token punctuation">;</span>
                <span class="token comment">// 案例说我要在当前规则下面添加一条background-position</span>
                postcssOptions<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                  url<span class="token punctuation">,</span><span class="token comment">// 原始图片的绝对路径,未来合并雪碧图用</span>
                  rule<span class="token punctuation">:</span>decl<span class="token punctuation">.</span>parent <span class="token comment">// </span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// css 添加数据 先给他们一个占位符 在替换 </span>
        postcssOptions<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span>item<span class="token punctuation">.</span>rule<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rule<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          <span class="token comment">// 注意这个的 index 用法 首次数组为空  加一个数组内容对应的index 就会变化</span>
          rule<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>
            postcss<span class="token punctuation">.</span><span class="token function">decl</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              prop<span class="token punctuation">:</span><span class="token string">'background-position'</span><span class="token punctuation">,</span>
              value<span class="token punctuation">:</span><span class="token template-string"><span class="token string">`_BACKGROUND_POSITION_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_`</span></span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> <span class="token punctuation">{</span>spriteFilename<span class="token punctuation">:</span><span class="token string">'sprite.jpg'</span><span class="token punctuation">,</span>rules<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> pipeline <span class="token operator">=</span> <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>postcssOptions<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pipeline<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> cssStr <span class="token operator">=</span> rs<span class="token punctuation">.</span>css
      <span class="token keyword">let</span> sprites <span class="token operator">=</span> postcssOptions<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span>item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      SpriteSmith<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>src<span class="token punctuation">:</span>sprites<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> coordinates <span class="token operator">=</span> result<span class="token punctuation">.</span>coordinates
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          cssStr <span class="token operator">=</span> cssStr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`_BACKGROUND_POSITION_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token string">`-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>coordinates<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px -</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>coordinates<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        that<span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>postcssOptions<span class="token punctuation">.</span>spriteFilename<span class="token punctuation">,</span>result<span class="token punctuation">.</span>image<span class="token punctuation">)</span>
        <span class="token comment">// 注意 导出的是模块是字符串 要加'' JSON.stringify功能就是加''但是他比直接加'' 要好,他可以出来\n  </span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">)</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token template-string"><span class="token string">`module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="px2rem-loader"><a href="#px2rem-loader" aria-hidden="true" class="header-anchor">#</a> px2rem-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> SpriteSmith <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'spritesmith'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'css-selector-tokenizer'</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span>remUnit<span class="token operator">=</span><span class="token number">75</span><span class="token punctuation">,</span>remPrecision<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">}</span> <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token comment">//this.context 代表被加载资源的上下文目录</span>
    <span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">postcssOptions</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'px'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">let</span> px <span class="token operator">=</span>  <span class="token function">parseInt</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> rem <span class="token operator">=</span> <span class="token punctuation">(</span>px<span class="token operator">/</span>remUnit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span>remPrecision<span class="token punctuation">)</span><span class="token punctuation">;</span>
                item<span class="token punctuation">.</span>name <span class="token operator">=</span> rem<span class="token operator">+</span><span class="token string">'rem'</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> pipeline <span class="token operator">=</span> <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>postcssOptions<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pipeline<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> cssStr <span class="token operator">=</span> rs<span class="token punctuation">.</span>css
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token template-string"><span class="token string">`module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h2 id="plugin解析"><a href="#plugin解析" aria-hidden="true" class="header-anchor">#</a> plugin解析</h2> <ul><li>插件向第三方开发者提供了 webpack 引擎中完整的能力。使用阶段式的构建回调，开发者可以引入它们自己的行为到 webpack 构建流程中。创建插件比创建 loader 更加高级，因为你将需要理解一些 webpack 底层的内部特性来做相应的钩子</li> <li>为什么需要一个插件
<ul><li>webpack基础配置无法满足需求</li> <li>插件几乎能够任意更改webpack编译结果</li> <li>webpack内部也是通过大量内部插件实现的</li></ul></li> <li>可以加载插件的常用对象</li></ul> <table><thead><tr><th>对象</th> <th style="text-align:center">钩子</th></tr></thead> <tbody><tr><td>Compiler</td> <td style="text-align:center">run,compile,compilation,make,emit,done</td></tr> <tr><td>Compilation</td> <td style="text-align:center">buildModule,normalModuleLoader,succeedModule,finishModules,seal,optimize,after-seal</td></tr> <tr><td>Module Factory</td> <td style="text-align:center">beforeResolver,afterResolver,module,parser</td></tr> <tr><td>Module</td> <td style="text-align:center"></td></tr> <tr><td>Parser</td> <td style="text-align:center">program,statement,call,expression</td></tr> <tr><td>Template</td> <td style="text-align:center">hash,bootstrap,localVars,render</td></tr></tbody></table> <h3 id="创建插件"><a href="#创建插件" aria-hidden="true" class="header-anchor">#</a> 创建插件</h3> <ul><li>webpack 插件由以下组成：
<ul><li>一个 JavaScript 命名函数。</li> <li>在插件函数的 prototype 上定义一个 apply 方法。</li> <li>指定一个绑定到 webpack 自身的事件钩子。</li> <li>处理 webpack 内部实例的特定数据。</li> <li>功能完成后调用 webpack 提供的回调。</li></ul></li></ul> <h3 id="compiler-和-compilation"><a href="#compiler-和-compilation" aria-hidden="true" class="header-anchor">#</a> Compiler 和 Compilation</h3> <ul><li>在插件开发中最重要的两个资源就是compiler和compilation对象。理解它们的角色是扩展webpack引擎重要的第一步。
<ul><li>compiler 对象代表了完整的 webpack 环境配置。这个对象在启动 webpack 时被一次性建立，并配置好所有可操作的设置，包括 options，loader 和 plugin。当在 webpack 环境中应用一个插件时，插件将收到此 compiler 对象的引用。可以使用它来访问 webpack 的主环境。</li> <li>compilation 对象代表了一次资源版本构建。当运行 webpack 开发环境中间件时，每当检测到一个文件变化，就会创建一个新的 compilation，从而生成一组新的编译资源。一个 compilation 对象表现了当前的模块资源、编译生成资源、变化的文件、以及被跟踪依赖的状态信息。compilation 对象也提供了很多关键时机的回调，以供插件做自定义处理时选择使用。</li></ul></li> <li>基本插件架构
<ul><li>插件是由「具有 apply 方法的 prototype 对象」所实例化出来的。</li> <li>这个 apply 方法在安装插件时，会被 webpack compiler 调用一次。</li> <li>apply 方法可以接收一个 webpack compiler 对象的引用，从而可以在回调函数中访问到 compiler 对象。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 原理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>一个简单的插件结构如下：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">DonePlugin</span><span class="token punctuation">{</span>
      <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token operator">=</span>options<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'DonePlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello '</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports<span class="token operator">=</span>DonePlugin<span class="token punctuation">;</span>
</code></pre></div><ul><li>然后，要安装这个插件，只需要在你的 webpack 配置的 plugin 数组中添加一个实例：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> DonePlugin<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugins/DonePlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
      entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          filename<span class="token punctuation">:</span><span class="token string">'bundle.js'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token keyword">new</span> <span class="token class-name">DonePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'sg'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>异步编译插件
<ul><li>有一些编译插件中的步骤是异步的，这样就需要额外传入一个 callback 回调函数，并且在插件运行结束时，必须调用这个回调函数。</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CompilationAsyncPlugin</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token operator">=</span>options<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'EmitPlugin'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'异步任务完成'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span>CompilationAsyncPlugin<span class="token punctuation">;</span>
</code></pre></div><ul><li>输出文件列表</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">FileListPlugin</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'FileListPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> filelist<span class="token operator">=</span><span class="token string">'## 文件列表'</span><span class="token punctuation">;</span>
            filelist <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>compilation<span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">filelist<span class="token punctuation">,</span>filename</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>filelist<span class="token operator">+</span><span class="token string">'\r\n- '</span><span class="token operator">+</span>filename<span class="token punctuation">,</span>filelist<span class="token punctuation">)</span><span class="token punctuation">;</span>
            compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token operator">?</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token punctuation">:</span><span class="token string">'filelist.md'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> filelist<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> filelist<span class="token punctuation">.</span>length
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span>FileListPlugin<span class="token punctuation">;</span>
</code></pre></div></li></ul> <h2 id="handwritewebapck"><a href="#handwritewebapck" aria-hidden="true" class="header-anchor">#</a> handWriteWebapck</h2> <h3 id="webpack流程概括"><a href="#webpack流程概括" aria-hidden="true" class="header-anchor">#</a> Webpack流程概括</h3> <ul><li><p>初始化参数：从配置文件和 Shell 语句中读取与合并参数，得出最终的参数； 开始编译：用上一步得到的参数初始化 Compiler 对象，加载所有配置的插件，执行对象的 run 方法开始执行编译；</p></li> <li><p>确定入口：根据配置中的 entry 找出所有的入口文件；</p></li> <li><p>编译模块：从入口文件出发，调用所有配置的 Loader 对模块进行翻译，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理；</p></li> <li><p>完成模块编译：在经过第4步使用 Loader 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系；</p></li> <li><p>输出资源：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 Chunk，再把每个 Chunk 转换成一个单独的文件加入到输出列表，这步是可以修改输出内容的最后机会；</p></li> <li><p>输出完成：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统。</p></li> <li><p>钩子</p> <ul><li>entryOption 读取配置文件</li> <li>afterPlugins 加载所有的插件</li> <li>run 开始执行编译流程</li> <li>compile 开始编译</li> <li>afterCompile 编译完成</li> <li>emit 写入文件</li> <li>done 完成整体流程</li></ul></li> <li><p>编写示例项目</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  npm init <span class="token operator">-</span>y
  yarn add webpack webpack<span class="token operator">-</span>cli html<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin

  <span class="token comment">// 编写webpack配置文件</span>
  <span class="token comment">// webpack.config.js</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
      mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
      entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// rules 里面的内容 等自己写的webpack增加loader解析后 在加入</span>
        <span class="token comment">// rules: [</span>
        <span class="token comment">//     {</span>
        <span class="token comment">//     test: /.less$/,</span>
        <span class="token comment">//     use: [</span>
        <span class="token comment">//       path.resolve(__dirname,'loaders','style-loader'),</span>
        <span class="token comment">//       path.resolve(__dirname,'loaders','less-loader'),</span>
        <span class="token comment">//     ]</span>
        <span class="token comment">//   }</span>
        <span class="token comment">// ]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建loaders/less-loader</span>
    <span class="token keyword">let</span> less <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'less'</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> css <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      less<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>c</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        css <span class="token operator">=</span> c<span class="token punctuation">.</span>css
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      css <span class="token operator">=</span> css<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\n/g</span><span class="token punctuation">,</span><span class="token string">'\\n'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> css<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
  <span class="token comment">// 创建loaders/style-loader</span>
    <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
      let style = document.createElement('style')
      style.innerHTML = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      document.head.appendChild(style)
      `</span></span>
      <span class="token keyword">return</span> style<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader

    <span class="token comment">// 拿到的source 是有空格的 通过JSON.stringify 可以去掉</span>
</code></pre></div><ul><li>源文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/index.js</span>
<span class="token keyword">let</span> a1<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// src/a1.js </span>
<span class="token keyword">let</span> a2<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./base/a2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token string">'a1'</span><span class="token operator">+</span>a2<span class="token punctuation">;</span>
<span class="token comment">// src/base/a2.js</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token string">'a2'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>产出bundle.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>
      l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token punctuation">{</span>

    <span class="token string">&quot;./src/a1.js&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;let a2 = __webpack_require__( \&quot;./src/base/a2.js\&quot;);\r\nmodule.exports = 'a1' + a2;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./src/base/a2.js&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;module.exports = 'a2';&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;let a1 = __webpack_require__(\&quot;./src/a1.js\&quot;);\r\nconsole.log(a1);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="安装依赖包"><a href="#安装依赖包" aria-hidden="true" class="header-anchor">#</a> 安装依赖包</h3> <ul><li>1、准备</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token number">1</span>、创建 webpackSg文件
  <span class="token number">2</span>、npm init <span class="token operator">-</span>y
  <span class="token number">3</span>、修改<span class="token keyword">package</span><span class="token punctuation">.</span>json文件
      <span class="token string">&quot;bin&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;hardwebpack&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;./bin/pack.js&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token number">4</span>、创建 bin<span class="token operator">/</span>pack<span class="token punctuation">.</span>js
</code></pre></div><ul><li>2、入口文件处理(bin/pack.js)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
<span class="token comment">// 1、 需要找到当前执行名的路径  拿到webpakcc.config.js</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token comment">// config 配置文件</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'webpack.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// let config = require(path.join(process.cwd(),'webpack.config.js'))</span>
<span class="token keyword">let</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/Compiler.js'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>

compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>3、创建lib/Compiler.js
<ul><li>实现基本的 引入文件</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">let</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span>
<span class="token comment">// babylon 主要就是把源码  他里面有个方法叫parse 转换成ast</span>
<span class="token comment">// @babel/traverse 遍历节点</span>
<span class="token comment">// @babel/types 替换</span>
<span class="token comment">// @babel/generator 生成结果</span>
<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// entry output</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config
    <span class="token comment">//1、需要保存入口文件的路径</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">;</span> <span class="token comment">//'./src/index.js'</span>
    <span class="token comment">//2、需要保存所有的模块依赖</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>entry <span class="token operator">=</span> config<span class="token punctuation">.</span>entry<span class="token punctuation">;</span> <span class="token comment">// 入口文件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 工作路径</span>
  <span class="token punctuation">}</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行 并且创建模块的依赖关系,true代表主模块</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModlue</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'=======3'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span>
    <span class="token comment">// 发射一个文件(打包后的文件)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">getSource</span><span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> content
  <span class="token punctuation">}</span>
  <span class="token comment">// 解析源码</span>
  <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> parentPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// AST解析语法树</span>
    <span class="token comment">// console.log(source,'==================&gt;',parentPath)</span>
    <span class="token keyword">let</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    <span class="token keyword">let</span> dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//依赖的数组</span>
    <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> node <span class="token operator">=</span> p<span class="token punctuation">.</span>node<span class="token punctuation">;</span> <span class="token comment">//对应的节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'require'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'__webpack_require_'</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> moduleName <span class="token operator">=</span> node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 取到的就是模块的引用名字</span>
          moduleName <span class="token operator">=</span> moduleName <span class="token operator">+</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> <span class="token string">'.js'</span><span class="token punctuation">)</span>
          moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span>
          dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span>
          node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code

    <span class="token comment">// 附模块的加载 递归加载</span>
    dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">dep</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModlue</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      sourceCode<span class="token punctuation">,</span>
      dependencies
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 构建模块</span>
  <span class="token function">buildModlue</span><span class="token punctuation">(</span><span class="token parameter">modulePath<span class="token punctuation">,</span> isEntry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拿到模块的内容</span>
    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
    <span class="token comment">// 模块id modulePath = modulePath = this.root  </span>
    <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> moduleName<span class="token punctuation">;</span> <span class="token comment">//保存入口的名字</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     *  解析源码 对其改造
     *  1、将所有的require引入的内容 路径更改为src下
     *  2、将require 名字更改
     *  3、返回一个依赖列表
     * */</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>
      sourceCode<span class="token punctuation">,</span>
      dependencies
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 把相对路径和模块中的内容 对应起来</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> sourceCode
  <span class="token punctuation">}</span>
  <span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用数据渲染  </span>
    <span class="token comment">// 拿到输出到那个目录下</span>
    <span class="token keyword">let</span> main <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">let</span> templateStr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'main.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>templateStr<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      entryId<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">,</span>
      modules<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// 资源中路径对应的代码</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token operator">=</span> code<span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>main<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler
</code></pre></div><ul><li>5、创建lib/main.ejs</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>
l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">&quot;&lt;%-entryId%&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span>
<span class="token operator">&lt;</span><span class="token operator">%</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> modules<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token string">&quot;&lt;%-key%&gt;&quot;</span><span class="token punctuation">:</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`&lt;%-modules[key]%&gt;`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">&lt;</span><span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>6、做好的项目 通过 npm link 执行他 把当前的项目映射全局</li> <li>7、在别需要打包的项目的引入 npm link webpackSg   执行npx webpackSg,他对应webpackSg package.json 的 bin配置的key 执行value路径里面的内容</li></ul> <h3 id="_8、增加loader解析功能"><a href="#_8、增加loader解析功能" aria-hidden="true" class="header-anchor">#</a> 8、增加loader解析功能</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 修改 getSource </span>
 <span class="token function">getSource</span><span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> rules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules
  <span class="token keyword">let</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rules<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> rule <span class="token operator">=</span> rules<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>test<span class="token punctuation">,</span>use<span class="token punctuation">}</span> <span class="token operator">=</span> rule
    <span class="token keyword">let</span> loaderIndex <span class="token operator">=</span> use<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>modulePath <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        source <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>use<span class="token punctuation">[</span>loaderIndex<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>loaderIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> source
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_9、增加plugin解析功能"><a href="#_9、增加plugin解析功能" aria-hidden="true" class="header-anchor">#</a> 9、增加plugin解析功能</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 修改constructor  emitFile run</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> props
    <span class="token keyword">this</span><span class="token punctuation">.</span>entry <span class="token operator">=</span> props<span class="token punctuation">.</span>entry <span class="token comment">// 文件入口</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 文件路径</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
      entryOption<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      afterPlugins<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      run<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      compile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      afterCompile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      emit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compiler&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      afterEmit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      done<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> plugins <span class="token operator">=</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>plugins <span class="token operator">&amp;&amp;</span> plugins<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">plugin</span> <span class="token operator">=&gt;</span> <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterPlugins</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> main <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">let</span> ejsFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'main.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>ejsFile<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      entryId<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">,</span>
      modules<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token operator">=</span> code
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>main<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterEmit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行创建模块依赖关系 </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">moduleBuild</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterCompile</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发射文件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="vue-ssr流程"><a href="#vue-ssr流程" aria-hidden="true" class="header-anchor">#</a> vue-ssr流程</h2> <img src="/Study-history/img/ssr.png"> <ul><li>Source 里面继承了 client 和 serve,client就是我们平常用的spa,server 是后端用的,打包的时候 2个入口分别是client和server文件
<ul><li>需要注意的是new Vue的时候 不能挂载dom 他是在client(mount) 和 server(在html模板加入特定的字符串) 分别处理，server 引入的模板没有挂载的地方,可以在app.vue 最外层div 配置挂载点</li> <li>client就是正常的vue使用打包入口</li> <li>server.js 会默认导出一个函数(1) 给nodeServer使用 该函数接收的参数是<code>render.renderToString</code>第一个配置的参数</li> <li>函数(1)最终返回一个 new Vue的实例,在这里要处理几类情况
<ul><li>第一是路由问题 当浏览器请求地址时候,nodeServer 会将请求的路径传递给此函数(1),在内部通过<code>router.push(context.url)</code>定位到当前页面,路由提供了一個方法<code>router.onReady</code>,也就是说等待组件加载完成。在返回Vue实例</li> <li>第二个是store问题,还有一个路由方法<code>router.getMatchedComponents</code>获取匹配的当前组件,返回的是一个数组,如果<code>store</code>里面的数据发生变化就得通过server端处理传递,前面有个方法获取所有的组件,我们可以通过调取组件内的方法将<code>store</code>传递进去,如果通过client端传递 刷新页面 数据就还原了。<code>context.state = store.state</code>把vuex中的状态 挂载 到上下文中的state上,会自动在window上挂载一个属性 <strong>INITIAL_STATE</strong>,这样首页渲染的时候 就能直接获取当前的值。</li> <li>meta 信息修改,<code>cnpm i vue-meta -S</code> <ul><li>ssr html模板页面 titile 内配置 用3个<code>{}</code>包括 起来 <code>meta.inject().title.text()</code></li> <li><code>vue-meta</code>配置到中间件中<code>Vue.use(VueMeta)</code>  Vue的实例就有$meta() 方法 ,将他挂载上server.js 上下文中<code>context.meta = vm.$meta()</code></li> <li>使用 在App.vue 入口文件配置 将会涉及到每个页面 <code>metaInfo:{title:'xxxxxxxx'}</code>, 在单独的页面配置 就能覆盖</li></ul></li></ul></li></ul></li> <li>nodeServer 服务需要2个文件
<ul><li>第一个是html模板(里面要引入打包的 client.js)
<ul><li>client.js作用是页面的vue交互</li></ul></li> <li>第二个 server 打包的js
<ul><li>server作用是首屏渲染(刷新的加载时候返回所有的页面数据)</li></ul></li></ul></li></ul> <h2 id="配置一个webpack-vue-支持ssr"><a href="#配置一个webpack-vue-支持ssr" aria-hidden="true" class="header-anchor">#</a> 配置一个webpack-vue 支持ssr</h2> <ul><li><p>创建webpack/webpack.config.js</p></li> <li><p>创建webpack/webpack.client.js</p></li> <li><p>创建webpack/webpack.server.js</p></li> <li><p>创建文件vue相关的文件</p></li> <li><p>安装相关依赖</p> <ul><li>yarn add webpack webpack-cli webpack-dev-server</li> <li>vue-loader vue vue-style-loader css-loader html-webpack-plugin vue-template-compiler webpack-merge</li> <li>@babel/core @babel/preset-env babel-loader</li></ul></li> <li><p>构建版本问题(具体看官网)</p> <ul><li>完整版本 包含编译器和运行时的版本,</li> <li>编译器 用来将模板字符串编译成js渲染函数,也就是我们通常再在main.js 中的 new Vue 的时候 写的template.</li> <li>运行时版本 用来创建Vue实例,渲染并处理虚拟dom等代码,基本上就时除去编译器的其他一切,我们通常用的脚手架就是运行时版本,如果在cli中的main.js new Vue 的时候写template就会报错,因为缺少编译器,处理template.运行版本比完整版体积要小大约30%.</li> <li>处理办法,安装的时候默认是引入运行版本,配置webpack将他修改成完整版本即可,</li></ul></li> <li><p>css 要注意两点 默认情况支持scoped,如果要用css module 需要给css-loader配置</p></li> <li><p>ssr 流程</p> <ul><li>打包文件包括(client.js 和 server.js) 前者在html页面中引入 后者用来后端服务做渲染</li> <li>服务端渲染的时候 在html 配置  同时在App.vue 文件手动添加id='app'</li></ul></li> <li><p>创建一个简单的ssr</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> Vue<span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// vue提供的服务端渲染的包</span>
<span class="token keyword">let</span> VueServerRenderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token punctuation">:</span><span class="token string">'&lt;div&gt;heelo w11orld&lt;/div&gt;'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建渲染函数</span>
<span class="token keyword">let</span> render <span class="token operator">=</span> VueServerRenderer<span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  render<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>html</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>resolve<span class="token punctuation">:</span><span class="token punctuation">{</span>
  alias<span class="token punctuation">:</span><span class="token punctuation">{</span>
    <span class="token string">&quot;vue&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;vue/dist/vue.esm.js&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建webpack相关的文件"><a href="#创建webpack相关的文件" aria-hidden="true" class="header-anchor">#</a> 创建webpack相关的文件</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建webpack/webpack.config.js</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token comment">// vue 模块需要用插件处理</span>
<span class="token keyword">let</span> VueLoaderPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-loader/lib/plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">'[name].[hash].js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
        options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          presets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'vue-style-loader'</span><span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      test<span class="token punctuation">:</span> <span class="token regex">/\.vue$/</span><span class="token punctuation">,</span>
      use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'vue-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    alias<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 不加这个会 编译报错</span>
      <span class="token string">'vue'</span><span class="token punctuation">:</span> <span class="token string">'vue/dist/vue.esm.js'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack/webpack.client.js</span>
<span class="token keyword">let</span> htmlPluginWebpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>
  smart
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">smart</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/client.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">htmlPluginWebpack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack/webpack.server.js</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> htmlPluginWebpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>
  smart
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">smart</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">:</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token comment">//打包除的结果给node用</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span><span class="token punctuation">{</span>
    server<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'../nodeServer.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span><span class="token punctuation">{</span>
    libraryTarget<span class="token punctuation">:</span><span class="token string">'commonjs2'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">htmlPluginWebpack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      filename<span class="token punctuation">:</span> <span class="token string">'server.html'</span><span class="token punctuation">,</span>
      excludeChunks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'server'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>支持vue</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- src/index.html --&gt;</span>
  <span class="token doctype">&lt;!DOCTYPE html&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>支持vue.srr
<ul><li>在上面文件进行处理</li></ul></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- server.html --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--vue-ssr-outlet--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./client.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="components-bar-vue"><a href="#components-bar-vue" aria-hidden="true" class="header-anchor">#</a> /components/Bar.vue</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>example-1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">v-on:</span>click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>show = !show<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        Toggle=&gt;{{$store.state.username}}
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
      <span class="token function">asyncData</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 异步数据 这个方法只在服务端执行,客户端会执行</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'asyncData1'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'setUsername'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'setUsername'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">{</span>
        show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span><span class="token punctuation">{</span>
      <span class="token function">btn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="components-foo-vue"><a href="#components-foo-vue" aria-hidden="true" class="header-anchor">#</a> /components/Foo.vue</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list-demo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>demo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      foo
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    metaInfo<span class="token punctuation">:</span><span class="token punctuation">{</span>
      title<span class="token punctuation">:</span><span class="token string">'Footitle'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">{</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="app-js"><a href="#app-js" aria-hidden="true" class="header-anchor">#</a> App.js</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>app<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
      123123
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/bar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>bar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>foo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Bar <span class="token keyword">from</span> <span class="token string">'./components/Bar.vue'</span>
<span class="token keyword">import</span> Foo <span class="token keyword">from</span> <span class="token string">'./components/Foo.vue'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  metaInfo<span class="token punctuation">:</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span><span class="token string">'xxxxxxxx'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  components<span class="token punctuation">:</span><span class="token punctuation">{</span>
    Bar<span class="token punctuation">,</span>Foo
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="router-js"><a href="#router-js" aria-hidden="true" class="header-anchor">#</a> router.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token keyword">import</span> VueMeta <span class="token keyword">from</span> <span class="token string">'vue-meta'</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueMeta<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 会在当前的实例上添加一个 this.$meta</span>
<span class="token keyword">import</span> Bar <span class="token keyword">from</span> <span class="token string">'./components/Bar.vue'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    mode<span class="token punctuation">:</span><span class="token string">'history'</span><span class="token punctuation">,</span>
    routes<span class="token punctuation">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span><span class="token string">'/'</span><span class="token punctuation">,</span>
        component<span class="token punctuation">:</span>Bar
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span><span class="token string">'/bar'</span><span class="token punctuation">,</span>
        component<span class="token punctuation">:</span>Bar
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span><span class="token string">'/foo'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./components/Foo.vue'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> router
<span class="token punctuation">}</span>
</code></pre></div><h3 id="store-js"><a href="#store-js" aria-hidden="true" class="header-anchor">#</a> store.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>


Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    state<span class="token punctuation">:</span><span class="token punctuation">{</span>
      username<span class="token punctuation">:</span><span class="token string">'sg'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    mutations<span class="token punctuation">:</span><span class="token punctuation">{</span>
      <span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mutations'</span><span class="token punctuation">)</span>
            state<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">'xxxx'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    actions<span class="token punctuation">:</span><span class="token punctuation">{</span>
      <span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'actions'</span><span class="token punctuation">)</span>
            <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'setUsername'</span><span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span><span class="token punctuation">{</span>
    store<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> store
<span class="token punctuation">}</span>
</code></pre></div><h3 id="main-js"><a href="#main-js" aria-hidden="true" class="header-anchor">#</a> main.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> createRouter <span class="token keyword">from</span> <span class="token string">'./router'</span>
<span class="token keyword">import</span> createStore <span class="token keyword">from</span> <span class="token string">'./store'</span>
<span class="token comment">// 为了兼容服务端 要把这个方法改造成函数</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// el:&quot;#app&quot;,//手动挂载</span>
    <span class="token function-variable function">render</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
    router<span class="token punctuation">,</span>
    store
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">,</span>
    router<span class="token punctuation">,</span>
    store
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="client-js"><a href="#client-js" aria-hidden="true" class="header-anchor">#</a> client.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> creareApp <span class="token keyword">from</span> <span class="token string">'./main'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>vm<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">creareApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="server-js"><a href="#server-js" aria-hidden="true" class="header-anchor">#</a> server.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> creareApp <span class="token keyword">from</span> <span class="token string">'./main'</span><span class="token punctuation">;</span>

<span class="token comment">// 服务端会调用此函数 产生新的app实例</span>
<span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 在服务端跑的</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>vm<span class="token punctuation">,</span>router<span class="token punctuation">,</span>store<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">creareApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// let meta = vm.$meta  // 注意这个地方不能解构  保证this指向 </span>
    <span class="token comment">// 如果服务端 启动时 直接访问 /foo 返回的页面永远都是 index.html 需要通过路由跳转到指定路径</span>
    <span class="token comment">// 防止路由中的异步逻辑 服务端专有的方法</span>
    
    <span class="token comment">// 需要把当前页面中匹配到的组件 找到asyncData方法让他执行</span>
    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token comment">// 等待路由执行完成的回调</span>
    router<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// 获取当前路径匹配到的组件 看一下 这个组件中 有没有asyncData方法</span>
      <span class="token keyword">let</span> matchesComponents <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">getMatchedComponents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
        Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
            matchesComponents<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">component</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>asyncData<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> component<span class="token punctuation">.</span><span class="token function">asyncData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          <span class="token comment">// 把vuex中的状态 挂载 到上下文中的state上</span>
          context<span class="token punctuation">.</span>state <span class="token operator">=</span> store<span class="token punctuation">.</span>state
          context<span class="token punctuation">.</span>meta <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">$meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">// 会自动在window上挂载一个属性 __INITIAL_STATE__</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="node-server-js"><a href="#node-server-js" aria-hidden="true" class="header-anchor">#</a> node-server.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> Vue<span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> serverBundle <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./dist/server.bundle.js'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
<span class="token comment">// vue提供的服务端渲染的包</span>
<span class="token keyword">let</span> VueServerRenderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./dist/index.ssr.html'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
<span class="token comment">// // 创建渲染函数</span>
<span class="token keyword">let</span> render <span class="token operator">=</span> VueServerRenderer<span class="token punctuation">.</span><span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>serverBundle<span class="token punctuation">,</span><span class="token punctuation">{</span>
  template
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 把渲染好的字符串丢给客户端,返回的只是字符串,没有vue实例功能</span>
  <span class="token comment">// 第一个参数 对应了server.js入口文件 函数接收的参数</span>
  <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>url<span class="token punctuation">:</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span>
  render<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>html</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 如果访问的路径不存在 默认渲染到index.ssr.html 并且把路由定向到请求的路径</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 把渲染好的字符串丢给客户端,返回的只是字符串,没有vue实例功能</span>
  <span class="token comment">// 第一个参数 对应了server.js入口文件 函数接收的参数</span>
  <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>url<span class="token punctuation">:</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span>
  render<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>html</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/7/2022, 8:03:51 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Study-history/front/phone.html" class="prev">
          移动端
        </a></span> <span class="next"><a href="/Study-history/front/video.html">
          视频
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/Study-history/assets/js/app.a1ad6491.js" defer></script><script src="/Study-history/assets/js/41.5507fc07.js" defer></script>
  </body>
</html>
